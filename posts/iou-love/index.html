<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>For Those About to LAB...⚡</title><meta name=author content=" ">
<meta name=description content="Showcase how to use Cisco IOL in your containerlabs using netlab to orchestrate the provisioning of the infra and Kentik for the traffic visibility and monitoring use cases."><meta name=keywords content='netsim,netlab,containerlab,automation'><meta itemprop=name content="For those about to LAB...⚡"><meta itemprop=description content="Showcase how to use Cisco IOL in your containerlabs using netlab to orchestrate the provisioning of the infra and Kentik for the traffic visibility and monitoring use cases."><meta itemprop=datePublished content="2024-11-05T00:00:00+00:00"><meta itemprop=dateModified content="2024-12-08T00:00:00+00:00"><meta itemprop=wordCount content="10536"><meta itemprop=image content="https://net4fungr.github.io/images/pyrtr_small.png"><meta itemprop=keywords content="Netsim,Netlab,Containerlab,Automation"><meta property="og:url" content="https://net4fungr.github.io/posts/iou-love/"><meta property="og:site_name" content="Becos :: Back Blog"><meta property="og:title" content="For those about to LAB...⚡"><meta property="og:description" content="Showcase how to use Cisco IOL in your containerlabs using netlab to orchestrate the provisioning of the infra and Kentik for the traffic visibility and monitoring use cases."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-05T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-08T00:00:00+00:00"><meta property="article:tag" content="Netsim"><meta property="article:tag" content="Netlab"><meta property="article:tag" content="Containerlab"><meta property="article:tag" content="Automation"><meta property="og:image" content="https://net4fungr.github.io/images/pyrtr_small.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://net4fungr.github.io/images/pyrtr_small.png"><meta name=twitter:title content="For those about to LAB...⚡"><meta name=twitter:description content="Showcase how to use Cisco IOL in your containerlabs using netlab to orchestrate the provisioning of the infra and Kentik for the traffic visibility and monitoring use cases."><meta name=twitter:site content="@mkaliotis"><meta name=twitter:creator content="@mkaliotis"><meta name=application-name content="Becos :: Back Blog"><meta name=apple-mobile-web-app-title content="Becos :: Back Blog"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel=canonical type=text/html href=https://net4fungr.github.io/posts/iou-love/ title="For those about to LAB...⚡ - Becos :: Back Blog"><link rel=prev type=text/html href=https://net4fungr.github.io/posts/modern-nms/ title="If this ain't a modern NMS, then what is?"><link rel=alternate type=text/markdown href=https://net4fungr.github.io/posts/iou-love/index.md title="For those about to LAB...⚡ - Becos :: Back Blog"><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><meta name=google-site-verification content="m_enMQYWx1a1cSKPfRT_00wHfqT8ir4PZSBPyeaIH-o"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"For those about to LAB...⚡","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/net4fungr.github.io\/posts\/iou-love\/"},"genre":"posts","keywords":"netsim, netlab, containerlab, automation","wordcount":10536,"url":"https:\/\/net4fungr.github.io\/posts\/iou-love\/","datePublished":"2024-11-05T00:00:00+00:00","dateModified":"2024-12-08T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":" "},"description":""}</script><script src=/js/head/color-scheme.min.js></script></head><body data-header-desktop=sticky data-header-mobile=auto><div class=wrapper data-page-style=narrow><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=right><div class=header-title><a href=/ title="Becos :: Back Blog"><img class=logo src=/images/pyrtr_small.png alt="Becos :: Back Blog" height=32 width=32><span class=header-title-pre><</span><span class=header-title-text>...ssh and blog...</span><span class=header-title-post>/></span></a><span class="typeit header-subtitle"><template>revamped!</template></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/categories/ title="Posts Organised by Category"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> Categories</a></li><li class=menu-item><a class=menu-link href=/collections/ title="Multipart Posts"><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> Collections</a></li><li class=menu-item><a class=menu-link href=/archives/ title="All My Posts"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> Archives</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> Tags</a></li><li class=menu-item><a class=menu-link href=https://becos76.github.io title="About Me" rel="noopener noreferrer" target=_blank><i class="fa-solid fa-signature fa-fw fa-sm" aria-hidden=true></i> About</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder="Search titles or contents ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Becos :: Back Blog"><img class=logo src=/images/pyrtr_small.png alt="Becos :: Back Blog" height=26 width=26><span class=header-title-pre><</span><span class=header-title-text>...ssh and blog...</span><span class=header-title-post>/></span></a><span class="typeit header-subtitle"><template>revamped!</template></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></li><li class=menu-item><a class=menu-link href=/categories/ title="Posts Organised by Category"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> Categories</a></li><li class=menu-item><a class=menu-link href=/collections/ title="Multipart Posts"><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> Collections</a></li><li class=menu-item><a class=menu-link href=/archives/ title="All My Posts"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> Archives</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> Tags</a></li><li class=menu-item><a class=menu-link href=https://becos76.github.io title="About Me" rel="noopener noreferrer" target=_blank><i class="fa-solid fa-signature fa-fw fa-sm" aria-hidden=true></i> About</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=Collections><div class="details related-details open"><div class="details-summary related-summary"><i class="fa-solid fa-fire fa-fade text-danger fa-fw" aria-hidden=true></i>
<span class=related-title>Related Content</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class="details-content related-content"><ul class=related-list><li class=related-item><a href=/posts/modern-nms/ title="If This Ain't a Modern NMS, Then What Is?">If This Ain't a Modern NMS, Then What Is?</a></li><li class=related-item><a href=/posts/kustom-metrics/ title="K~ustom Metrics in Kentik NMS">K~ustom Metrics in Kentik NMS</a></li><li class=related-item><a href=/posts/kube-my-router-pt3/ title="Kube My Router Up! - Last Part">Kube My Router Up! - Last Part</a></li><li class=related-item><a href=/posts/k8s-ansible/ title="K8s Ansible">K8s Ansible</a></li><li class=related-item><a href=/posts/kube-my-router-pt2/ title="Kube My Router Up! - Part Two">Kube My Router Up! - Part Two</a></li></ul></div></div></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>For Those About to LAB...⚡</span></h1><p class="single-subtitle animate__animated animate__fadeIn">Rebirth of the phoenix</p></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i>
</span></span><span class=post-included-in>&nbsp;included in <a href=/categories/art-of-labbing/ class=post-category title="Category - Art of Labbing"><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> Art of Labbing</a></span></div><div class=post-meta-line><span title="published on 2024-11-05 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2024-11-05>2024-11-05</time></span>&nbsp;<span title="Updated on 2024-12-08 00:00:00"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden=true></i><time datetime=2024-12-08>2024-12-08</time></span>&nbsp;<span title="10536 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>About 10600 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>50 minutes</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#intro>Intro</a></li><li><a href=#use-case-brief>Use Case Brief</a><ul><li><a href=#why-containerlab>Why containerlab?</a></li><li><a href=#why-netlab>Why netlab?</a></li><li><a href=#why-iol>Why IOL?</a></li><li><a href=#things-covered>Things Covered</a></li><li><a href=#topology-walk-through>Topology Walk-through</a></li></ul></li><li><a href=#setting-things-up>Setting Things Up</a><ul><li><a href=#building-the-iol-containers>Building the IOL containers</a></li><li><a href=#installing-netlab-in-wsl>Installing Netlab in WSL</a></li></ul></li><li><a href=#topology-definition>Topology Definition</a><ul><li><a href=#building-the-base-topology---step-by-step>Building the Base Topology - Step-by-step</a></li><li><a href=#base-topology---complete>Base Topology - Complete</a></li><li><a href=#service-containers>Service Containers</a></li></ul></li><li><a href=#topology-bring-up-workflow>Topology Bring-Up Workflow</a><ul><li><a href=#1-register-nms-agent>1. Register NMS Agent</a></li><li><a href=#2-register-devices-in-the-portal>2. Register Devices in the Portal</a></li><li><a href=#3-bring-up-the-lab>3. Bring Up the LAB</a></li><li><a href=#4-enable-netflow>4. Enable Netflow</a></li><li><a href=#5-enable-traffic>5. Enable Traffic</a></li><li><a href=#6-register-synthetics-agents>6. Register Synthetics Agents</a></li></ul></li><li><a href=#outro>Outro</a></li><li><a href=#influences-and-reference>Influences and Reference</a></li></ul></nav></div></div><div class=content id=content><hr><h2 class=heading-element id=intro><span>Intro</span>
<a href=#intro class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>Cisco IOL, aka IOU, and I go back a long way. Back in the day, when I decided to sit for the CCIE R&amp;S v4 exam, there weren&rsquo;t many options to get hands on on the cli other than having access to real devices or using dynamips and GNS3 for simulating routers and switches, but with limited feature support, especially on the S side.</p><p>Hence, since I have also been known as a big time pack rat, I decided to go for a real LAB. So, after spending nearly over $6k, I managed to build a real home lab with all the quirks. Terminal server, AUI converters , x-over and serial cables, remote managed PSUs, I remember being so happy!</p><p>The joy went on for a couple of months, while I was setting up the scenarios, practicing the theory, re-configuring and starting over. Then one day, as I was googling for something, I bumped to some news that Cisco IOS-on-Unix has been leaked to the public and people were already using it to build virtual labs. Then an IOS-on-Linux version was also leaked and you can imagine how stupid I felt after this.</p><p>I, of course, ended up in using it and even got a refurb SPARCstation to run IOU in the interim before I could get my hands on a <em>stable</em> IOL version without major issues. Anyway, this was just to give you the context of my history with IOL. I never sat for the lab in the end, but that&rsquo;s another story.</p><p>So, imagine my excitement when the recent news of IOL support in <a href=https://containerlab.dev/rn/0.58/#cisco-iol target=_blank rel="external nofollow noopener noreferrer">containerlab</a> and <a href=https://netlab.tools/release/1.9/#release-1-9-2 target=_blank rel="external nofollow noopener noreferrer">netlab</a> reached my eyes. It brought back so many reminisces, that I had to write something about it. Containerlab and netlab have always been in my back-blog, and I wanted to post about them, but I feel that the community is doing such a great job on them, whilst in this case I felt that the time is right for me as well.</p><p>As a bottom line here, IOL has always been the preferred choice due to its low demand on resources for the supported and relevant use cases, and the fact that it can now be supported in containerised topologies increases its network automation friendliness (NAFness :)) level, not too much though, since it is lacking some features as we will see later on.</p><h2 class=heading-element id=use-case-brief><span>Use Case Brief</span>
<a href=#use-case-brief class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>Everything starts with a use case, the intent! In my case, I want to spin up topologies and test different things in Kentik. The idea came from the <a href=https://github.com/srl-labs/srl-telemetry-lab target=_blank rel="external nofollow noopener noreferrer">srl-telemetry-lab</a>, so we will be following the same approach but for Kentik related use cases. Hence,</p><ul><li>Dynamic topology that is sending netflow to Kentik via the kproxy agent</li><li>Traffic simulation using iperf3 on the devices</li><li>Kentik Synthetic agents attached to the topology performing tests</li><li>Devices registered in Kentik NMS for monitoring</li></ul><h3 class=heading-element id=why-containerlab><span>Why containerlab?</span>
<a href=#why-containerlab class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><ul><li>Dynamic topology: support CRUDs on the infrastructure</li><li>IaC model support: everything defined in structured format</li><li>Integrates well with netlab as a provider</li><li>Minimal effort on the above / more focus on the use cases</li></ul><h3 class=heading-element id=why-netlab><span>Why netlab?</span>
<a href=#why-netlab class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><ul><li>Automatic provisioning of underlay connectivity details and protocols</li><li>Flexibility in adding custom templates and using custom playbooks based on a common ansible inventory file</li><li>Good integration with containerlab</li><li>Minimal effort on the above / more focus on the use cases</li></ul><p>I think netlab is the perfect example of <em>Automating the Boring Stuff</em>. I never counted the times or will ever forget that I had to type those commands &#x1f604; :<div class="details admonition quote open"><div class="details-summary admonition-title"><i class="icon fa-fw fa-solid fa-quote-right" aria-hidden=true></i>Boring Stuff<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>conf t ⏎ no ip do lo ⏎ line con 0 ⏎ logg syn ⏎ exec-t 0 ⏎ ^Z wr ⏎</div></div></div></p><h3 class=heading-element id=why-iol><span>Why IOL?</span>
<a href=#why-iol class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><ul><li>Demand on resources is very low</li><li>Fit my use case since netflow export is supported</li><li>No licensing limits on traffic volumes</li><li>Seems IOL reports interface errors when traffic is pushed. A bug or a feature, don&rsquo;t care at the moment since it has always been a burden to fire up synthetic errors on interface counters.</li></ul><h3 class=heading-element id=things-covered><span>Things Covered</span>
<a href=#things-covered class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>Now that we have picked up the correct tools for the job, let&rsquo;s see what we are going to cover so you can assess if this is still interesting enough to carry on reading.</p><ul><li>Using <em>netlab</em> to provision a lab by using <em>containerlab</em> for spinning up the nodes</li><li>Using IOL for the network device type</li><li>Using various containers to integrate with the topology as the linux device type</li><li>Using <em>iperf3</em> for generating traffic load on the topology</li><li>Using OSPF, BGP, MPLS and VRF modules in <em>netlab</em></li><li>Using jinja templates to provision additional commands to the nodes either ad-hoc or during lab bring-up.</li><li>Defining custom variables in the topology so we can use them later on either in the templates or in <em>ansible</em> plays.</li><li>We will be using <em>Windows Subsystem for Linux</em> (WSL) for this use case.</li></ul><p>So by using all the above we can deploy a topology like the one depicted in the following section, register the devices in Kentik, produce traffic and explore how to visualise, monitor, and run synthetic tests on it via Kentik. And all this by using automated tasks on the way.</p><h3 class=heading-element id=topology-walk-through><span>Topology Walk-through</span>
<a href=#topology-walk-through class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><figure><a class=lightgallery href=/posts/iou-love/topology.png title=/posts/iou-love/topology.png data-thumbnail=/posts/iou-love/topology.png data-sub-html="<h2>LAB Topology</h2>"><img loading=lazy src=/posts/iou-love/topology.png alt=/posts/iou-love/topology.png height=722 width=1213></a><figcaption class=image-caption>LAB Topology</figcaption></figure><p>As you see, the topology is rather simple. We have four core devices (rcX) running an MPLS-LDP backbone and offering L3VPN services over MP-BGP to four CE devices (ceX). The PC nodes are used to generate traffic and the <em>ksynth</em> nodes are Kentik private synthetics agents. As you may have guessed, we have two VPNs, <strong style=color:red><em>red</em></strong> and <strong style=color:blue><em>blue</em></strong>.</p><p>Network devices are IOL containers and PC&rsquo;s are based on the <a href=https://github.com/srl-labs/network-multitool/pkgs/container/network-multitool target=_blank rel="external nofollow noopener noreferrer">network-multitool</a> container image. Of course, we also have additional containers running and I like to call them service containers, since they are there to interact with the topology and report data back to Kentik, realising our use case.</p><p>The basic idea behind connectivity in <em>netlab/containerlab</em> is that there is a <em>management</em> docker bridge network that all nodes connect. Each node connects to the management network, usually by its first interface, and <em>netlab</em> uses this to provision commands to it. All other node links are formed based on the desired configuration by bridging the relevant node interfaces.</p><p>Hence, the service containers, do not have to connect in-line to the topology and all communications go via the management network. But, let&rsquo;s see them one by one:</p><ul><li><strong>kproxy</strong>: Kentik agent that listens to netflow from the devices and reports to Kentik. This agent also polls devices for SNMP metrics and metadata. All communications are going via the management network, from/to the devices in the isolated management VRF. In addition, since this is a container attached to a docker network inside the host machine, it has access to the Internet by default, so it is able to go out to Kentik and report the data.</li><li><strong>kbgp</strong>: Kentik agent that tunnels bgp sessions from the devices all the way up to Kentik. This agent actually needs an inline connection so all other nodes can form the session. In our case, it is connected to <strong>rc1</strong> so all others can reach it. Communication with Kentik is done via the container&rsquo;s first interface that belongs to the management network, the same way as <strong>kproxy</strong> does.</li><li><strong>kagent</strong>: Kentik&rsquo;s Universal Agent that is part of the Kentik NMS product and is polling the devices for SNMP data and reporting it into the NMS part. Here, I have chosen to deploy this as a standard container on the host machine (WSL) and it is not included in the topology. Thus, <em>netlab</em> is not aware of it at all, but still <strong>kagent</strong> can communicate with the devices via the management network since they are part of the same host, just in a different docker bridge network. So communication is possible since this agent is only polling the devices via their management interfaces and there is no need to expose anything (or should I say ingress path) from its side.</li></ul><p>We will expand more on the connectivity details as we build the topology further on, but for now, the three basic things to ask yourself regarding how to run your service containers are:</p><ul><li>Do they need to be <em>controlled</em> somehow via <em>netlab</em>?</li><li>Does <em>netlab</em> need to know any detail about them?</li><li>Are your devices capable to communicate with them via their management VRF for their purpose?</li></ul><h2 class=heading-element id=setting-things-up><span>Setting Things Up</span>
<a href=#setting-things-up class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>In this section we are going to focus on how to set things up in WSL. We will start by building the IOL containers for our use case and then see a typical installation of <em>netlab</em>.</p><h3 class=heading-element id=building-the-iol-containers><span>Building the IOL containers</span>
<a href=#building-the-iol-containers class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>IOL containers are supported in <em>containerlab</em> via their <a href=https://containerlab.dev/manual/vrnetlab/#vrnetlab target=_blank rel="external nofollow noopener noreferrer"><em>vrnetlab</em></a> fork. The current IOL <a href=https://developer.cisco.com/docs/modeling-labs/iol/ target=_blank rel="external nofollow noopener noreferrer">images</a> are those included with the Cisco CML image reference collection (refplat), so you have to get hold of them and copy them to the relevant build directory in <em>vrnetlab</em> in order to build them. Here are the steps:</p><p><strong>>>></strong> Clone the repo:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· git clone https://github.com/hellt/vrnetlab
</span></span><span class=line><span class=cl>Cloning into <span class=s1>&#39;vrnetlab&#39;</span>...
</span></span><span class=line><span class=cl>remote: Enumerating objects: 5363, <span class=k>done</span>.
</span></span><span class=line><span class=cl>remote: Counting objects: 100% <span class=o>(</span>2011/2011<span class=o>)</span>, <span class=k>done</span>.
</span></span><span class=line><span class=cl>remote: Compressing objects: 100% <span class=o>(</span>660/660<span class=o>)</span>, <span class=k>done</span>.
</span></span><span class=line><span class=cl>remote: Total <span class=m>5363</span> <span class=o>(</span>delta 1542<span class=o>)</span>, reused <span class=m>1649</span> <span class=o>(</span>delta 1348<span class=o>)</span>, pack-reused <span class=m>3352</span> <span class=o>(</span>from 1<span class=o>)</span>
</span></span><span class=line><span class=cl>Receiving objects: 100% <span class=o>(</span>5363/5363<span class=o>)</span>, 2.27 MiB <span class=p>|</span> 664.00 KiB/s, <span class=k>done</span>.
</span></span><span class=line><span class=cl>Resolving deltas: 100% <span class=o>(</span>3245/3245<span class=o>)</span>, <span class=k>done</span>.</span></span></code></pre></div><p><strong>>>></strong> Copy the images to the appropriate folder and rename them according to the README. I chose to make links to them instead:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· <span class=nb>cd</span> vrnetlab/cisco/iol/
</span></span><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· lll
</span></span><span class=line><span class=cl>total <span class=m>516920</span>
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span>       <span class=m>289</span>  Makefile
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span>      <span class=m>1721</span>  README.md
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span>        <span class=m>35</span>  cisco_iol-17.12.1.bin -&gt; x86_64_crb_linux-adventerprisek9-ms
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span>        <span class=m>38</span>  cisco_iol-L2-17.12.1.bin -&gt; x86_64_crb_linux_l2-adventerprisek9-ms
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span>      <span class=m>4096</span>  docker
</span></span><span class=line><span class=cl>-rwxr-xr-x <span class=m>1</span> <span class=m>288947184</span>  x86_64_crb_linux-adventerprisek9-ms
</span></span><span class=line><span class=cl>-rwxr-xr-x <span class=m>1</span> <span class=m>240355720</span>  x86_64_crb_linux_l2-adventerprisek9-ms</span></span></code></pre></div><p><strong>>>></strong> Build with <code>make docker-image</code> and check in docker. You should end up having the two IOL images in the registry. One for the <em>router</em> and one for the <em>switch</em>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· make docker-image
</span></span><span class=line><span class=cl>&lt; build output &gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· docker images vrnetlab/cisco_iol*
</span></span><span class=line><span class=cl>REPOSITORY           TAG          IMAGE ID       CREATED              SIZE
</span></span><span class=line><span class=cl>vrnetlab/cisco_iol   L2-17.12.1   15d363218573   About a minute ago   607MB
</span></span><span class=line><span class=cl>vrnetlab/cisco_iol   17.12.1      1d44f7fa6252   About a minute ago   704MB</span></span></code></pre></div><p><strong>>>></strong> You can test with the following command to see if they are <em>booting</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· docker run -it --rm -e <span class=nv>IOL_PID</span><span class=o>=</span><span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--mount <span class=nv>type</span><span class=o>=</span>bind,source<span class=o>=</span>/dev/null,target<span class=o>=</span>/iol/NETMAP vrnetlab/cisco_iol:17.12.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Launching IOL with PID <span class=m>1</span>
</span></span><span class=line><span class=cl>Failed to send flush request: Operation not permitted
</span></span><span class=line><span class=cl>Flushed eth0 addresses
</span></span><span class=line><span class=cl>/entrypoint.sh: line 14: /usr/bin/iouyap: Operation not permitted
</span></span><span class=line><span class=cl>/entrypoint.sh: line 14: /usr/bin/iouyap: Success
</span></span><span class=line><span class=cl>IOS On Unix - Cisco Systems confidential, internal use only
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> IOURC: Could not open iourc file
</span></span><span class=line><span class=cl>Warning: configuration file <span class=o>(</span>config.txt<span class=o>)</span> does not exist
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Warning: Abnormal ciscoversion string, please notify the IOU team
</span></span><span class=line><span class=cl>with the name of this branch
</span></span><span class=line><span class=cl>Warning: we parsed - NULL
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>              Restricted Rights Legend
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Use, duplication, or disclosure by the Government is
</span></span><span class=line><span class=cl>subject to restrictions as <span class=nb>set</span> forth in subparagraph
</span></span><span class=line><span class=cl><span class=o>(</span>c<span class=o>)</span> of the Commercial Computer Software - Restricted
</span></span><span class=line><span class=cl>Rights clause at FAR sec. 52.227-19 and subparagraph
</span></span><span class=line><span class=cl><span class=o>(</span>c<span class=o>)</span> <span class=o>(</span>1<span class=o>)</span> <span class=o>(</span>ii<span class=o>)</span> of the Rights in Technical Data and Computer
</span></span><span class=line><span class=cl>Software clause at DFARS sec. 252.227-7013.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>           Cisco Systems, Inc.
</span></span><span class=line><span class=cl>           <span class=m>170</span> West Tasman Drive
</span></span><span class=line><span class=cl>           San Jose, California 95134-1706
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Cisco IOS Software <span class=o>[</span>Dublin<span class=o>]</span>, Linux Software <span class=o>(</span>X86_64BI_LINUX-ADVENTERPRISEK9-M<span class=o>)</span>, Version 17.12.1, RELEASE SOFTWARE <span class=o>(</span>fc5<span class=o>)</span>
</span></span><span class=line><span class=cl>Technical Support: http://www.cisco.com/techsupport
</span></span><span class=line><span class=cl>Copyright <span class=o>(</span>c<span class=o>)</span> 1986-2023 by Cisco Systems, Inc.
</span></span><span class=line><span class=cl>Compiled Thu 27-Jul-23 22:33 by mcpre
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PM unix notify udp ports APP_ID:0 DISABLE Port1:0 Port2:0
</span></span><span class=line><span class=cl>PM unix notify udp ports APP_ID:1 DISABLE Port1:0 Port2:0Linux Unix <span class=o>(</span>i686<span class=o>)</span> processor with 550115K bytes of memory.
</span></span><span class=line><span class=cl>Processor board ID <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=m>4</span> Ethernet interfaces
</span></span><span class=line><span class=cl>1024K bytes of NVRAM.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>No startup-config, starting autoinstall/pnp/ztp...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Autoinstall will terminate <span class=k>if</span> any input is detected on console
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Autoinstall trying DHCPv4 on Ethernet0/0,Ethernet0/1,Ethernet0/2,Ethernet0/3
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt; snipped &gt;</span></span></code></pre></div><p>They are based on XE 17.12.1 release so they are more feature rich than the past IOL ones (IOS 15.x), they do <strong>not</strong> support any of the automation goodies as well as streaming telemetry, but they can push traffic without any licensing restriction.</p><h3 class=heading-element id=installing-netlab-in-wsl><span>Installing Netlab in WSL</span>
<a href=#installing-netlab-in-wsl class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>Now that we have our devices, let&rsquo;s go ahead and install <em>netlab</em> in WSL. I am using the following versions and linux flavour:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>·&gt;&gt; wsl.exe -v
</span></span><span class=line><span class=cl>WSL version: 2.3.26.0
</span></span><span class=line><span class=cl>Kernel version: 5.15.167.4-1
</span></span><span class=line><span class=cl>WSLg version: 1.0.65
</span></span><span class=line><span class=cl>MSRDC version: 1.2.5620
</span></span><span class=line><span class=cl>Direct3D version: 1.611.1-81528511
</span></span><span class=line><span class=cl>DXCore version: 10.0.26100.1-240331-1435.ge-release
</span></span><span class=line><span class=cl>Windows version: 10.0.19045.5131
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· cat /etc/os-release
</span></span><span class=line><span class=cl><span class=nv>PRETTY_NAME</span><span class=o>=</span><span class=s2>&#34;Ubuntu 22.04.5 LTS&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>NAME</span><span class=o>=</span><span class=s2>&#34;Ubuntu&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>VERSION_ID</span><span class=o>=</span><span class=s2>&#34;22.04&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>VERSION</span><span class=o>=</span><span class=s2>&#34;22.04.5 LTS (Jammy Jellyfish)&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>VERSION_CODENAME</span><span class=o>=</span>jammy
</span></span><span class=line><span class=cl><span class=nv>ID</span><span class=o>=</span>ubuntu
</span></span><span class=line><span class=cl><span class=nv>ID_LIKE</span><span class=o>=</span>debian
</span></span><span class=line><span class=cl><span class=nv>HOME_URL</span><span class=o>=</span><span class=s2>&#34;https://www.ubuntu.com/&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>SUPPORT_URL</span><span class=o>=</span><span class=s2>&#34;https://help.ubuntu.com/&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>BUG_REPORT_URL</span><span class=o>=</span><span class=s2>&#34;https://bugs.launchpad.net/ubuntu/&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PRIVACY_POLICY_URL</span><span class=o>=</span><span class=s2>&#34;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>UBUNTU_CODENAME</span><span class=o>=</span>jammy</span></span></code></pre></div><p><strong>>>></strong> I chose to install <em>netlab</em> in a virtual env:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· sudo apt install python-is-python3 python3-pip python3-venv
</span></span><span class=line><span class=cl>&lt; snipped &gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· mkdir -p netlab/iol
</span></span><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· <span class=nb>cd</span> netlab/iol
</span></span><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· python -m venv .venv
</span></span><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· <span class=nb>source</span> .venv/bin/activate</span></span></code></pre></div><p><strong>>>></strong> Install <em>netlab</em> via pip and then all dependencies:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· pip install networklab
</span></span><span class=line><span class=cl>&lt; snipped &gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· netlab install ubuntu ansible containerlab
</span></span><span class=line><span class=cl>&lt; snipped &gt;</span></span></code></pre></div><p><strong>>>></strong> Open another terminal to cause re-login and bring up the test topology to verify everything is set up correctly:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(wsl)&lt;&lt;· cd netlab/iol
</span></span><span class=line><span class=cl>(wsl)&lt;&lt;· source .venv/bin/activate
</span></span><span class=line><span class=cl>(wsl)&lt;&lt;· netlab test clab
</span></span><span class=line><span class=cl>&lt; snipped &gt;</span></span></code></pre></div><p><em>Netalab</em> will provision a 3 node topology based on <em>frr</em> and test if everything is working as expected. Finally it will cleanup after itself.</p><h2 class=heading-element id=topology-definition><span>Topology Definition</span>
<a href=#topology-definition class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>Let&rsquo;s now start the fun part by exploring how to define our LAB so <em>netlab</em> can spin it up and provision it the way we want it. <em>Netlab</em> expects us to define everything in a single topology definition file, by default <code>topology.yml</code>. We are going to build the base topology that includes just the routers and the PC&rsquo;s, and then move on with adding the service containers.</p><h3 class=heading-element id=building-the-base-topology---step-by-step><span>Building the Base Topology - Step-by-step</span>
<a href=#building-the-base-topology---step-by-step class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>The first thing to do in the topology file is to declare which virtualisation provider we are going to be using. For our case this is <code>clab</code> and here is how to check what others are supported along with their status in the current installation:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· netlab show providers
</span></span><span class=line><span class=cl>Supported virtualization providers
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┏━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━┓
</span></span><span class=line><span class=cl>┃ provider   ┃ description              ┃ status ┃
</span></span><span class=line><span class=cl>┡━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━┩
</span></span><span class=line><span class=cl>│ clab       │ containerlab with Docker │ OK     │
</span></span><span class=line><span class=cl>│ external   │ External devices         │ OK     │
</span></span><span class=line><span class=cl>│ libvirt    │ Vagrant with libvirt/KVM │ N/A    │
</span></span><span class=line><span class=cl>│ virtualbox │ Vagrant with Virtualbox  │ N/A    │
</span></span><span class=line><span class=cl>└────────────┴──────────────────────────┴────────┘</span></span></code></pre></div><p>The minimum sections that <em>netlab</em> expects to find in the topology file is the <code>provider</code>, the <code>nodes</code> and the <code>links</code>. And the minimum attributes that it needs to know about a node before provisioning it is the device type we want to use. Here are the supported device types:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· netlab show devices
</span></span><span class=line><span class=cl>Virtual network devices supported by netlab
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┏━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
</span></span><span class=line><span class=cl>┃ device        ┃ description                                   ┃
</span></span><span class=line><span class=cl>┡━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
</span></span><span class=line><span class=cl>│ arubacx       │ ArubaOS-CX                                    │
</span></span><span class=line><span class=cl>│ asav          │ Cisco ASAv                                    │
</span></span><span class=line><span class=cl>│ cat8000v      │ Cisco CSR 1000v                               │
</span></span><span class=line><span class=cl>│ csr           │ Cisco CSR 1000v                               │
</span></span><span class=line><span class=cl>│ cumulus       │ Cumulus VX 4.x or 5.x configured without NVUE │
</span></span><span class=line><span class=cl>│ cumulus_nvue  │ Cumulus VX 5.x configured with NVUE           │
</span></span><span class=line><span class=cl>│ dellos10      │ Dell OS10                                     │
</span></span><span class=line><span class=cl>│ eos           │ Arista vEOS VM or cEOS container              │
</span></span><span class=line><span class=cl>│ fortios       │ Fortinet FortiOS firewall                     │
</span></span><span class=line><span class=cl>│ frr           │ FRR container                                 │
</span></span><span class=line><span class=cl>│ iol           │ Cisco IOL                                     │
</span></span><span class=line><span class=cl>│ ioll2         │ IOSv L2 image                                 │
</span></span><span class=line><span class=cl>│ iosv          │ Cisco IOSv                                    │
</span></span><span class=line><span class=cl>│ iosvl2        │ IOSv L2 image                                 │
</span></span><span class=line><span class=cl>│ iosxr         │ Cisco IOS XRv                                 │
</span></span><span class=line><span class=cl>│ linux         │ Generic Linux host                            │
</span></span><span class=line><span class=cl>│ nxos          │ Cisco Nexus 9300v                             │
</span></span><span class=line><span class=cl>│ routeros      │ Mikrotik RouterOS version <span class=m>6</span>                   │
</span></span><span class=line><span class=cl>│ routeros7     │ Mikrotik RouterOS version <span class=m>7</span>                   │
</span></span><span class=line><span class=cl>│ sonic         │ Sonic VM                                      │
</span></span><span class=line><span class=cl>│ srlinux       │ Nokia SR Linux container                      │
</span></span><span class=line><span class=cl>│ sros          │ Nokia SR OS container                         │
</span></span><span class=line><span class=cl>│ vjunos-switch │ vJunos Switch                                 │
</span></span><span class=line><span class=cl>│ vmx           │ Juniper vMX container                         │
</span></span><span class=line><span class=cl>│ vptx          │ Juniper vPTX                                  │
</span></span><span class=line><span class=cl>│ vsrx          │ Juniper vSRX 3.0                              │
</span></span><span class=line><span class=cl>│ vyos          │ VyOS VM/container                             │
</span></span><span class=line><span class=cl>└───────────────┴───────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Networking daemons supported by netlab
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┏━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
</span></span><span class=line><span class=cl>┃ daemon  ┃ description                  ┃
</span></span><span class=line><span class=cl>┡━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
</span></span><span class=line><span class=cl>│ bird    │ BIRD Internet Routing Daemon │
</span></span><span class=line><span class=cl>│ dnsmasq │ BIRD Internet Routing Daemon │
</span></span><span class=line><span class=cl>└─────────┴──────────────────────────────┘</span></span></code></pre></div><p>So <code>iol</code> for the routers and <code>linux</code> for the PC&rsquo;s and as you may have guessed <em>netlab</em> has a <code>defaults</code> <em>dictionary</em> that is pre-populated for us that we can of course override with custom values. For example, let&rsquo;s see which images will be used if we specify device type as <code>iol</code> and <code>linux</code> by using the <code>netlab show</code> command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· netlab show images -d iol
</span></span><span class=line><span class=cl>iol image names by virtualization provider
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┏━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━━━━┓
</span></span><span class=line><span class=cl>┃ device ┃ clab                        ┃ libvirt ┃ virtualbox ┃
</span></span><span class=line><span class=cl>┡━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━╇━━━━━━━━━━━━┩
</span></span><span class=line><span class=cl>│ iol    │ vrnetlab/cisco_iol:17.12.01 │         │            │
</span></span><span class=line><span class=cl>└────────┴─────────────────────────────┴─────────┴────────────┘
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· netlab show images -d linux
</span></span><span class=line><span class=cl>linux image names by virtualization provider
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┏━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
</span></span><span class=line><span class=cl>┃ device ┃ clab              ┃ libvirt            ┃ virtualbox         ┃
</span></span><span class=line><span class=cl>┡━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
</span></span><span class=line><span class=cl>│ linux  │ python:3.9-alpine │ generic/ubuntu2004 │ generic/ubuntu2004 │
</span></span><span class=line><span class=cl>└────────┴───────────────────┴────────────────────┴────────────────────┘</span></span></code></pre></div><p>So these container images will be picked up by default if we specify the respective device type in the topology. Of course, we want to override those since our images are different, and here is how we can do this in the topology file by utilising a separate <code>defaults</code> section prior to defining our <code>nodes</code> and their interconnection <code>links</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>provider</span><span class=p>:</span><span class=w> </span><span class=l>clab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>defaults</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>device</span><span class=p>:</span><span class=w> </span><span class=l>iol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>devices.iol.clab.image</span><span class=p>:</span><span class=w> </span><span class=l>vrnetlab/cisco_iol:17.12.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>devices.linux.clab.image</span><span class=p>:</span><span class=w> </span><span class=l>ghcr.io/srl-labs/network-multitool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>nodes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rc1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device</span><span class=p>:</span><span class=w> </span><span class=l>iol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rc2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device</span><span class=p>:</span><span class=w> </span><span class=l>iol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rc3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device</span><span class=p>:</span><span class=w> </span><span class=l>iol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rc4</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device</span><span class=p>:</span><span class=w> </span><span class=l>iol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pc1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device</span><span class=p>:</span><span class=w> </span><span class=l>linux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pc2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device</span><span class=p>:</span><span class=w> </span><span class=l>linux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pc3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device</span><span class=p>:</span><span class=w> </span><span class=l>linux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pc4</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device</span><span class=p>:</span><span class=w> </span><span class=l>linux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>links</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc1-rc2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc1-rc3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc2-rc4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc3-rc4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc1-pc1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc2-pc2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc3-pc3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc4-pc4</span></span></span></code></pre></div><p>Now, let&rsquo;s bring up the topology to see the real power of <em>netlab</em>. To start the lab we can use the <code>netlab up</code> command and after some scripts are executed and some ansible plays, everything is up and running. We can check this with <code>netlab status</code> command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· netlab status
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┏━━━━━━┳━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┓
</span></span><span class=line><span class=cl>┃ node ┃ device ┃ image                          ┃ mgmt IPv4       ┃ connection  ┃ provider ┃ VM/container ┃ status       ┃
</span></span><span class=line><span class=cl>┡━━━━━━╇━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━┩
</span></span><span class=line><span class=cl>│ pc1  │ linux  │ ghcr.io/srl-labs/network-mult… │ 192.168.121.105 │ docker      │ clab     │ clab-iol-pc1 │ Up <span class=m>2</span> minutes │
</span></span><span class=line><span class=cl>├──────┼────────┼────────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ pc2  │ linux  │ ghcr.io/srl-labs/network-mult… │ 192.168.121.106 │ docker      │ clab     │ clab-iol-pc2 │ Up <span class=m>2</span> minutes │
</span></span><span class=line><span class=cl>├──────┼────────┼────────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ pc3  │ linux  │ ghcr.io/srl-labs/network-mult… │ 192.168.121.107 │ docker      │ clab     │ clab-iol-pc3 │ Up <span class=m>2</span> minutes │
</span></span><span class=line><span class=cl>├──────┼────────┼────────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ pc4  │ linux  │ ghcr.io/srl-labs/network-mult… │ 192.168.121.108 │ docker      │ clab     │ clab-iol-pc4 │ Up <span class=m>2</span> minutes │
</span></span><span class=line><span class=cl>├──────┼────────┼────────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ rc1  │ iol    │ vrnetlab/cisco_iol:17.12.1     │ 192.168.121.101 │ network_cli │ clab     │ clab-iol-rc1 │ Up <span class=m>2</span> minutes │
</span></span><span class=line><span class=cl>├──────┼────────┼────────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ rc2  │ iol    │ vrnetlab/cisco_iol:17.12.1     │ 192.168.121.102 │ network_cli │ clab     │ clab-iol-rc2 │ Up <span class=m>2</span> minutes │
</span></span><span class=line><span class=cl>├──────┼────────┼────────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ rc3  │ iol    │ vrnetlab/cisco_iol:17.12.1     │ 192.168.121.103 │ network_cli │ clab     │ clab-iol-rc3 │ Up <span class=m>2</span> minutes │
</span></span><span class=line><span class=cl>├──────┼────────┼────────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ rc4  │ iol    │ vrnetlab/cisco_iol:17.12.1     │ 192.168.121.104 │ network_cli │ clab     │ clab-iol-rc4 │ Up <span class=m>2</span> minutes │
</span></span><span class=line><span class=cl>└──────┴────────┴────────────────────────────────┴─────────────────┴─────────────┴──────────┴──────────────┴──────────────┘</span></span></code></pre></div><p>Seems everything is up and running, but how is this different than just bringing up the topology with <em>containerlab</em>? Well, <em>netlab</em> goes one step further and configures the devices with basic ip connectivity and also with any other protocol that is supported as we will see later on. We can check on a device for example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· netlab <span class=nb>exec</span> rc1 show ip int br
</span></span><span class=line><span class=cl>Connecting to clab-iol-rc1 using SSH port 22, executing show ip int br
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Interface              IP-Address      OK? Method Status                Protocol
</span></span><span class=line><span class=cl>Ethernet0/0            192.168.121.101 YES TFTP   up                    up
</span></span><span class=line><span class=cl>Ethernet0/1            10.1.0.1        YES manual up                    up
</span></span><span class=line><span class=cl>Ethernet0/2            10.1.0.5        YES manual up                    up
</span></span><span class=line><span class=cl>Ethernet0/3            172.16.0.1      YES manual up                    up
</span></span><span class=line><span class=cl>Loopback0              10.0.0.1        YES manual up                    up      Connection to clab-iol-rc1 closed by remote host.</span></span></code></pre></div><p>Or on a PC:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· netlab <span class=nb>exec</span> pc1 ip -c -br a
</span></span><span class=line><span class=cl>Connecting to container clab-iol-pc1, executing ip -c -br a
</span></span><span class=line><span class=cl>lo               UNKNOWN        127.0.0.1/8 ::1/128
</span></span><span class=line><span class=cl>eth0@if1052      UP             192.168.121.105/24 fe80::42:c0ff:fea8:7969/64
</span></span><span class=line><span class=cl>eth1@if1065      UP             172.16.0.5/24 fe80::a8c1:abff:fe5d:19e2/64
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· netlab <span class=nb>exec</span> pc1 ip -c -br r
</span></span><span class=line><span class=cl>Connecting to container clab-iol-pc1, executing ip -c -br r
</span></span><span class=line><span class=cl>default via 192.168.121.1 dev eth0
</span></span><span class=line><span class=cl>10.0.0.0/24 via 172.16.0.1 dev eth1
</span></span><span class=line><span class=cl>10.1.0.0/16 via 172.16.0.1 dev eth1
</span></span><span class=line><span class=cl>10.2.0.0/24 via 172.16.0.1 dev eth1
</span></span><span class=line><span class=cl>172.16.0.0/24 dev eth1 proto kernel scope link src 172.16.0.5
</span></span><span class=line><span class=cl>172.16.0.0/16 via 172.16.0.1 dev eth1
</span></span><span class=line><span class=cl>192.168.121.0/24 dev eth0 proto kernel scope link src 192.168.121.105</span></span></code></pre></div><p>So apart from bringing up the nodes, <em>netlab</em> using its defaults dictionary and attributes, parsed the topology and provisioned IP addresses for every link and also configured the routing in linux to point to the blocks used in the topology via the containers&rsquo; second interface attached to the router. In this way, we can define our topology and protocols and <em>netlab</em> will take care of the commands needed to be provisioned and pushed to the nodes.</p><p>Let&rsquo;s see now the default addressing scheme:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>·&gt;&gt; netlab show defaults addressing
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>netlab default settings within the addressing <span class=nv>subtree</span>
</span></span><span class=line><span class=cl><span class=o>=============================================================================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>l2only: null
</span></span><span class=line><span class=cl>lan:
</span></span><span class=line><span class=cl>  ipv4: 172.16.0.0/16
</span></span><span class=line><span class=cl>loopback:
</span></span><span class=line><span class=cl>  ipv4: 10.0.0.0/24
</span></span><span class=line><span class=cl>mgmt:
</span></span><span class=line><span class=cl>  ipv4: 192.168.121.0/24
</span></span><span class=line><span class=cl>  mac: 08-4F-A9-00-00-00
</span></span><span class=line><span class=cl>  start: <span class=m>100</span>
</span></span><span class=line><span class=cl>p2p:
</span></span><span class=line><span class=cl>  ipv4: 10.1.0.0/16
</span></span><span class=line><span class=cl>router_id:
</span></span><span class=line><span class=cl>  ipv4: 10.0.0.0/24
</span></span><span class=line><span class=cl>  prefix: <span class=m>32</span>
</span></span><span class=line><span class=cl>vrf_loopback:
</span></span><span class=line><span class=cl>  ipv4: 10.2.0.0/24
</span></span><span class=line><span class=cl>  prefix: <span class=m>32</span></span></span></code></pre></div><p>As you see, for any p2p link the 10.1/16 block will be used, whereas for any lan, <em>netlab</em> will use the 172.16/16 one. 10.0.0/24 is used for the loopbacks and 10.2.0/24 for any loopback that belongs in a vrf and, of course, you may modify these as per your liking.</p><p>Furthermore, in order to understand this behaviour a bit more, check on the directory structure to see the different directories and files created since we brought up the lab:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· tree . -L <span class=m>1</span>
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── ansible.cfg          &lt;- Ansible configuration file
</span></span><span class=line><span class=cl>├── clab-iol             &lt;- clab related runtime directory
</span></span><span class=line><span class=cl>├── clab.yml             &lt;- Respective clab topology file
</span></span><span class=line><span class=cl>├── clab_files           &lt;- hosts files to mount at /etc/hosts <span class=k>for</span> every linux container
</span></span><span class=line><span class=cl>├── group_vars           &lt;- Ansible group_vars after merging the defaults and topology specific variables
</span></span><span class=line><span class=cl>├── host_vars            &lt;- same <span class=k>for</span> each host
</span></span><span class=line><span class=cl>├── hosts.yml            &lt;- Ansible inventory file
</span></span><span class=line><span class=cl>├── netlab.lock          &lt;- lock file when netlab is running
</span></span><span class=line><span class=cl>├── netlab.snapshot.yml  &lt;- snapshot of the whole dictionary
</span></span><span class=line><span class=cl>└── topology.yml         &lt;- Original topology file that we started with</span></span></code></pre></div><p>So we ended up having a full blown ansible structure for this lab that <em>netlab</em> is using to provision commands and, guess what, we can also use it with our own plays.</p><p>Two additional commands to help you in exploring the data structure and ansible variables available in the topology are <code>netlab inspect</code> and <code>ansible-inventory</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· netlab inspect --node rc1 loopback
</span></span><span class=line><span class=cl>ifindex: <span class=m>0</span>
</span></span><span class=line><span class=cl>ifname: Loopback0
</span></span><span class=line><span class=cl>ipv4: 10.0.0.1/32
</span></span><span class=line><span class=cl>neighbors: <span class=o>[]</span>
</span></span><span class=line><span class=cl>type: loopback
</span></span><span class=line><span class=cl>virtual_interface: <span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· ansible-inventory --host rc1 <span class=p>|</span> jq .loopback
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;ifindex&#34;</span>: 0,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;ifname&#34;</span>: <span class=s2>&#34;Loopback0&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;ipv4&#34;</span>: <span class=s2>&#34;10.0.0.1/32&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;neighbors&#34;</span>: <span class=o>[]</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;loopback&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;virtual_interface&#34;</span>: <span class=nb>true</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><p>OK, now that we got the hang of it, let&rsquo;s bring down the topology and cleanup our directory structure in order to complete the basic topology definition.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· netlab down --cleanup
</span></span><span class=line><span class=cl><span class=o>[</span>SUCCESS<span class=o>]</span> Read transformed lab topology from snapshot file netlab.snapshot.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┌──────────────────────────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│ CHECKING virtualization provider installation                                    │
</span></span><span class=line><span class=cl>└──────────────────────────────────────────────────────────────────────────────────┘
</span></span><span class=line><span class=cl><span class=o>[</span>SUCCESS<span class=o>]</span> clab installed and working correctly
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┌──────────────────────────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│ STOPPING clab nodes                                                              │
</span></span><span class=line><span class=cl>└──────────────────────────────────────────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>INFO<span class=o>[</span>0000<span class=o>]</span> Parsing <span class=p>&amp;</span> checking topology file: clab.yml
</span></span><span class=line><span class=cl>INFO<span class=o>[</span>0000<span class=o>]</span> Parsing <span class=p>&amp;</span> checking topology file: clab.yml
</span></span><span class=line><span class=cl>WARN<span class=o>[</span>0000<span class=o>]</span> errors during iptables rules install: not available
</span></span><span class=line><span class=cl>INFO<span class=o>[</span>0000<span class=o>]</span> Destroying lab: iol
</span></span><span class=line><span class=cl>INFO<span class=o>[</span>0001<span class=o>]</span> Removed container: clab-iol-pc4
</span></span><span class=line><span class=cl>INFO<span class=o>[</span>0001<span class=o>]</span> Removed container: clab-iol-rc2
</span></span><span class=line><span class=cl>INFO<span class=o>[</span>0002<span class=o>]</span> Removed container: clab-iol-pc1
</span></span><span class=line><span class=cl>INFO<span class=o>[</span>0002<span class=o>]</span> Removed container: clab-iol-pc3
</span></span><span class=line><span class=cl>INFO<span class=o>[</span>0002<span class=o>]</span> Removed container: clab-iol-pc2
</span></span><span class=line><span class=cl>INFO<span class=o>[</span>0002<span class=o>]</span> Removed container: clab-iol-rc4
</span></span><span class=line><span class=cl>INFO<span class=o>[</span>0002<span class=o>]</span> Removed container: clab-iol-rc1
</span></span><span class=line><span class=cl>INFO<span class=o>[</span>0002<span class=o>]</span> Removed container: clab-iol-rc3
</span></span><span class=line><span class=cl>INFO<span class=o>[</span>0002<span class=o>]</span> Removing containerlab host entries from /etc/hosts file
</span></span><span class=line><span class=cl>INFO<span class=o>[</span>0002<span class=o>]</span> Removing ssh config <span class=k>for</span> containerlab nodes
</span></span><span class=line><span class=cl>WARN<span class=o>[</span>0003<span class=o>]</span> errors during iptables rules removal: not available
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┌──────────────────────────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│ CLEANUP configuration files                                                      │
</span></span><span class=line><span class=cl>└──────────────────────────────────────────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>... removing clab.yml
</span></span><span class=line><span class=cl>... removing directory tree clab_files
</span></span><span class=line><span class=cl>... removing ansible.cfg
</span></span><span class=line><span class=cl>... removing hosts.yml
</span></span><span class=line><span class=cl>... removing directory tree group_vars
</span></span><span class=line><span class=cl>... removing directory tree host_vars
</span></span><span class=line><span class=cl>... removing netlab.snapshot.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· tree .
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>└── topology.yml</span></span></code></pre></div><h3 class=heading-element id=base-topology---complete><span>Base Topology - Complete</span>
<a href=#base-topology---complete class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>Here is the complete basic topology file with adding some extra quirks:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>provider</span><span class=p>:</span><span class=w> </span><span class=l>clab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>defaults</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>device</span><span class=p>:</span><span class=w> </span><span class=l>iol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>devices.iol.clab.image</span><span class=p>:</span><span class=w> </span><span class=l>vrnetlab/cisco_iol:17.12.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>devices.linux.clab.image</span><span class=p>:</span><span class=w> </span><span class=l>ghcr.io/srl-labs/network-multitool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>providers.clab.lab_prefix</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>groups._auto_create</span><span class=p>:</span><span class=w> </span><span class=kc>True</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>paths.append.custom.dirs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>templates ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vrf.as</span><span class=p>:</span><span class=w> </span><span class=m>65515</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>groups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>core</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>members</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>rc1, rc2, rc3, rc4 ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>module</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>ospf, bgp, mpls, vrf ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bgp.as</span><span class=p>:</span><span class=w> </span><span class=m>65515</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mpls.vpn</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>ibgp ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vrf.loopback</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>config</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>core_extras ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ces</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>members</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>ce1, ce2, ce3, ce4 ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>module</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>bgp ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pcs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>members</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>pc1, pc2, pc3, pc4, pc11, pc12, pc13, pc14 ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device</span><span class=p>:</span><span class=w> </span><span class=l>linux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>config</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>iperf3_server ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>IPERF3_TESTS</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>{<span class=w> </span><span class=nt>&#34;src&#34;:&#34;pc1&#34;, &#34;dst&#34;: &#34;pc4&#34;, &#34;port&#34;: </span><span class=s2>&#34;5201&#34;</span><span class=w> </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>{<span class=w> </span><span class=nt>&#34;src&#34;:&#34;pc2&#34;, &#34;dst&#34;: &#34;pc1&#34;, &#34;port&#34;: </span><span class=s2>&#34;5201&#34;</span><span class=w> </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>{<span class=w> </span><span class=nt>&#34;src&#34;:&#34;pc3&#34;, &#34;dst&#34;: &#34;pc2&#34;, &#34;port&#34;: </span><span class=s2>&#34;5201&#34;</span><span class=w> </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>{<span class=w> </span><span class=nt>&#34;src&#34;:&#34;pc4&#34;, &#34;dst&#34;: &#34;pc3&#34;, &#34;port&#34;: </span><span class=s2>&#34;5201&#34;</span><span class=w> </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>{<span class=w> </span><span class=nt>&#34;src&#34;:&#34;pc1&#34;, &#34;dst&#34;: &#34;pc3&#34;, &#34;port&#34;: </span><span class=s2>&#34;5202&#34;</span><span class=w> </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>{<span class=w> </span><span class=nt>&#34;src&#34;:&#34;pc2&#34;, &#34;dst&#34;: &#34;pc4&#34;, &#34;port&#34;: </span><span class=s2>&#34;5202&#34;</span><span class=w> </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>{<span class=w> </span><span class=nt>&#34;src&#34;:&#34;pc11&#34;, &#34;dst&#34;: &#34;pc14&#34;, &#34;port&#34;: </span><span class=s2>&#34;5201&#34;</span><span class=w> </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>{<span class=w> </span><span class=nt>&#34;src&#34;:&#34;pc14&#34;, &#34;dst&#34;: &#34;pc11&#34;, &#34;port&#34;: </span><span class=s2>&#34;5201&#34;</span><span class=w> </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>{<span class=w> </span><span class=nt>&#34;src&#34;:&#34;pc12&#34;, &#34;dst&#34;: &#34;pc13&#34;, &#34;port&#34;: </span><span class=s2>&#34;5201&#34;</span><span class=w> </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>{<span class=w> </span><span class=nt>&#34;src&#34;:&#34;pc13&#34;, &#34;dst&#34;: &#34;pc12&#34;, &#34;port&#34;: </span><span class=s2>&#34;5201&#34;</span><span class=w> </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>]</span><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>vrfs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>blue</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rd</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;65515:101&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>nodes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rc1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rc2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vrfs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>red</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>rd</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10.0.0.2:102&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>import</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;65515:102&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>export</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;65515:102&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rc3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vrfs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>red</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>rd</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10.0.0.3:102&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>import</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;65515:102&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>export</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;65515:102&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rc4</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ce1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=m>11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bgp.as</span><span class=p>:</span><span class=w> </span><span class=m>65101</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ce2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=m>12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bgp.as</span><span class=p>:</span><span class=w> </span><span class=m>65201</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ce3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=m>13</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bgp.as</span><span class=p>:</span><span class=w> </span><span class=m>65202</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ce4</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=m>14</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bgp.as</span><span class=p>:</span><span class=w> </span><span class=m>65102</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>links</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc1-rc2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc1-rc3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc2-rc4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc3-rc4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc1-pc1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc2-pc2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc3-pc3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc4-pc4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>rc1</span><span class=p>:</span><span class=w> </span>{<span class=w> </span><span class=nt>vrf</span><span class=p>:</span><span class=w> </span><span class=l>blue }</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ce1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>rc2</span><span class=p>:</span><span class=w> </span>{<span class=w> </span><span class=nt>vrf</span><span class=p>:</span><span class=w> </span><span class=l>red }</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ce2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>rc3</span><span class=p>:</span><span class=w> </span>{<span class=w> </span><span class=nt>vrf</span><span class=p>:</span><span class=w> </span><span class=l>red }</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ce3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>rc4</span><span class=p>:</span><span class=w> </span>{<span class=w> </span><span class=nt>vrf</span><span class=p>:</span><span class=w> </span><span class=l>blue }</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ce4</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>ce1-pc11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>ce2-pc12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>ce3-pc13</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>ce4-pc14</span></span></span></code></pre></div><p>OK, we have now added some things or two here that we will expand on.</p><ul><li>First of all, we have used the <code>groups</code> section to group our nodes and apply attributes to them rather than having to replicate them for each one in the <code>nodes</code> section.</li><li>The <code>groups._auto_create: True</code> allows for not having to define each node under the node section and create them ad-hoc from the members list under the <code>groups</code>, but this does not guarantee the <code>id</code> each node will have. Since the addressing considers those <code>id's</code> and the order of specifying them under the <code>nodes</code> section matters, we can have a mix of those two ways to auto-define nodes and also pin some to specific <code>ids</code>. So rc&rsquo;s get 1 to 4, ce&rsquo;s 11 to 14 and for pc&rsquo;s we don&rsquo;t care.</li><li>The desired protocols to be enabled on each node is done via the <code>module</code> structure.</li><li>We have used the <code>defaults.providers.clab.lab_prefix: ""</code> in order for the containers not to include the default <code>clab-&lt;directoty></code> prefix in their name.</li><li>We are using jinja templates to provision additional commands to the nodes during start up and we define them in the <code>config</code> section of our <code>groups</code> definition. I have all my templates under a <code>templates</code> folder in the directory structure, so we need a way to let <em>netlab</em> <em>know</em> where to search for them. This is done by the <code>defaults.paths.append.custom.dirs: [ templates ]</code> key.</li><li>For core devices, we are enabling dns server on them via the <code>core_extras</code> template</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=x>(wsl)&lt;&lt;· cat templates/core_extras.j2
</span></span></span><span class=line><span class=cl><span class=x></span><span class=c>{# Enable DNS server in both GRT and mgmt vrf #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>ip dns server
</span></span></span><span class=line><span class=cl><span class=x>ip dns view vrf clab-mgmt
</span></span></span><span class=line><span class=cl><span class=x>!</span></span></span></code></pre></div><ul><li>For the PCs, we want them to run <em>iperf3</em> as server and also have the ability to start and stop traffic generation after the lab is up. So here, we have defined all the tests in a structure as a variable, that we can decompose in jinja to get either the server ports that need to be listening on, or the actual client tests to be performed. The server template is executed during bring up and for each PC we are looking to listen to all target ports:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=cp>{%</span> <span class=k>for</span> <span class=nv>test</span> <span class=k>in</span> <span class=nv>IPERF3_TESTS</span> <span class=cp>%}{%</span> <span class=k>if</span> <span class=nv>test.dst</span> <span class=o>==</span> <span class=nv>hostname</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>iperf3 -s -p </span><span class=cp>{{</span> <span class=nv>test.port</span> <span class=cp>}}</span><span class=x> -D
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>```</span></span></span></code></pre></div><ul><li>For the client tests we use the <code>netlab config</code> command to render the template ad-hoc and run or stop the tests after the topology is brought up:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=cp>{%</span> <span class=k>if</span> <span class=nv>ACTION</span> <span class=k>is</span> <span class=k>not</span> <span class=nf>defined</span> <span class=k>or</span> <span class=nv>ACTION</span> <span class=k>not</span> <span class=k>in</span> <span class=o>[</span><span class=s1>&#39;run&#39;</span><span class=o>,</span><span class=s1>&#39;stop&#39;</span><span class=o>]</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x> </span><span class=cp>{{</span><span class=kp>_</span><span class=o>|</span><span class=nf>mandatory</span><span class=o>(</span><span class=s2>&#34;ACTION is mandatoy - run or stop&#34;</span><span class=o>)</span><span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>elif</span> <span class=nv>ACTION</span> <span class=o>==</span> <span class=s2>&#34;run&#34;</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>test</span> <span class=k>in</span> <span class=nv>IPERF3_TESTS</span> <span class=cp>%}{%</span> <span class=k>if</span> <span class=nv>test.src</span> <span class=o>==</span> <span class=nv>hostname</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>iperf3 -c </span><span class=cp>{{</span> <span class=nv>test.dst</span> <span class=cp>}}</span><span class=x> -p </span><span class=cp>{{</span> <span class=nv>test.port</span><span class=cp>}}</span><span class=x> -t0 -P 5 -b 5M  &gt; iperf-</span><span class=cp>{{</span> <span class=nv>test.dst</span> <span class=cp>}}</span><span class=x>.log &amp;
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>elif</span> <span class=nv>ACTION</span> <span class=o>==</span> <span class=s2>&#34;stop&#34;</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>ps aux | grep &#39;iperf3 -c&#39; | grep -v grep | awk &#39;{print $2}&#39; | xargs kill -9
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>ANSIBLE_NOCOWS</span><span class=o>=</span><span class=m>1</span> netlab config iperf3_clients -l pc1 -e <span class=nv>ACTION</span><span class=o>=</span>run --check -v
</span></span><span class=line><span class=cl>&lt; snipped &gt; 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>Process template /home/netlab/iol/templates/iperf3_clients.j2 <span class=k>for</span> pc1<span class=o>]</span> **********
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>pc1<span class=o>]</span> <span class=o>=</span>&gt;
</span></span><span class=line><span class=cl>  msg: <span class=p>|</span>-
</span></span><span class=line><span class=cl>    /home/netlab/iol/templates/iperf3_clients.j2 configuration <span class=k>for</span> <span class=nv>pc1</span>
</span></span><span class=line><span class=cl>    <span class=o>=========================================</span>
</span></span><span class=line><span class=cl>    iperf3 -c pc4 -p <span class=m>5201</span> -t0 -P <span class=m>5</span> -b 5M  &gt; iperf-pc4.log <span class=p>&amp;</span>
</span></span><span class=line><span class=cl>    iperf3 -c pc3 -p <span class=m>5202</span> -t0 -P <span class=m>5</span> -b 5M  &gt; iperf-pc3.log <span class=p>&amp;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt; snipped &gt; </span></span></code></pre></div><p>We could be more granular here on the parallel streams, time, bandwidth or whatever else is required.</p><ul><li>Lastly, for the <code>vrf</code> module, we wanted one VPN to use IPv4:Number format so we had to manually specify the RDs/RTs under the nodes.</li></ul><p>Let&rsquo;s issue a <code>netlab create</code> first to check if we are syntactically correct or we missed some logic, and then bring it up.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· netlab create
</span></span><span class=line><span class=cl><span class=o>[</span>CREATED<span class=o>]</span> provider configuration file: clab.yml
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/pc1/hosts to pc1:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/pc2/hosts to pc2:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/pc3/hosts to pc3:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/pc4/hosts to pc4:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/pc11/hosts to pc11:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/pc12/hosts to pc12:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/pc13/hosts to pc13:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/pc14/hosts to pc14:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>CREATED<span class=o>]</span> transformed topology dump in YAML format in netlab.snapshot.yml
</span></span><span class=line><span class=cl><span class=o>[</span>GROUPS<span class=o>]</span>  group_vars <span class=k>for</span> all
</span></span><span class=line><span class=cl><span class=o>[</span>GROUPS<span class=o>]</span>  group_vars <span class=k>for</span> modules
</span></span><span class=line><span class=cl><span class=o>[</span>GROUPS<span class=o>]</span>  group_vars <span class=k>for</span> custom_configs
</span></span><span class=line><span class=cl><span class=o>[</span>GROUPS<span class=o>]</span>  group_vars <span class=k>for</span> iol
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> rc1
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> rc2
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> rc3
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> rc4
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> ce1
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> ce2
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> ce3
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> ce4
</span></span><span class=line><span class=cl><span class=o>[</span>GROUPS<span class=o>]</span>  group_vars <span class=k>for</span> linux
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> pc1
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> pc2
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> pc3
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> pc4
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> pc11
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> pc12
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> pc13
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> pc14
</span></span><span class=line><span class=cl><span class=o>[</span>GROUPS<span class=o>]</span>  group_vars <span class=k>for</span> pcs
</span></span><span class=line><span class=cl><span class=o>[</span>CREATED<span class=o>]</span> minimized Ansible inventory hosts.yml
</span></span><span class=line><span class=cl><span class=o>[</span>CREATED<span class=o>]</span> Ansible configuration file: ansible.cfg</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· <span class=nv>ANSIBLE_NOCOWS</span><span class=o>=</span><span class=m>1</span> netlab up
</span></span><span class=line><span class=cl>&lt; snipped &gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PLAY RECAP ****************************************************************************************************************
</span></span><span class=line><span class=cl>ce1                        : <span class=nv>ok</span><span class=o>=</span><span class=m>25</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>4</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>14</span>   <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>ce2                        : <span class=nv>ok</span><span class=o>=</span><span class=m>24</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>14</span>   <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>ce3                        : <span class=nv>ok</span><span class=o>=</span><span class=m>24</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>14</span>   <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>ce4                        : <span class=nv>ok</span><span class=o>=</span><span class=m>24</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>14</span>   <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc1                        : <span class=nv>ok</span><span class=o>=</span><span class=m>19</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>5</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>5</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc11                       : <span class=nv>ok</span><span class=o>=</span><span class=m>19</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>5</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>5</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc12                       : <span class=nv>ok</span><span class=o>=</span><span class=m>19</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>5</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>5</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc13                       : <span class=nv>ok</span><span class=o>=</span><span class=m>19</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>5</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>5</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc14                       : <span class=nv>ok</span><span class=o>=</span><span class=m>19</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>5</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>5</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc2                        : <span class=nv>ok</span><span class=o>=</span><span class=m>19</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>5</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>5</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc3                        : <span class=nv>ok</span><span class=o>=</span><span class=m>19</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>5</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>5</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc4                        : <span class=nv>ok</span><span class=o>=</span><span class=m>19</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>5</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>5</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>rc1                        : <span class=nv>ok</span><span class=o>=</span><span class=m>42</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>7</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>8</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>rc2                        : <span class=nv>ok</span><span class=o>=</span><span class=m>42</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>7</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>8</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>rc3                        : <span class=nv>ok</span><span class=o>=</span><span class=m>42</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>7</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>8</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>rc4                        : <span class=nv>ok</span><span class=o>=</span><span class=m>42</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>7</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>8</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>SUCCESS<span class=o>]</span> Lab devices configured
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· netlab status
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┏━━━━━━┳━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
</span></span><span class=line><span class=cl>┃ node ┃ device ┃ image                     ┃ mgmt IPv4       ┃ connection  ┃ provider ┃ VM/container ┃ status            ┃
</span></span><span class=line><span class=cl>┡━━━━━━╇━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
</span></span><span class=line><span class=cl>│ ce1  │ iol    │ vrnetlab/cisco_iol:17.12… │ 192.168.121.111 │ network_cli │ clab     │ ce1          │ Up About a minute │
</span></span><span class=line><span class=cl>├──────┼────────┼───────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼───────────────────┤
</span></span><span class=line><span class=cl>│ ce2  │ iol    │ vrnetlab/cisco_iol:17.12… │ 192.168.121.112 │ network_cli │ clab     │ ce2          │ Up About a minute │
</span></span><span class=line><span class=cl>├──────┼────────┼───────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼───────────────────┤
</span></span><span class=line><span class=cl>│ ce3  │ iol    │ vrnetlab/cisco_iol:17.12… │ 192.168.121.113 │ network_cli │ clab     │ ce3          │ Up About a minute │
</span></span><span class=line><span class=cl>├──────┼────────┼───────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼───────────────────┤
</span></span><span class=line><span class=cl>│ ce4  │ iol    │ vrnetlab/cisco_iol:17.12… │ 192.168.121.114 │ network_cli │ clab     │ ce4          │ Up About a minute │
</span></span><span class=line><span class=cl>├──────┼────────┼───────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼───────────────────┤
</span></span><span class=line><span class=cl>│ pc1  │ linux  │ ghcr.io/srl-labs/network… │ 192.168.121.105 │ docker      │ clab     │ pc1          │ Up About a minute │
</span></span><span class=line><span class=cl>├──────┼────────┼───────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼───────────────────┤
</span></span><span class=line><span class=cl>│ pc11 │ linux  │ ghcr.io/srl-labs/network… │ 192.168.121.109 │ docker      │ clab     │ pc11         │ Up About a minute │
</span></span><span class=line><span class=cl>├──────┼────────┼───────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼───────────────────┤
</span></span><span class=line><span class=cl>│ pc12 │ linux  │ ghcr.io/srl-labs/network… │ 192.168.121.110 │ docker      │ clab     │ pc12         │ Up About a minute │
</span></span><span class=line><span class=cl>├──────┼────────┼───────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼───────────────────┤
</span></span><span class=line><span class=cl>│ pc13 │ linux  │ ghcr.io/srl-labs/network… │ 192.168.121.115 │ docker      │ clab     │ pc13         │ Up About a minute │
</span></span><span class=line><span class=cl>├──────┼────────┼───────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼───────────────────┤
</span></span><span class=line><span class=cl>│ pc14 │ linux  │ ghcr.io/srl-labs/network… │ 192.168.121.116 │ docker      │ clab     │ pc14         │ Up About a minute │
</span></span><span class=line><span class=cl>├──────┼────────┼───────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼───────────────────┤
</span></span><span class=line><span class=cl>│ pc2  │ linux  │ ghcr.io/srl-labs/network… │ 192.168.121.106 │ docker      │ clab     │ pc2          │ Up About a minute │
</span></span><span class=line><span class=cl>├──────┼────────┼───────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼───────────────────┤
</span></span><span class=line><span class=cl>│ pc3  │ linux  │ ghcr.io/srl-labs/network… │ 192.168.121.107 │ docker      │ clab     │ pc3          │ Up About a minute │
</span></span><span class=line><span class=cl>├──────┼────────┼───────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼───────────────────┤
</span></span><span class=line><span class=cl>│ pc4  │ linux  │ ghcr.io/srl-labs/network… │ 192.168.121.108 │ docker      │ clab     │ pc4          │ Up About a minute │
</span></span><span class=line><span class=cl>├──────┼────────┼───────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼───────────────────┤
</span></span><span class=line><span class=cl>│ rc1  │ iol    │ vrnetlab/cisco_iol:17.12… │ 192.168.121.101 │ network_cli │ clab     │ rc1          │ Up About a minute │
</span></span><span class=line><span class=cl>├──────┼────────┼───────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼───────────────────┤
</span></span><span class=line><span class=cl>│ rc2  │ iol    │ vrnetlab/cisco_iol:17.12… │ 192.168.121.102 │ network_cli │ clab     │ rc2          │ Up About a minute │
</span></span><span class=line><span class=cl>├──────┼────────┼───────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼───────────────────┤
</span></span><span class=line><span class=cl>│ rc3  │ iol    │ vrnetlab/cisco_iol:17.12… │ 192.168.121.103 │ network_cli │ clab     │ rc3          │ Up About a minute │
</span></span><span class=line><span class=cl>├──────┼────────┼───────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼───────────────────┤
</span></span><span class=line><span class=cl>│ rc4  │ iol    │ vrnetlab/cisco_iol:17.12… │ 192.168.121.104 │ network_cli │ clab     │ rc4          │ Up About a minute │
</span></span><span class=line><span class=cl>└──────┴────────┴───────────────────────────┴─────────────────┴─────────────┴──────────┴──────────────┴───────────────────┘</span></span></code></pre></div><p>All our nodes are up and as you can see from their management IP, their <code>id's</code> are following either the order of their definition in the topology file or the <code>id</code> value defined for them.</p><h3 class=heading-element id=service-containers><span>Service Containers</span>
<a href=#service-containers class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>Let&rsquo;s add now our additional containers based on our use case. We are going to be defining them in the topology as we did for our <code>PC's</code>, but here we also need to pass some <code>env</code> variables to them in order for <em>containerlab</em> to bring them up properly. Some of these variables have common values for all but some have specific one&rsquo;s. Hence, we are going to use the hierarchy to define them accordingly.</p><p>Here is how the relevant <code>groups</code> section looks like in the topology:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>groups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ksynth</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>members</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>ksynth1, ksynth2, ksynth3, ksynth4 ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device</span><span class=p>:</span><span class=w> </span><span class=l>linux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>clab</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>kentik/ksynth-agent:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kentik</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>members</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>kproxy, kbgp, ksynth1, ksynth2, ksynth3, ksynth4 ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>clab</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>KENTIK_COMPANY</span><span class=p>:</span><span class=w> </span><span class=l>&lt; Kentik Company ID &gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>KENTIK_REGION</span><span class=p>:</span><span class=w> </span><span class=l>EU</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>KENTIK_API_TOKEN</span><span class=p>:</span><span class=w> </span><span class=l>&lt; Kentik User Token &gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>KENTIK_API_EMAIL</span><span class=p>:</span><span class=w> </span><span class=l>&lt; Kentik User Email &gt;</span></span></span></code></pre></div><p>Here we have used one group to define the <strong>ksynth</strong> agents that are based on the relevant image, and also, used the <strong>kentik</strong> group to define the common variables that all the service containers need in order to communicate with Kentik.</p><p>Now, let&rsquo;s look at the <code>nodes</code> section:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>nodes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kproxy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device</span><span class=p>:</span><span class=w> </span><span class=l>linux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>clab</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>kentik/kproxy:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cmd</span><span class=p>:</span><span class=w> </span><span class=p>&gt;-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>           -api_email=&lt; Kentik kproxy agent email address &gt;
</span></span></span><span class=line><span class=cl><span class=sd>           -region=EU
</span></span></span><span class=line><span class=cl><span class=sd>           -healthcheck=0.0.0.0
</span></span></span><span class=line><span class=cl><span class=sd>           -dns internal:192.168.121.101:53</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ksynth1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>clab.binds</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>mounts/ksynth1:/var/lib/ksynth-agent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ksynth2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>clab.binds</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>mounts/ksynth2:/var/lib/ksynth-agent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ksynth3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>clab.binds</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>mounts/ksynth3:/var/lib/ksynth-agent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ksynth4</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>clab.binds</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>mounts/ksynth4:/var/lib/ksynth-agent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kbgp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device</span><span class=p>:</span><span class=w> </span><span class=l>linux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>clab</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>kentik/kbgp:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>KENTIK_REGION</span><span class=p>:</span><span class=w> </span><span class=l>fra1</span></span></span></code></pre></div><p>Here we can observe the following:</p><ul><li>For <strong>kproxy</strong>: We define the image and pass along the command line to be run on the container. All other <code>env</code> variables defined in the <code>groups</code> section are going to be available to the container as well. Unfortunately, I could not find a way to dynamically pass variables in the <code>clab.cmd</code></li><li>For <strong>ksynth</strong>: Since we want the agents to persist, we have to preserve the relevant directory across deployments, so we bind mount a local directory path for every instance. The relevant directories have to exist in our directory structure.</li><li>For <strong>kbgp</strong>: We specify the image and re-define the region variable to override the one defined in the <code>groups</code> section since only <strong>kbgp</strong> needs it to be like that.</li></ul><p>We also create the additional connections in our <code>links</code> section:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>links</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc1-ksynth1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc2-ksynth2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc3-ksynth3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc4-ksynth4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>rc1-kbgp</span></span></span></code></pre></div><p>Now, for our last agent that will be part of Kentik NMS, we are going to bring this up as a standalone container not controlled via <em>netlab</em>, and here is how the <em>compose</em> file looks like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kagent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>kagent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostname</span><span class=p>:</span><span class=w> </span><span class=l>iol_kagent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>kentik/kagent:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>network_mode</span><span class=p>:</span><span class=w> </span><span class=l>host</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>K_COMPANY_ID</span><span class=p>:</span><span class=w> </span><span class=l>&lt; Kentik Company ID &gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>K_API_ROOT</span><span class=p>:</span><span class=w> </span><span class=l>grpc.api.kentik.eu:443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cap_add</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NET_RAW</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>kagent-data:/opt/kentik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kagent-data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>driver</span><span class=p>:</span><span class=w> </span><span class=l>local</span></span></span></code></pre></div><p>Two points here worth exploring:</p><ul><li><strong>kagent</strong> is not part of the topology since currently there is no way to pass the capability to <em>containerlab</em></li><li>The agent is going to poll the devices for SNMP so connectivity wise, this works by default since both agent network (host) and topology management networks are on the same host (WSL)</li></ul><p>Now, this seems the case also for the <strong>kproxy</strong> container, but here, <em>netlab</em> is going to need its&rsquo; IP address in order to add additional configuration to the devices exporting flows as we are going to see in the following paragraphs.</p><p>One last part to cover here is the fact that we have to provision our network devices accordingly in order to be ready to integrate with Kentik. This means that:</p><ol><li>They need to be sending netflow to <strong>kproxy</strong></li><li>They need to have snmp enabled in order to be polled by <strong>kproxy</strong> and <strong>kagent</strong></li><li>They need to be peering with <strong>kbgp</strong> in order to send their BGP tables to Kentik</li></ol><p>Well, it seems as a usual case of templating configurations and passing them on to devices via <em>netlab</em>.</p><p>For the snmp part, we just re-use our <code>core-extras</code> template to add the config:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=x>&lt; snipped &gt;
</span></span></span><span class=line><span class=cl><span class=x></span><span class=c>{# Enable SNMP #}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>snmp-server ifindex persist
</span></span></span><span class=line><span class=cl><span class=x>snmp-server community </span><span class=cp>{{</span> <span class=nv>KENTIK_SNMPV2_COMMUNITY</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>!</span></span></span></code></pre></div><p>For the netflow part, IOL supports a feature called Flexible netflow and can do v9 and ipfix as well as standard netflow v9 exports. I have seen that with Flexible netflow configuration, there is no way to configure the active cache settings and we need this to be 1 min. for Kentik. In any case, here are the respective templates for all three variations of the netflow configurations needed.</p><div class=highlight title="Standard Netflow v9"><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=cp>{%</span> <span class=k>if</span> <span class=nv>ACTION</span> <span class=k>is</span> <span class=k>not</span> <span class=nf>defined</span> <span class=k>or</span> <span class=nv>ACTION</span> <span class=k>not</span> <span class=k>in</span> <span class=o>[</span><span class=s1>&#39;push&#39;</span><span class=o>,</span><span class=s1>&#39;remove&#39;</span><span class=o>]</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span><span class=kp>_</span><span class=o>|</span><span class=nf>mandatory</span><span class=o>(</span><span class=s2>&#34;ACTION is mandatoy - push or remove&#34;</span><span class=o>)</span><span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>elif</span> <span class=nv>ACTION</span> <span class=o>==</span> <span class=s2>&#34;remove&#34;</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>interface range </span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>interface</span> <span class=k>in</span> <span class=nv>netlab_interfaces</span> <span class=k>if</span> <span class=nv>interface.type</span> <span class=p>!</span><span class=o>=</span> <span class=s1>&#39;loopback&#39;</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=nv>interface.ifname</span> <span class=o>+</span> <span class=s2>&#34; , &#34;</span> <span class=k>if</span> <span class=k>not</span> <span class=nb>loop</span><span class=nv>.last</span> <span class=k>else</span> <span class=nv>interface.ifname</span> <span class=cp>}}{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>  no flow-sampler KENTIK
</span></span></span><span class=line><span class=cl><span class=x> !
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>no ip flow-export source Ethernet0/0
</span></span></span><span class=line><span class=cl><span class=x>no ip flow-export version 9 origin-as bgp-nexthop
</span></span></span><span class=line><span class=cl><span class=x>no ip flow-export template options sampler
</span></span></span><span class=line><span class=cl><span class=x>no ip flow-export template timeout-rate
</span></span></span><span class=line><span class=cl><span class=x>no ip flow-export template refresh-rate
</span></span></span><span class=line><span class=cl><span class=x>no ip flow-export destination </span><span class=cp>{{</span> <span class=nv>hostvars</span><span class=o>[</span><span class=s1>&#39;kproxy&#39;</span><span class=o>][</span><span class=s1>&#39;mgmt&#39;</span><span class=o>][</span><span class=s1>&#39;ipv4&#39;</span><span class=o>]</span> <span class=cp>}}</span><span class=x> 9995 vrf clab-mgmt
</span></span></span><span class=line><span class=cl><span class=x>no flow-sampler-map KENTIK
</span></span></span><span class=line><span class=cl><span class=x>no ip flow-cache timeout inactive
</span></span></span><span class=line><span class=cl><span class=x>no ip flow-cache timeout active
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>elif</span> <span class=nv>ACTION</span> <span class=o>==</span> <span class=s2>&#34;push&#34;</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>ip flow-cache timeout inactive 30
</span></span></span><span class=line><span class=cl><span class=x>ip flow-cache timeout active 1
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>flow-sampler-map KENTIK
</span></span></span><span class=line><span class=cl><span class=x> mode random one-out-of </span><span class=cp>{{</span> <span class=nv>KENTIK_SAMPLE_RATE</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>ip flow-export source Ethernet0/0
</span></span></span><span class=line><span class=cl><span class=x>ip flow-export version 9 origin-as bgp-nexthop
</span></span></span><span class=line><span class=cl><span class=x>ip flow-export template options sampler
</span></span></span><span class=line><span class=cl><span class=x>ip flow-export template timeout-rate 1
</span></span></span><span class=line><span class=cl><span class=x>ip flow-export template refresh-rate 50
</span></span></span><span class=line><span class=cl><span class=x>ip flow-export destination </span><span class=cp>{{</span> <span class=nv>hostvars</span><span class=o>[</span><span class=s1>&#39;kproxy&#39;</span><span class=o>][</span><span class=s1>&#39;mgmt&#39;</span><span class=o>][</span><span class=s1>&#39;ipv4&#39;</span><span class=o>]</span> <span class=cp>}}</span><span class=x> 9995 vrf clab-mgmt
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>interface range </span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>interface</span> <span class=k>in</span> <span class=nv>netlab_interfaces</span> <span class=k>if</span> <span class=nv>interface.type</span> <span class=p>!</span><span class=o>=</span> <span class=s1>&#39;loopback&#39;</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=nv>interface.ifname</span> <span class=o>+</span> <span class=s2>&#34; , &#34;</span> <span class=k>if</span> <span class=k>not</span> <span class=nb>loop</span><span class=nv>.last</span> <span class=k>else</span> <span class=nv>interface.ifname</span> <span class=cp>}}{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>  flow-sampler KENTIK
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span></span></span></code></pre></div><div class=highlight title="Flexible Netflow v9"><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=cp>{%</span> <span class=k>if</span> <span class=nv>ACTION</span> <span class=k>is</span> <span class=k>not</span> <span class=nf>defined</span> <span class=k>or</span> <span class=nv>ACTION</span> <span class=k>not</span> <span class=k>in</span> <span class=o>[</span><span class=s1>&#39;push&#39;</span><span class=o>,</span><span class=s1>&#39;remove&#39;</span><span class=o>]</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x> </span><span class=cp>{{</span><span class=kp>_</span><span class=o>|</span><span class=nf>mandatory</span><span class=o>(</span><span class=s2>&#34;ACTION is mandatoy - push or remove&#34;</span><span class=o>)</span><span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>elif</span> <span class=nv>ACTION</span> <span class=o>==</span> <span class=s2>&#34;remove&#34;</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>interface range </span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>interface</span> <span class=k>in</span> <span class=nv>netlab_interfaces</span> <span class=k>if</span> <span class=nv>interface.type</span> <span class=p>!</span><span class=o>=</span> <span class=s1>&#39;loopback&#39;</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=nv>interface.ifname</span> <span class=o>+</span> <span class=s2>&#34; , &#34;</span> <span class=k>if</span> <span class=k>not</span> <span class=nb>loop</span><span class=nv>.last</span> <span class=k>else</span> <span class=nv>interface.ifname</span> <span class=cp>}}{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>  no ip flow monitor KENTIK sampler KENTIK input
</span></span></span><span class=line><span class=cl><span class=x> !
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>no sampler KENTIK
</span></span></span><span class=line><span class=cl><span class=x>no flow monitor KENTIK
</span></span></span><span class=line><span class=cl><span class=x>no flow exporter KENTIK
</span></span></span><span class=line><span class=cl><span class=x>no flow record KENTIK
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>elif</span> <span class=nv>ACTION</span> <span class=o>==</span> <span class=s2>&#34;push&#34;</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>flow record KENTIK
</span></span></span><span class=line><span class=cl><span class=x> match routing vrf input
</span></span></span><span class=line><span class=cl><span class=x> match ipv4 tos
</span></span></span><span class=line><span class=cl><span class=x> match ipv4 protocol
</span></span></span><span class=line><span class=cl><span class=x> match ipv4 source address
</span></span></span><span class=line><span class=cl><span class=x> match ipv4 destination address
</span></span></span><span class=line><span class=cl><span class=x> match transport source-port
</span></span></span><span class=line><span class=cl><span class=x> match transport destination-port
</span></span></span><span class=line><span class=cl><span class=x> match interface input
</span></span></span><span class=line><span class=cl><span class=x> collect routing source as
</span></span></span><span class=line><span class=cl><span class=x> collect routing destination as
</span></span></span><span class=line><span class=cl><span class=x> collect routing next-hop address ipv4
</span></span></span><span class=line><span class=cl><span class=x> collect transport tcp flags
</span></span></span><span class=line><span class=cl><span class=x> collect interface output
</span></span></span><span class=line><span class=cl><span class=x> collect counter bytes
</span></span></span><span class=line><span class=cl><span class=x> collect counter packets
</span></span></span><span class=line><span class=cl><span class=x> collect timestamp sys-uptime first
</span></span></span><span class=line><span class=cl><span class=x> collect timestamp sys-uptime last
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>flow exporter KENTIK
</span></span></span><span class=line><span class=cl><span class=x> destination </span><span class=cp>{{</span> <span class=nv>hostvars</span><span class=o>[</span><span class=s1>&#39;kproxy&#39;</span><span class=o>][</span><span class=s1>&#39;mgmt&#39;</span><span class=o>][</span><span class=s1>&#39;ipv4&#39;</span><span class=o>]</span> <span class=cp>}}</span><span class=x> vrf clab-mgmt
</span></span></span><span class=line><span class=cl><span class=x> source Ethernet0/0
</span></span></span><span class=line><span class=cl><span class=x> transport udp 9995
</span></span></span><span class="line hl"><span class=cl><span class=x> export-protocol netflow-v9
</span></span></span><span class=line><span class=cl><span class=x> template data timeout 60
</span></span></span><span class=line><span class=cl><span class=x> option interface-table
</span></span></span><span class=line><span class=cl><span class=x> option vrf-table
</span></span></span><span class=line><span class=cl><span class=x> option sampler-table
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>flow monitor KENTIK
</span></span></span><span class=line><span class=cl><span class=x> exporter KENTIK
</span></span></span><span class=line><span class=cl><span class=x> statistics packet protocol
</span></span></span><span class=line><span class=cl><span class=x> statistics packet size
</span></span></span><span class=line><span class=cl><span class=x> record KENTIK
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>sampler KENTIK
</span></span></span><span class=line><span class=cl><span class=x> mode random 1 out-of </span><span class=cp>{{</span> <span class=nv>KENTIK_SAMPLE_RATE</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>interface range </span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>interface</span> <span class=k>in</span> <span class=nv>netlab_interfaces</span> <span class=k>if</span> <span class=nv>interface.type</span> <span class=p>!</span><span class=o>=</span> <span class=s1>&#39;loopback&#39;</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=nv>interface.ifname</span> <span class=o>+</span> <span class=s2>&#34; , &#34;</span> <span class=k>if</span> <span class=k>not</span> <span class=nb>loop</span><span class=nv>.last</span> <span class=k>else</span> <span class=nv>interface.ifname</span> <span class=cp>}}{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>  ip flow monitor KENTIK sampler KENTIK input
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span></span></span></code></pre></div><div class=highlight title="Flexible IPFIX"><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=cp>{%</span> <span class=k>if</span> <span class=nv>ACTION</span> <span class=k>is</span> <span class=k>not</span> <span class=nf>defined</span> <span class=k>or</span> <span class=nv>ACTION</span> <span class=k>not</span> <span class=k>in</span> <span class=o>[</span><span class=s1>&#39;push&#39;</span><span class=o>,</span><span class=s1>&#39;remove&#39;</span><span class=o>]</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x> </span><span class=cp>{{</span><span class=kp>_</span><span class=o>|</span><span class=nf>mandatory</span><span class=o>(</span><span class=s2>&#34;ACTION is mandatoy - push or remove&#34;</span><span class=o>)</span><span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>elif</span> <span class=nv>ACTION</span> <span class=o>==</span> <span class=s2>&#34;remove&#34;</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>interface range </span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>interface</span> <span class=k>in</span> <span class=nv>netlab_interfaces</span> <span class=k>if</span> <span class=nv>interface.type</span> <span class=p>!</span><span class=o>=</span> <span class=s1>&#39;loopback&#39;</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=nv>interface.ifname</span> <span class=o>+</span> <span class=s2>&#34; , &#34;</span> <span class=k>if</span> <span class=k>not</span> <span class=nb>loop</span><span class=nv>.last</span> <span class=k>else</span> <span class=nv>interface.ifname</span> <span class=cp>}}{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>  no ip flow monitor KENTIK sampler KENTIK input
</span></span></span><span class=line><span class=cl><span class=x> !
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>no sampler KENTIK
</span></span></span><span class=line><span class=cl><span class=x>no flow monitor KENTIK
</span></span></span><span class=line><span class=cl><span class=x>no flow exporter KENTIK
</span></span></span><span class=line><span class=cl><span class=x>no flow record KENTIK
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>elif</span> <span class=nv>ACTION</span> <span class=o>==</span> <span class=s2>&#34;push&#34;</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>flow record KENTIK
</span></span></span><span class=line><span class=cl><span class=x> match routing vrf input
</span></span></span><span class=line><span class=cl><span class=x> match ipv4 tos
</span></span></span><span class=line><span class=cl><span class=x> match ipv4 protocol
</span></span></span><span class=line><span class=cl><span class=x> match ipv4 source address
</span></span></span><span class=line><span class=cl><span class=x> match ipv4 destination address
</span></span></span><span class=line><span class=cl><span class=x> match transport source-port
</span></span></span><span class=line><span class=cl><span class=x> match transport destination-port
</span></span></span><span class=line><span class=cl><span class=x> match interface input
</span></span></span><span class=line><span class=cl><span class=x> collect routing source as
</span></span></span><span class=line><span class=cl><span class=x> collect routing destination as
</span></span></span><span class=line><span class=cl><span class=x> collect routing next-hop address ipv4
</span></span></span><span class=line><span class=cl><span class=x> collect transport tcp flags
</span></span></span><span class=line><span class=cl><span class=x> collect interface output
</span></span></span><span class=line><span class=cl><span class=x> collect counter bytes
</span></span></span><span class=line><span class=cl><span class=x> collect counter packets
</span></span></span><span class=line><span class=cl><span class=x> collect timestamp sys-uptime first
</span></span></span><span class=line><span class=cl><span class=x> collect timestamp sys-uptime last
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>flow exporter KENTIK
</span></span></span><span class=line><span class=cl><span class=x> destination </span><span class=cp>{{</span> <span class=nv>hostvars</span><span class=o>[</span><span class=s1>&#39;kproxy&#39;</span><span class=o>][</span><span class=s1>&#39;mgmt&#39;</span><span class=o>][</span><span class=s1>&#39;ipv4&#39;</span><span class=o>]</span> <span class=cp>}}</span><span class=x> vrf clab-mgmt
</span></span></span><span class=line><span class=cl><span class=x> source Ethernet0/0
</span></span></span><span class=line><span class=cl><span class=x> transport udp 9995
</span></span></span><span class="line hl"><span class=cl><span class=x> export-protocol ipfix
</span></span></span><span class=line><span class=cl><span class=x> template data timeout 60
</span></span></span><span class=line><span class=cl><span class=x> option interface-table
</span></span></span><span class=line><span class=cl><span class=x> option vrf-table
</span></span></span><span class=line><span class=cl><span class=x> option sampler-table
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>flow monitor KENTIK
</span></span></span><span class=line><span class=cl><span class=x> exporter KENTIK
</span></span></span><span class=line><span class=cl><span class=x> statistics packet protocol
</span></span></span><span class=line><span class=cl><span class=x> statistics packet size
</span></span></span><span class=line><span class=cl><span class=x> record KENTIK
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>sampler KENTIK
</span></span></span><span class=line><span class=cl><span class=x> mode random 1 out-of </span><span class=cp>{{</span> <span class=nv>KENTIK_SAMPLE_RATE</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>interface range </span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>interface</span> <span class=k>in</span> <span class=nv>netlab_interfaces</span> <span class=k>if</span> <span class=nv>interface.type</span> <span class=p>!</span><span class=o>=</span> <span class=s1>&#39;loopback&#39;</span> -<span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{{</span> <span class=nv>interface.ifname</span> <span class=o>+</span> <span class=s2>&#34; , &#34;</span> <span class=k>if</span> <span class=k>not</span> <span class=nb>loop</span><span class=nv>.last</span> <span class=k>else</span> <span class=nv>interface.ifname</span> <span class=cp>}}{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>  ip flow monitor KENTIK sampler KENTIK input
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}</span></span></span></code></pre></div><p>All three templates include the respective <em>no</em> statements so you can provision them via the <code>netlab config</code> command and switch between them on the devices.</p><p>Now, last but not least, we have the BGP configuration. Kentik acts as a route reflector and we peer with the enabled address families via <strong>kbgp</strong> to send both tables from each device.</p><div class=highlight title="BGP Configuration"><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>ip prefix-list PL_HOSTS seq 5 permit 0.0.0.0/0 ge 32
</span></span></span><span class=line><span class=cl><span class=x>ip prefix-list PL_DEFAULT seq 5 permit 0.0.0.0/0
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>route-map RM_KENTIK_IN permit 5
</span></span></span><span class=line><span class=cl><span class=x>  match ip address prefix-list PL_HOSTS
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>route-map RM_KENTIK_OUT deny 5
</span></span></span><span class=line><span class=cl><span class=x>  match ip address prefix-list PL_DEFAULT
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>route-map RM_KENTIK_OUT permit 10
</span></span></span><span class=line><span class=cl><span class=x> set community </span><span class=cp>{{</span> <span class=nv>bgp.as</span> <span class=cp>}}</span><span class=x>:</span><span class=cp>{{</span> <span class=nv>id</span><span class=o>*</span><span class=m>100</span> <span class=cp>}}</span><span class=x> additive
</span></span></span><span class=line><span class=cl><span class=x> set extcommunity color </span><span class=cp>{{</span> <span class=nv>id</span><span class=o>+</span><span class=m>10</span> <span class=cp>}}</span><span class=x> additive
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>route-map RM_IBGP_OUT permit 5
</span></span></span><span class=line><span class=cl><span class=x> set community </span><span class=cp>{{</span> <span class=nv>bgp.as</span> <span class=cp>}}</span><span class=x>:</span><span class=cp>{{</span> <span class=nv>id</span><span class=o>*</span><span class=m>100</span> <span class=cp>}}</span><span class=x> additive
</span></span></span><span class=line><span class=cl><span class=x> set extcommunity color </span><span class=cp>{{</span> <span class=nv>id</span><span class=o>+</span><span class=m>10</span> <span class=cp>}}</span><span class=x> additive
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>router bgp </span><span class=cp>{{</span> <span class=nv>bgp.as</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    neighbor </span><span class=cp>{{</span> <span class=nv>hosts</span><span class=o>[</span><span class=s1>&#39;kbgp&#39;</span><span class=o>][</span><span class=s1>&#39;ipv4&#39;</span><span class=o>][</span><span class=m>0</span><span class=o>]</span> <span class=cp>}}</span><span class=x> remote-as </span><span class=cp>{{</span> <span class=nv>bgp.as</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    neighbor </span><span class=cp>{{</span> <span class=nv>hosts</span><span class=o>[</span><span class=s1>&#39;kbgp&#39;</span><span class=o>][</span><span class=s1>&#39;ipv4&#39;</span><span class=o>][</span><span class=m>0</span><span class=o>]</span> <span class=cp>}}</span><span class=x> description KENTIK
</span></span></span><span class=line><span class=cl><span class=x>    neighbor </span><span class=cp>{{</span> <span class=nv>hosts</span><span class=o>[</span><span class=s1>&#39;kbgp&#39;</span><span class=o>][</span><span class=s1>&#39;ipv4&#39;</span><span class=o>][</span><span class=m>0</span><span class=o>]</span> <span class=cp>}}</span><span class=x> update-source </span><span class=cp>{{</span> <span class=nv>loopback.ifname</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>address-family ipv4
</span></span></span><span class=line><span class=cl><span class=x>    neighbor </span><span class=cp>{{</span> <span class=nv>hosts</span><span class=o>[</span><span class=s1>&#39;kbgp&#39;</span><span class=o>][</span><span class=s1>&#39;ipv4&#39;</span><span class=o>][</span><span class=m>0</span><span class=o>]</span> <span class=cp>}}</span><span class=x> activate
</span></span></span><span class=line><span class=cl><span class=x>    neighbor </span><span class=cp>{{</span> <span class=nv>hosts</span><span class=o>[</span><span class=s1>&#39;kbgp&#39;</span><span class=o>][</span><span class=s1>&#39;ipv4&#39;</span><span class=o>][</span><span class=m>0</span><span class=o>]</span> <span class=cp>}}</span><span class=x> route-reflector-client
</span></span></span><span class=line><span class=cl><span class=x>    neighbor </span><span class=cp>{{</span> <span class=nv>hosts</span><span class=o>[</span><span class=s1>&#39;kbgp&#39;</span><span class=o>][</span><span class=s1>&#39;ipv4&#39;</span><span class=o>][</span><span class=m>0</span><span class=o>]</span> <span class=cp>}}</span><span class=x> route-map RM_KENTIK_IN in
</span></span></span><span class=line><span class=cl><span class=x>    neighbor </span><span class=cp>{{</span> <span class=nv>hosts</span><span class=o>[</span><span class=s1>&#39;kbgp&#39;</span><span class=o>][</span><span class=s1>&#39;ipv4&#39;</span><span class=o>][</span><span class=m>0</span><span class=o>]</span> <span class=cp>}}</span><span class=x> route-map RM_KENTIK_OUT out
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>nei</span> <span class=k>in</span> <span class=nv>bgp.neighbors</span> <span class=k>if</span> <span class=nv>nei.type</span> <span class=o>==</span> <span class=s1>&#39;ibgp&#39;</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>    neighbor </span><span class=cp>{{</span> <span class=nv>nei.ipv4</span> <span class=cp>}}</span><span class=x> route-map RM_IBGP_OUT out
</span></span></span><span class=line><span class=cl><span class=x></span><span class=cp>{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>!
</span></span></span><span class=line><span class=cl><span class=x>address-family vpnv4
</span></span></span><span class=line><span class=cl><span class=x>    neighbor </span><span class=cp>{{</span> <span class=nv>hosts</span><span class=o>[</span><span class=s1>&#39;kbgp&#39;</span><span class=o>][</span><span class=s1>&#39;ipv4&#39;</span><span class=o>][</span><span class=m>0</span><span class=o>]</span> <span class=cp>}}</span><span class=x> activate
</span></span></span><span class=line><span class=cl><span class=x>    neighbor </span><span class=cp>{{</span> <span class=nv>hosts</span><span class=o>[</span><span class=s1>&#39;kbgp&#39;</span><span class=o>][</span><span class=s1>&#39;ipv4&#39;</span><span class=o>][</span><span class=m>0</span><span class=o>]</span> <span class=cp>}}</span><span class=x> route-reflector-client
</span></span></span><span class=line><span class=cl><span class=x>!</span></span></span></code></pre></div><p>The BGP template is provisioned to the devices during lab bring up, so it is defined in the <code>config</code> section of the core devices.</p><p>You see now how we can leverage the ansible variables available to us to produce the appropriate configuration. So we define those <em>additional</em> variables in our topology file in the appropriate section.</p><div class="highlight no-header"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>groups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>core</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>members</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>rc1, rc2, rc3, rc4 ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>module</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>ospf, bgp, mpls, vrf ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bgp.as</span><span class=p>:</span><span class=w> </span><span class=m>65515</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mpls.vpn</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>ibgp ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vrf.loopback</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>config</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>core_extras, kentik_rrc ]</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class="line hl"><span class=cl><span class=w>      </span><span class=nt>KENTIK_SNMPV2_COMMUNITY</span><span class=p>:</span><span class=w> </span><span class=l>&lt; snmpv2 community &gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>KENTIK_SAMPLE_RATE</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>KENTIK_REGION</span><span class=p>:</span><span class=w> </span><span class=l>EU</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>KENTIK_PLAN_ID</span><span class=p>:</span><span class=w> </span><span class=l>&lt; Flow Plan for devices &gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>KENTIK_SITE_ID</span><span class=p>:</span><span class=w> </span><span class=l>&lt; Site to use for the devices &gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>KENTIK_NMS_AGENT_ID</span><span class=p>:</span><span class=w> </span><span class=l>&lt; NMS agent to use for polling devices &gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>KENTIK_NMS_CREDS_NAME</span><span class=p>:</span><span class=w> </span><span class=l>&lt; Credentials vault name &gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>KENTIK_API_TOKEN</span><span class=p>:</span><span class=w> </span><span class=l>&lt; Kentik User Token &gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>KENTIK_API_EMAIL</span><span class=p>:</span><span class=w> </span><span class=l>&lt; Kentik User Email &gt;</span></span></span></code></pre></div><p>We have defined some additional variables here that we do not use during <em>netlab</em> normal operations. The reason for this is that since <em>netlab</em> will create a full ansible structure for the lab, we can re-use this to run our own plays based on the inventory that <em>netlab</em> created. More on this in our next section.</p><h2 class=heading-element id=topology-bring-up-workflow><span>Topology Bring-Up Workflow</span>
<a href=#topology-bring-up-workflow class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>In this section we will cover the steps needed to bring up the LAB and start with our use-case. In a high-level here are the steps needed to accomplish this:</p><ol><li>Register the NMS agent</li><li>Register the networking devices in the portal</li><li>Bring Up the LAB</li><li>Enable the desired netflow export</li><li>Enable traffic</li><li>Register the ksynth agents</li></ol><p>In addition, here are the additional variables we are using in the topology file along with their description and their requirement for the above steps</p><table><thead><tr><th>VARIABLE</th><th>USED IN</th><th>DESCRIPTION</th></tr></thead><tbody><tr><td>KENTIK_SNMPV2_COMMUNITY</td><td>2,3</td><td>SNMPv2 community used to poll the devices</td></tr><tr><td>KENTIK_SAMPLE_RATE</td><td>2,4</td><td>Netflow sample rate configured on the devices and in the portal</td></tr><tr><td>KENTIK_REGION</td><td>2,3</td><td>Portal Account region - US or EU</td></tr><tr><td>KENTIK_PLAN_ID</td><td>2</td><td>Portal flow plan to put the devices in</td></tr><tr><td>KENTIK_SITE_ID</td><td>2</td><td>Portal site to put the devices in</td></tr><tr><td>KENTIK_NMS_AGENT_ID</td><td>2</td><td>NMS agent to poll the devices</td></tr><tr><td>KENTIK_NMS_CREDS_NAME</td><td>2</td><td>Portal credential vault having the snmp community</td></tr><tr><td>KENTIK_API_TOKEN</td><td>2,3</td><td>Portal API token to authenticate to Kentik</td></tr><tr><td>KENTIK_API_EMAIL</td><td>2,3</td><td>Portal Email account to authenticate to Kentik</td></tr><tr><td>IPERF3_TESTS</td><td>3,5</td><td>List of dictionaries describing the iperf3 tests</td></tr></tbody></table><h3 class=heading-element id=1-register-nms-agent><span>1. Register NMS Agent</span>
<a href=#1-register-nms-agent class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>This an once-off action and it is decoupled from <em>netlab</em>. We just need to run the <strong>kagent</strong> and register it in the portal. This will allow us to get the <code>AGENT_ID</code> for the next step.</p><p>So, using the docker compose we bring up the agent and then access the portal to activate it and get the ID.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· docker compose up -d
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Running 2/2
</span></span><span class=line><span class=cl> ✔ Volume <span class=s2>&#34;iol_kagent-data&#34;</span>  Created                                                         0.0s
</span></span><span class=line><span class=cl> ✔ Container kagent          Started                                                         0.2s</span></span></code></pre></div><p>In addition we can assign the agent to an existing site or create a new one in the portal that we will use for our LAB. This will also give us the <code>SITE_ID</code> variable for the next step.</p><h3 class=heading-element id=2-register-devices-in-the-portal><span>2. Register Devices in the Portal</span>
<a href=#2-register-devices-in-the-portal class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>This is again an once-off task and we could do it manually, but since <em>netlab</em> is able to give us an ansible inventory structure out of the topology file we can use this and create the devices via Kentik&rsquo;s device API in our own playbook.</p><p>Here is a playbook that accomplishes this task:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Kentik Device Onboarding&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>core</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>KENTIK_API_URL</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://grpc.api.kentik.{{ KENTIK_REGION|lower }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>KENTIK_DEVICE_API</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ KENTIK_API_URL }}/device/v202308beta1/device/&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>KENTIK_HEADERS</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>X-CH-Auth-API-Token</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ KENTIK_API_TOKEN }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>X-CH-Auth-Email</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ KENTIK_API_EMAIL }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>Content-Type</span><span class=p>:</span><span class=w> </span><span class=l>application/json</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Get Current Devices</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>uri</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ KENTIK_DEVICE_API }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>method</span><span class=p>:</span><span class=w> </span><span class=l>GET</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>headers</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ KENTIK_HEADERS }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>status_code</span><span class=p>:</span><span class=w> </span><span class=m>200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>devices    </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run_once</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Skipped Devices</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Device name or IP addresses already existed in portal&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;netlab_name+&#39;-&#39;+hostname in devices.json | json_query(&#39;devices[].deviceName&#39;)
</span></span></span><span class=line><span class=cl><span class=s2>          or mgmt.ipv4 in devices.json | json_query(&#39;devices[].sendingIps[]&#39;)
</span></span></span><span class=line><span class=cl><span class=s2>          or bgp.router_id in devices.json | json_query(&#39;devices[].deviceBgpNeighborIp&#39;)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Create Device OR Skip If Exists</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>block</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Create Device Call</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ansible.builtin.uri</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ KENTIK_DEVICE_API }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>method</span><span class=p>:</span><span class=w> </span><span class=l>POST</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>headers</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ KENTIK_HEADERS }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>status_code</span><span class=p>:</span><span class=w> </span><span class=m>200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>body</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;ansible.builtin.template&#39;,&#39;templates/kentik_device.j2&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>body_format</span><span class=p>:</span><span class=w> </span><span class=l>json</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=m>60</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>device_created</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>throttle</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Devices Created</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>debug</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Device created with id: {{ device_created.json.device.id }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>rescue</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Cannot Create Device</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Failed to create device: {{ device_created.json.message }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;netlab_name+&#39;-&#39;+hostname not in devices.json | json_query(&#39;devices[].deviceName&#39;)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;mgmt.ipv4 not in devices.json | json_query(&#39;devices[].sendingIps[]&#39;)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;bgp.router_id not in devices.json | json_query(&#39;devices[].deviceBgpNeighborIp&#39;)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span></span></span></code></pre></div><p>We are using the built in <code>uri</code> module to interact with the API and create the devices we are interested in, i.e. the <code>core</code> devices. The playbook will check if there is any existing device with the same name or having any relevant IP that we use in our LAB, and if not it will create the device in the portal.</p><p>The <em>json</em> payload is templated and looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;device&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;deviceName&#34;</span><span class=p>:</span> <span class=s2>&#34;{{ netlab_name }}-{{ hostname }}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;deviceDescription&#34;</span><span class=p>:</span> <span class=s2>&#34;Device {{ id }} of type {{ netlab_device_type}} using {{ netlab_provider}} provider.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;deviceSubtype&#34;</span><span class=p>:</span> <span class=s2>&#34;router&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;sendingIps&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;{{ mgmt.ipv4}}&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;deviceSampleRate&#34;</span><span class=p>:</span> <span class=s2>&#34;{{ KENTIK_SAMPLE_RATE }}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;planId&#34;</span><span class=p>:</span> <span class=p>{</span><span class=err>{</span> <span class=err>KENTIK_PLAN_ID</span> <span class=p>}},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;siteId&#34;</span><span class=p>:</span> <span class=p>{</span><span class=err>{</span> <span class=err>KENTIK_SITE_ID</span> <span class=p>}}</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;minimizeSnmp&#34;</span><span class=err>:</span> <span class=kc>false</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;deviceSnmpIp&#34;</span><span class=err>:</span> <span class=s2>&#34;{{ mgmt.ipv4}}&#34;</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;deviceSnmpCommunity&#34;</span><span class=err>:</span> <span class=s2>&#34;{{ KENTIK_SNMPV2_COMMUNITY }}&#34;</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;deviceBgpType&#34;</span><span class=err>:</span> <span class=s2>&#34;device&#34;</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;deviceBgpNeighborIp&#34;</span><span class=err>:</span> <span class=s2>&#34;{{ bgp.router_id }}&#34;</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;deviceBgpNeighborAsn&#34;</span><span class=err>:</span> <span class=s2>&#34;{{ bgp.as }}&#34;</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;nms&#34;</span><span class=err>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;agentId&#34;</span><span class=p>:</span> <span class=s2>&#34;{{ KENTIK_NMS_AGENT_ID }}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;ipAddress&#34;</span><span class=p>:</span> <span class=s2>&#34;{{ mgmt.ipv4 }}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;snmp&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;credentialName&#34;</span><span class=p>:</span> <span class=s2>&#34;{{ KENTIK_NMS_CREDS_NAME }}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=err>}</span>
</span></span><span class=line><span class=cl><span class=err>}</span></span></span></code></pre></div><p>So we are going to need to provide the remaining values for the variables used in our topology file and once all variables are filled in, we can execute the <code>netlab create</code> command in order for the ansible inventory to be produced.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· netlab create
</span></span><span class=line><span class=cl><span class=o>[</span>CREATED<span class=o>]</span> provider configuration file: clab.yml
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/kproxy/hosts to kproxy:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/ksynth1/hosts to ksynth1:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/ksynth2/hosts to ksynth2:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/ksynth3/hosts to ksynth3:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/ksynth4/hosts to ksynth4:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/kbgp/hosts to kbgp:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/pc1/hosts to pc1:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/pc2/hosts to pc2:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/pc3/hosts to pc3:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/pc4/hosts to pc4:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/pc11/hosts to pc11:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/pc12/hosts to pc12:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/pc13/hosts to pc13:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>MAPPED<span class=o>]</span>  clab_files/pc14/hosts to pc14:/etc/hosts <span class=o>(</span>from templates/provider/clab/linux/hosts.j2<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>CREATED<span class=o>]</span> transformed topology dump in YAML format in netlab.snapshot.yml
</span></span><span class=line><span class=cl><span class=o>[</span>GROUPS<span class=o>]</span>  group_vars <span class=k>for</span> all
</span></span><span class=line><span class=cl><span class=o>[</span>GROUPS<span class=o>]</span>  group_vars <span class=k>for</span> modules
</span></span><span class=line><span class=cl><span class=o>[</span>GROUPS<span class=o>]</span>  group_vars <span class=k>for</span> custom_configs
</span></span><span class=line><span class=cl><span class=o>[</span>GROUPS<span class=o>]</span>  group_vars <span class=k>for</span> iol
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> rc1
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> rc2
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> rc3
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> rc4
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> ce1
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> ce2
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> ce3
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> ce4
</span></span><span class=line><span class=cl><span class=o>[</span>GROUPS<span class=o>]</span>  group_vars <span class=k>for</span> linux
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> kproxy
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> ksynth1
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> ksynth2
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> ksynth3
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> ksynth4
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> kbgp
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> pc1
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> pc2
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> pc3
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> pc4
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> pc11
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> pc12
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> pc13
</span></span><span class=line><span class=cl><span class=o>[</span>HOSTS<span class=o>]</span>   host_vars <span class=k>for</span> pc14
</span></span><span class=line><span class=cl><span class=o>[</span>GROUPS<span class=o>]</span>  group_vars <span class=k>for</span> core
</span></span><span class=line><span class=cl><span class=o>[</span>GROUPS<span class=o>]</span>  group_vars <span class=k>for</span> pcs
</span></span><span class=line><span class=cl><span class=o>[</span>CREATED<span class=o>]</span> minimized Ansible inventory hosts.yml
</span></span><span class=line><span class=cl><span class=o>[</span>CREATED<span class=o>]</span> Ansible configuration file: ansible.cfg</span></span></code></pre></div><p>Now we can run our playbook to onboard the core devices into Kentik.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· <span class=nv>ANSIBLE_NOCOWS</span><span class=o>=</span><span class=m>1</span> ansible-playbook kentik.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PLAY <span class=o>[</span>Kentik Device Onboarding<span class=o>]</span> *******************************************************************************************
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>Get Current Devices<span class=o>]</span> ************************************************************************************************
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>rc1 -&gt; localhost<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>Skipped Devices<span class=o>]</span> ****************************************************************************************************
</span></span><span class=line><span class=cl>skipping: <span class=o>[</span>rc1<span class=o>]</span>
</span></span><span class=line><span class=cl>skipping: <span class=o>[</span>rc2<span class=o>]</span>
</span></span><span class=line><span class=cl>skipping: <span class=o>[</span>rc3<span class=o>]</span>
</span></span><span class=line><span class=cl>skipping: <span class=o>[</span>rc4<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>Create Device Call<span class=o>]</span> *************************************************************************************************
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>rc1 -&gt; localhost<span class=o>]</span>
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>rc2 -&gt; localhost<span class=o>]</span>
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>rc3 -&gt; localhost<span class=o>]</span>
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>rc4 -&gt; localhost<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>Devices Created<span class=o>]</span> ****************************************************************************************************
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>rc1 -&gt; localhost<span class=o>]</span> <span class=o>=</span>&gt;
</span></span><span class=line><span class=cl>  msg: <span class=s1>&#39;Device created with id: 115531&#39;</span>
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>rc2 -&gt; localhost<span class=o>]</span> <span class=o>=</span>&gt;
</span></span><span class=line><span class=cl>  msg: <span class=s1>&#39;Device created with id: 115536&#39;</span>
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>rc3 -&gt; localhost<span class=o>]</span> <span class=o>=</span>&gt;
</span></span><span class=line><span class=cl>  msg: <span class=s1>&#39;Device created with id: 115541&#39;</span>
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>rc4 -&gt; localhost<span class=o>]</span> <span class=o>=</span>&gt;
</span></span><span class=line><span class=cl>  msg: <span class=s1>&#39;Device created with id: 115546&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PLAY RECAP ****************************************************************************************************************
</span></span><span class=line><span class=cl>rc1                        : <span class=nv>ok</span><span class=o>=</span><span class=m>3</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>1</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>rc2                        : <span class=nv>ok</span><span class=o>=</span><span class=m>2</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>1</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>rc3                        : <span class=nv>ok</span><span class=o>=</span><span class=m>2</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>1</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>rc4                        : <span class=nv>ok</span><span class=o>=</span><span class=m>2</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>1</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span></span></span></code></pre></div><h3 class=heading-element id=3-bring-up-the-lab><span>3. Bring Up the LAB</span>
<a href=#3-bring-up-the-lab class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>We are ready now to bring up the topology. We have seen that during <code>netlab create</code> <em>netlab</em> will create the required <em>containerlab</em> topology file and populate our ansible inventory with the appropriate files and values. Using the <code>netlab up</code> command it will execute the create phase as well as spin up the nodes and start provisioning them with the appropriate configurations we defined in the topology file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· <span class=nv>ANSIBLE_NOCOWS</span><span class=o>=</span><span class=m>1</span> netlab up
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt; snipped &gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PLAY RECAP ****************************************************************************************************************
</span></span><span class=line><span class=cl>ce1                        : <span class=nv>ok</span><span class=o>=</span><span class=m>25</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>4</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>14</span>   <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>ce2                        : <span class=nv>ok</span><span class=o>=</span><span class=m>24</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>14</span>   <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>ce3                        : <span class=nv>ok</span><span class=o>=</span><span class=m>24</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>14</span>   <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>ce4                        : <span class=nv>ok</span><span class=o>=</span><span class=m>24</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>14</span>   <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>kbgp                       : <span class=nv>ok</span><span class=o>=</span><span class=m>11</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>2</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>kproxy                     : <span class=nv>ok</span><span class=o>=</span><span class=m>11</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>2</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>ksynth1                    : <span class=nv>ok</span><span class=o>=</span><span class=m>11</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>2</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>ksynth2                    : <span class=nv>ok</span><span class=o>=</span><span class=m>11</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>2</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>ksynth3                    : <span class=nv>ok</span><span class=o>=</span><span class=m>11</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>2</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>ksynth4                    : <span class=nv>ok</span><span class=o>=</span><span class=m>11</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>2</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc1                        : <span class=nv>ok</span><span class=o>=</span><span class=m>19</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>5</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>5</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc11                       : <span class=nv>ok</span><span class=o>=</span><span class=m>19</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>5</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>5</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc12                       : <span class=nv>ok</span><span class=o>=</span><span class=m>19</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>5</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>5</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc13                       : <span class=nv>ok</span><span class=o>=</span><span class=m>19</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>5</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>5</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc14                       : <span class=nv>ok</span><span class=o>=</span><span class=m>19</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>5</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>5</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc2                        : <span class=nv>ok</span><span class=o>=</span><span class=m>19</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>5</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>5</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc3                        : <span class=nv>ok</span><span class=o>=</span><span class=m>19</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>5</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>5</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc4                        : <span class=nv>ok</span><span class=o>=</span><span class=m>19</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>5</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>5</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>rc1                        : <span class=nv>ok</span><span class=o>=</span><span class=m>48</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>8</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>11</span>   <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>rc2                        : <span class=nv>ok</span><span class=o>=</span><span class=m>48</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>8</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>11</span>   <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>rc3                        : <span class=nv>ok</span><span class=o>=</span><span class=m>48</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>8</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>11</span>   <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>rc4                        : <span class=nv>ok</span><span class=o>=</span><span class=m>48</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>8</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>11</span>   <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>SUCCESS<span class=o>]</span> Lab devices configured
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· netlab status
</span></span><span class=line><span class=cl>Lab default in /home/netlab/iol
</span></span><span class=line><span class=cl>  status: started
</span></span><span class=line><span class=cl>  provider<span class=o>(</span>s<span class=o>)</span>: clab
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┏━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┓
</span></span><span class=line><span class=cl>┃ node    ┃ device ┃ image                       ┃ mgmt IPv4       ┃ connection  ┃ provider ┃ VM/container ┃ status       ┃
</span></span><span class=line><span class=cl>┡━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━┩
</span></span><span class=line><span class=cl>│ ce1     │ iol    │ vrnetlab/cisco_iol:17.12.1  │ 192.168.121.111 │ network_cli │ clab     │ ce1          │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ ce2     │ iol    │ vrnetlab/cisco_iol:17.12.1  │ 192.168.121.112 │ network_cli │ clab     │ ce2          │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ ce3     │ iol    │ vrnetlab/cisco_iol:17.12.1  │ 192.168.121.113 │ network_cli │ clab     │ ce3          │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ ce4     │ iol    │ vrnetlab/cisco_iol:17.12.1  │ 192.168.121.114 │ network_cli │ clab     │ ce4          │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ kbgp    │ linux  │ ghcr.io/srl-labs/network-m… │ 192.168.121.110 │ docker      │ clab     │ kbgp         │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ kproxy  │ linux  │ ghcr.io/srl-labs/network-m… │ 192.168.121.105 │ docker      │ clab     │ kproxy       │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ ksynth1 │ linux  │ ghcr.io/srl-labs/network-m… │ 192.168.121.106 │ docker      │ clab     │ ksynth1      │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ ksynth2 │ linux  │ ghcr.io/srl-labs/network-m… │ 192.168.121.107 │ docker      │ clab     │ ksynth2      │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ ksynth3 │ linux  │ ghcr.io/srl-labs/network-m… │ 192.168.121.108 │ docker      │ clab     │ ksynth3      │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ ksynth4 │ linux  │ ghcr.io/srl-labs/network-m… │ 192.168.121.109 │ docker      │ clab     │ ksynth4      │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ pc1     │ linux  │ ghcr.io/srl-labs/network-m… │ 192.168.121.115 │ docker      │ clab     │ pc1          │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ pc11    │ linux  │ ghcr.io/srl-labs/network-m… │ 192.168.121.119 │ docker      │ clab     │ pc11         │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ pc12    │ linux  │ ghcr.io/srl-labs/network-m… │ 192.168.121.120 │ docker      │ clab     │ pc12         │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ pc13    │ linux  │ ghcr.io/srl-labs/network-m… │ 192.168.121.121 │ docker      │ clab     │ pc13         │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ pc14    │ linux  │ ghcr.io/srl-labs/network-m… │ 192.168.121.122 │ docker      │ clab     │ pc14         │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ pc2     │ linux  │ ghcr.io/srl-labs/network-m… │ 192.168.121.116 │ docker      │ clab     │ pc2          │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ pc3     │ linux  │ ghcr.io/srl-labs/network-m… │ 192.168.121.117 │ docker      │ clab     │ pc3          │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ pc4     │ linux  │ ghcr.io/srl-labs/network-m… │ 192.168.121.118 │ docker      │ clab     │ pc4          │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ rc1     │ iol    │ vrnetlab/cisco_iol:17.12.1  │ 192.168.121.101 │ network_cli │ clab     │ rc1          │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ rc2     │ iol    │ vrnetlab/cisco_iol:17.12.1  │ 192.168.121.102 │ network_cli │ clab     │ rc2          │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ rc3     │ iol    │ vrnetlab/cisco_iol:17.12.1  │ 192.168.121.103 │ network_cli │ clab     │ rc3          │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>├─────────┼────────┼─────────────────────────────┼─────────────────┼─────────────┼──────────┼──────────────┼──────────────┤
</span></span><span class=line><span class=cl>│ rc4     │ iol    │ vrnetlab/cisco_iol:17.12.1  │ 192.168.121.104 │ network_cli │ clab     │ rc4          │ Up <span class=m>3</span> minutes │
</span></span><span class=line><span class=cl>└─────────┴────────┴─────────────────────────────┴─────────────────┴─────────────┴──────────┴──────────────┴──────────────┘</span></span></code></pre></div><p>Here are some connectivity tests and also notice the bitrates:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· netlab <span class=nb>exec</span> pc1 iperf3 -c pc4
</span></span><span class=line><span class=cl>Connecting to container pc1, executing iperf3 -c pc4
</span></span><span class=line><span class=cl>Connecting to host pc4, port <span class=m>5201</span>
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span> <span class=nb>local</span> 172.16.0.15 port <span class=m>42090</span> connected to 172.16.3.18 port <span class=m>5201</span>
</span></span><span class=line><span class=cl><span class=o>[</span> ID<span class=o>]</span> Interval           Transfer     Bitrate         Retr  Cwnd
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   0.00-1.00   sec  32.5 MBytes   <span class=m>273</span> Mbits/sec  <span class=m>498</span>   14.1 KBytes
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   1.00-2.00   sec  30.1 MBytes   <span class=m>252</span> Mbits/sec  <span class=m>457</span>   14.1 KBytes
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   2.00-3.00   sec  30.7 MBytes   <span class=m>258</span> Mbits/sec  <span class=m>475</span>   12.7 KBytes
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   3.00-4.00   sec  28.0 MBytes   <span class=m>235</span> Mbits/sec  <span class=m>438</span>   14.1 KBytes
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   4.00-5.00   sec  29.4 MBytes   <span class=m>247</span> Mbits/sec  <span class=m>458</span>   14.1 KBytes
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   5.00-6.00   sec  29.8 MBytes   <span class=m>250</span> Mbits/sec  <span class=m>483</span>   8.46 KBytes
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   6.00-7.00   sec  28.5 MBytes   <span class=m>239</span> Mbits/sec  <span class=m>494</span>   22.6 KBytes
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   7.00-8.00   sec  28.4 MBytes   <span class=m>239</span> Mbits/sec  <span class=m>537</span>   11.3 KBytes
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   8.00-9.00   sec  25.2 MBytes   <span class=m>212</span> Mbits/sec  <span class=m>410</span>   14.1 KBytes
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   9.00-10.00  sec  24.0 MBytes   <span class=m>201</span> Mbits/sec  <span class=m>476</span>   14.1 KBytes
</span></span><span class=line><span class=cl>- - - - - - - - - - - - - - - - - - - - - - - - -
</span></span><span class=line><span class=cl><span class=o>[</span> ID<span class=o>]</span> Interval           Transfer     Bitrate         Retr
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   0.00-10.00  sec   <span class=m>287</span> MBytes   <span class=m>241</span> Mbits/sec  <span class=m>4726</span>             sender
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   0.00-10.00  sec   <span class=m>286</span> MBytes   <span class=m>240</span> Mbits/sec                  receiver
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>iperf Done.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· netlab <span class=nb>exec</span> pc11 iperf3 -c pc14
</span></span><span class=line><span class=cl>Connecting to container pc11, executing iperf3 -c pc14
</span></span><span class=line><span class=cl>Connecting to host pc14, port <span class=m>5201</span>
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span> <span class=nb>local</span> 172.16.9.19 port <span class=m>43696</span> connected to 172.16.12.22 port <span class=m>5201</span>
</span></span><span class=line><span class=cl><span class=o>[</span> ID<span class=o>]</span> Interval           Transfer     Bitrate         Retr  Cwnd
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   0.00-1.00   sec  10.5 MBytes  88.2 Mbits/sec  <span class=m>259</span>   14.1 KBytes
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   1.00-2.00   sec  10.5 MBytes  88.1 Mbits/sec  <span class=m>257</span>   12.7 KBytes
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   2.00-3.00   sec  11.1 MBytes  93.3 Mbits/sec  <span class=m>243</span>   14.1 KBytes
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   3.00-4.00   sec  10.6 MBytes  89.2 Mbits/sec  <span class=m>258</span>   15.5 KBytes
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   4.00-5.00   sec  11.4 MBytes  95.4 Mbits/sec  <span class=m>254</span>   12.7 KBytes
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   5.00-6.00   sec  10.5 MBytes  88.1 Mbits/sec  <span class=m>252</span>   14.1 KBytes
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   6.00-7.00   sec  11.1 MBytes  93.3 Mbits/sec  <span class=m>233</span>   14.1 KBytes
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   7.00-8.00   sec  12.0 MBytes   <span class=m>101</span> Mbits/sec  <span class=m>276</span>   14.1 KBytes
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   8.00-9.00   sec  11.5 MBytes  96.4 Mbits/sec  <span class=m>214</span>   19.7 KBytes
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   9.00-10.00  sec  11.4 MBytes  95.4 Mbits/sec  <span class=m>247</span>   15.5 KBytes
</span></span><span class=line><span class=cl>- - - - - - - - - - - - - - - - - - - - - - - - -
</span></span><span class=line><span class=cl><span class=o>[</span> ID<span class=o>]</span> Interval           Transfer     Bitrate         Retr
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   0.00-10.00  sec   <span class=m>111</span> MBytes  92.8 Mbits/sec  <span class=m>2493</span>             sender
</span></span><span class=line><span class=cl><span class=o>[</span>  5<span class=o>]</span>   0.00-10.00  sec   <span class=m>110</span> MBytes  92.6 Mbits/sec                  receiver
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>iperf Done.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· netlab <span class=nb>exec</span> pc11 mtr pc14 -r
</span></span><span class=line><span class=cl>Connecting to container pc11, executing mtr pc14 -r
</span></span><span class=line><span class=cl>Start: 2024-12-07T18:02:20+0000
</span></span><span class=line><span class=cl>HOST: pc11                        Loss%   Snt   Last   Avg  Best  Wrst StDev
</span></span><span class=line><span class=cl>  1.<span class=p>|</span>-- Ethernet0-2.ce1            0.0%    <span class=m>10</span>    0.5   0.6   0.5   0.7   0.1
</span></span><span class=line><span class=cl>  2.<span class=p>|</span>-- Ethernet1-2.blue.rc1       0.0%    <span class=m>10</span>    0.7   1.2   0.7   1.8   0.4
</span></span><span class=line><span class=cl>  3.<span class=p>|</span>-- Ethernet0-1.rc2            0.0%    <span class=m>10</span>    2.2   3.0   2.2   3.6   0.4
</span></span><span class=line><span class=cl>  4.<span class=p>|</span>-- Ethernet1-1.blue.rc4       0.0%    <span class=m>10</span>    2.4   2.4   1.9   3.0   0.3
</span></span><span class=line><span class=cl>  5.<span class=p>|</span>-- Ethernet0-1.ce4            0.0%    <span class=m>10</span>    1.4   2.7   1.4   3.5   0.8
</span></span><span class=line><span class=cl>  6.<span class=p>|</span>-- pc14                       0.0%    <span class=m>10</span>    1.5   2.6   1.5   3.9   0.8</span></span></code></pre></div><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fa-fw fa-regular fa-lightbulb" aria-hidden=true></i>Tip<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>host resolution works by default since <em>netlab</em> takes care of that by producing a <code>hosts</code> file, attaching it into the linux containers, and provisions all hosts in the network devices as well. How cool is that!!!</div></div></div><h3 class=heading-element id=4-enable-netflow><span>4. Enable Netflow</span>
<a href=#4-enable-netflow class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>So now that we have our test network ready, we can enable netflow on the core routers by choosing our netflow flavour and provision the respective commands via the <code>netlab config</code> command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· <span class=nv>ANSIBLE_NOCOWS</span><span class=o>=</span><span class=m>1</span> netlab config kentik_flow -l core -e <span class=nv>ACTION</span><span class=o>=</span>push
</span></span><span class=line><span class=cl>&lt; snipped &gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PLAY RECAP ****************************************************************************************************************
</span></span><span class=line><span class=cl>rc1                        : <span class=nv>ok</span><span class=o>=</span><span class=m>7</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>1</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>4</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>rc2                        : <span class=nv>ok</span><span class=o>=</span><span class=m>7</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>1</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>3</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>rc3                        : <span class=nv>ok</span><span class=o>=</span><span class=m>7</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>1</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>3</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>rc4                        : <span class=nv>ok</span><span class=o>=</span><span class=m>7</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>1</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>3</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span></span></span></code></pre></div><p>We can use this method to re-configure any other flow configuration ad-hoc by leveraging the <code>ACTION</code> variable.</p><p>Let&rsquo;s check on the kproxy after a while to see that all devices are sending flows and are correctly registered with the portal:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· telnet kproxy <span class=m>9996</span>
</span></span><span class=line><span class=cl>Trying 192.168.121.105...
</span></span><span class=line><span class=cl>Connected to kproxy.
</span></span><span class=line><span class=cl>Escape character is <span class=s1>&#39;^]&#39;</span>.
</span></span><span class=line><span class=cl>GOOD
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>4</span> Connected Devices
</span></span><span class=line><span class=cl>* 29118:iol-rc3:115541 -&gt; 0.0.0.0:40016 <span class=o>(</span>In1: 0.116060, Out1: 0.108333, In15: 0.191401, Out15: 0.009772<span class=o>)</span>. Last seen 2024-12-07T18:17:32.509264 <span class=o>(</span>8.195s ago<span class=o>)</span>. Sources: 192.168.121.103. Channel highwater: 0, 0, 0. Flow: netflow.v9
</span></span><span class=line><span class=cl>* 29118:iol-rc1:115531 -&gt; 0.0.0.0:40010 <span class=o>(</span>In1: 0.119930, Out1: 0.081798, In15: 0.191431, Out15: 0.008598<span class=o>)</span>. Last seen 2024-12-07T18:17:35.463030 <span class=o>(</span>7.186s ago<span class=o>)</span>. Sources: 192.168.121.101. Channel highwater: 0, 0, 0. Flow: netflow.v9
</span></span><span class=line><span class=cl>* 29118:iol-rc2:115536 -&gt; 0.0.0.0:40012 <span class=o>(</span>In1: 0.094682, Out1: 0.027546, In15: 0.189246, Out15: 0.003203<span class=o>)</span>. Last seen 2024-12-07T18:17:28.505189 <span class=o>(</span>12.199s ago<span class=o>)</span>. Sources: 192.168.121.102. Channel highwater: 0, 0, 0. Flow: netflow.v9
</span></span><span class=line><span class=cl>* 29118:iol-rc4:115546 -&gt; 0.0.0.0:40014 <span class=o>(</span>In1: 0.102966, Out1: 0.108333, In15: 0.190311, Out15: 0.009772<span class=o>)</span>. Last seen 2024-12-07T18:17:19.681646 <span class=o>(</span>21.022s ago<span class=o>)</span>. Sources: 192.168.121.104. Channel highwater: 0, 0, 0. Flow: netflow.v9
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>0</span> Unregistered Devices
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Connection closed by foreign host.</span></span></code></pre></div><h3 class=heading-element id=5-enable-traffic><span>5. Enable Traffic</span>
<a href=#5-enable-traffic class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>Our <code>PC's</code> are already listening to the appropriate ports for the traffic tests, so we can run the clients using the respective template:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>·&gt;&gt; <span class=nv>ANSIBLE_NOCOWS</span><span class=o>=</span><span class=m>1</span> netlab config iperf3_clients -l pcs -e <span class=nv>ACTION</span><span class=o>=</span>run
</span></span><span class=line><span class=cl>&lt; snipped &gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PLAY RECAP ****************************************************************************************************************
</span></span><span class=line><span class=cl>pc1                        : <span class=nv>ok</span><span class=o>=</span><span class=m>9</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>4</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc11                       : <span class=nv>ok</span><span class=o>=</span><span class=m>9</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>3</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc12                       : <span class=nv>ok</span><span class=o>=</span><span class=m>9</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>3</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc13                       : <span class=nv>ok</span><span class=o>=</span><span class=m>9</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>3</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc14                       : <span class=nv>ok</span><span class=o>=</span><span class=m>9</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>3</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc2                        : <span class=nv>ok</span><span class=o>=</span><span class=m>9</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>3</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc3                        : <span class=nv>ok</span><span class=o>=</span><span class=m>9</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>3</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>pc4                        : <span class=nv>ok</span><span class=o>=</span><span class=m>9</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>3</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>3</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span></span></span></code></pre></div><p>The same applies to this step as well. We can stop, start and reconfigure the test parameters in our template at any point using the appropriate <code>ACTION</code> value.</p><p>Here are some outputs from the devices:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>&lt;&lt;· netlab <span class=nb>exec</span> rc1 sh int e0/3 <span class=se>\|</span> i rate
</span></span><span class=line><span class=cl>Connecting to rc1 using SSH port 22, executing sh int e0/3 <span class=p>|</span> i rate
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  Queueing strategy: fifo
</span></span><span class=line><span class=cl>  <span class=m>5</span> minute input rate <span class=m>32387000</span> bits/sec, <span class=m>3279</span> packets/sec
</span></span><span class=line><span class=cl>  <span class=m>5</span> minute output rate <span class=m>16295000</span> bits/sec, <span class=m>2494</span> packets/sec
</span></span><span class=line><span class=cl>Connection to rc1 closed by remote host.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>·&gt;&gt; netlab <span class=nb>exec</span> ce2 sh int e0/1 <span class=se>\|</span> i rate
</span></span><span class=line><span class=cl>Connecting to ce2 using SSH port 22, executing sh int e0/1 <span class=p>|</span> i rate
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  Queueing strategy: fifo
</span></span><span class=line><span class=cl>  <span class=m>5</span> minute input rate <span class=m>21226000</span> bits/sec, <span class=m>2532</span> packets/sec
</span></span><span class=line><span class=cl>  <span class=m>5</span> minute output rate <span class=m>22546000</span> bits/sec, <span class=m>2651</span> packets/sec
</span></span><span class=line><span class=cl>Connection to ce2 closed by remote host.</span></span></code></pre></div><p>And here is how it looks in Kentik</p><figure><a class=lightgallery href=/posts/iou-love/traffic.png title=/posts/iou-love/traffic.png data-thumbnail=/posts/iou-love/traffic.png data-sub-html="<h2>Top Device by Average bits/s</h2>"><img loading=lazy src=/posts/iou-love/traffic.png alt=/posts/iou-love/traffic.png height=739 width=2023></a><figcaption class=image-caption>Top Device by Average bits/s</figcaption></figure><h3 class=heading-element id=6-register-synthetics-agents><span>6. Register Synthetics Agents</span>
<a href=#6-register-synthetics-agents class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>Now for the last step, the <code>ksynth</code> agents, on their first run they will initialise and appear in the portal as <code>Pending</code> until they are activated. We need to activate them in the portal, assign them to the site we are using in the lab, choose the address families enabled, and also provide their private IP address they got from <em>netlab</em>.</p><p>We can get the IP address with the <code>netlab inspect</code> command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>wsl<span class=o>)</span>·&gt;&gt; <span class=k>for</span> i in <span class=m>1</span> <span class=m>2</span> <span class=m>3</span> <span class=m>4</span> <span class=p>;</span> <span class=k>do</span> <span class=nb>echo</span> -n <span class=s2>&#34;ksynth</span><span class=nv>$i</span><span class=s2> &#34;</span><span class=p>;</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>             netlab inspect --node ksynth<span class=nv>$i</span> interfaces<span class=o>[</span>0<span class=o>]</span>.ipv4 <span class=p>;</span> <span class=k>done</span>
</span></span><span class=line><span class=cl>ksynth1 172.16.4.6/24
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ksynth2 172.16.5.7/24
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ksynth3 172.16.6.8/24
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ksynth4 172.16.7.9/24</span></span></code></pre></div><p>From this point onwards we can configure our tests in the portal.</p><h2 class=heading-element id=outro><span>Outro</span>
<a href=#outro class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>Well I hope you reached the end of this long post and that by now you have realised how simple it is to bring up a topology in <em>containerlab</em> using <em>netlab</em> to take care of the initial configuration of the underneath connectivity details and protocols running on it. The topology we used here is very small and simple, indeed, but I think that what <em>netlab</em> has to offer does worth the effort of spending some time in getting to know it better and using it in your use cases or even pipelines.</p><p>Let&rsquo;s summarise here the key takeaways of this post:</p><ul><li>We have used <em>netlab</em> to bring up a simple network topology via <em>containerlab</em> and provision the initial configs on the devices based on the supported modules and features</li><li>We have seen how to integrate additional containers interacting with this topology for serving our use case</li><li>We have seen how to use <em>netlabs&rsquo;</em> ansible inventory to run our own plays extending the usability of the lab</li><li>We have seen how to create additional configurations using templates and provision them ad-hoc to our nodes</li></ul><p>Some of my thoughts on more back-blogs coming out of this could be:</p><ul><li>Building IOL containers out of the old images using i386 libraries and also licensing</li><li>Using <a href=https://netlab.tools/dev/extools/ target=_blank rel="external nofollow noopener noreferrer"><em>netlab tools</em></a> for the service containers</li><li>Using <a href=https://netlab.tools/plugins/ target=_blank rel="external nofollow noopener noreferrer"><em>netlab plugins</em></a> to extend the current functionality or even add a new one</li><li>Handling of sensitive data, maybe ansible vault</li><li>Use a wrapper on top to orchestrate the use case, like python invoke</li><li>Use <a href=https://netlab.tools/topology/validate/ target=_blank rel="external nofollow noopener noreferrer">netlab validation tests</a></li><li>Use <a href=https://wemulate.github.io/wemulate/ target=_blank rel="external nofollow noopener noreferrer">WEmulate</a> to artificially impair links for my Kentik use case, like <a href=https://blog.ipspace.net/2024/04/netlab-wemulate/ target=_blank rel="external nofollow noopener noreferrer">this</a>.</li></ul><p align=right><br><br><i>...till next time...have fun!!!</i></p><h2 class=heading-element id=influences-and-reference><span>Influences and Reference</span>
<a href=#influences-and-reference class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><ul><li><a href=https://netlab.tools/ target=_blank rel="external nofollow noopener noreferrer">netlab</a></li><li><a href=https://containerlab.dev/ target=_blank rel="external nofollow noopener noreferrer">containerlab</a></li><li><a href=https://github.com/hellt/vrnetlab target=_blank rel="external nofollow noopener noreferrer">vrnetlab for containerlab</a></li><li><a href=https://github.com/srl-labs/srl-telemetry-lab target=_blank rel="external nofollow noopener noreferrer">srl-telemetry-lab</a></li><li><a href=https://developer.cisco.com/docs/modeling-labs/iol/ target=_blank rel="external nofollow noopener noreferrer">Cisco IOL in CML</a></li><li><a href=https://github.com/becos76/netlab-iol target=_blank rel="external nofollow noopener noreferrer">My repo for this post</a></li></ul></div><hr class=awesome-hr><h2 id=see-also>Related Content</h2><ul><li><a href=/posts/modern-nms/ title="If This Ain't a Modern NMS, Then What Is?">If This Ain't a Modern NMS, Then What Is?</a></li><li><a href=/posts/kustom-metrics/ title="K~ustom Metrics in Kentik NMS">K~ustom Metrics in Kentik NMS</a></li><li><a href=/posts/kube-my-router-pt3/ title="Kube My Router Up! - Last Part">Kube My Router Up! - Last Part</a></li><li><a href=/posts/k8s-ansible/ title="K8s Ansible">K8s Ansible</a></li><li><a href=/posts/kube-my-router-pt2/ title="Kube My Router Up! - Part Two">Kube My Router Up! - Part Two</a></li></ul><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="Updated on 2024-12-08 00:00:00">Updated on 2024-12-08&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/iou-love/index.md title="Read Markdown" class=link-to-markdown>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on X" data-sharer=twitter data-url=https://net4fungr.github.io/posts/iou-love/ data-title="For Those About to LAB...⚡" data-via=mkaliotis data-hashtags=netsim,netlab,containerlab,automation><i class="fa-brands fa-x-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://net4fungr.github.io/posts/iou-love/><i class="fa-brands fa-linkedin fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://net4fungr.github.io/posts/iou-love/><i class="fa-brands fa-reddit fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/netsim/ class=post-tag title="Tags - Netsim">Netsim</a><a href=/tags/netlab/ class=post-tag title="Tags - Netlab">Netlab</a><a href=/tags/containerlab/ class=post-tag title="Tags - Containerlab">Containerlab</a><a href=/tags/automation/ class=post-tag title="Tags - Automation">Automation</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/modern-nms/ class=post-nav-item rel=prev title="If This Ain't a Modern NMS, Then What Is?"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>If This Ain't a Modern NMS, Then What Is?</a></div></div><div id=comments><div id=giscus class=comment><script src=https://giscus.app/client.js data-repo=Net4FunGR/net4fungr.github.io data-repo-id=R_kgDOGLZFKQ data-category="Blog Comments" data-category-id=DIC_kwDOGLZFKc4Cf1aA data-mapping=title data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=en data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article><aside class=toc id=toc-auto aria-label=Contents><h2 class=toc-title>Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class="toc-content always-active" id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><div class="footer-line powered">Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.147.2"><img class=hugo-icon src=/images/hugo.min.svg alt="Hugo logo"> Hugo</a> | Theme - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.3.20"><img class=fixit-icon src=/images/fixit.min.svg alt="FixIt logo"> FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2021 - 2025</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/becos76 target=_blank rel="external nofollow noopener noreferrer">becos76</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label="View Comments"><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><a href=https://github.com/becos76/ title="Visit my GitHub" target=_blank rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true" width="56" height="56"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;top:0;--bg-progress:orange;--bg-progress-dark:grey></div><noscript><div class=noscript-warning>This website works best with JavaScript enabled.</div></noscript></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=preload href=/lib/katex/katex.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/katex/katex.min.css></noscript><link rel=stylesheet href=/lib/pace/themes/blue/pace-theme-minimal.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/twemoji/twemoji.min.js defer></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/typeit/index.umd.js defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/pace/pace.min.js async defer></script><script>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:30},comment:{enable:!0,expired:!1,giscus:{darkTheme:"dark",lightTheme:"light",origin:"https://giscus.app"}},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/search.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:3,noResultsFound:"No results found",snippetLength:30,threshold:.3,type:"fuse",useExtendedSearch:!1},twemoji:!0,typeit:{cursorChar:"|",cursorSpeed:1e3,duration:-1,loop:!1,speed:50},version:"v0.3.20"}</script><script src=/js/theme.min.js defer></script></body></html>