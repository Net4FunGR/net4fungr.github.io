<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>If This Ain't a Modern NMS, Then What Is?</title><meta name=author content=" ">
<meta name=description content="Leveraging Event Driven Ansible (EDA) and Kentik platform to achieve a simple use case: Ad-hoc shipping of streaming telemetry metrics into Kentik NMS. We are going to see how we can leverage Kentik&rsquo;s EDA to start collecting ST metrics once mitigations are fired up in the Portal"><meta name=keywords content='network monitoring,telemetry,ansible,automation'><meta itemprop=name content="If this ain't a modern NMS, then what is?"><meta itemprop=description content="Leveraging Event Driven Ansible (EDA) and Kentik platform to achieve a simple use case: Ad-hoc shipping of streaming telemetry metrics into Kentik NMS. We are going to see how we can leverage Kentik’s EDA to start collecting ST metrics once mitigations are fired up in the Portal"><meta itemprop=datePublished content="2024-06-01T00:00:00+00:00"><meta itemprop=dateModified content="2024-06-01T00:00:00+00:00"><meta itemprop=wordCount content="3042"><meta itemprop=image content="https://net4fungr.github.io/images/pyrtr_small.png"><meta itemprop=keywords content="Network Monitoring,Telemetry,Ansible,Automation"><meta property="og:url" content="https://net4fungr.github.io/posts/modern-nms/"><meta property="og:site_name" content="Becos :: Back Blog"><meta property="og:title" content="If this ain't a modern NMS, then what is?"><meta property="og:description" content="Leveraging Event Driven Ansible (EDA) and Kentik platform to achieve a simple use case: Ad-hoc shipping of streaming telemetry metrics into Kentik NMS. We are going to see how we can leverage Kentik’s EDA to start collecting ST metrics once mitigations are fired up in the Portal"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-01T00:00:00+00:00"><meta property="article:modified_time" content="2024-06-01T00:00:00+00:00"><meta property="article:tag" content="Network Monitoring"><meta property="article:tag" content="Telemetry"><meta property="article:tag" content="Ansible"><meta property="article:tag" content="Automation"><meta property="og:image" content="https://net4fungr.github.io/images/pyrtr_small.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://net4fungr.github.io/images/pyrtr_small.png"><meta name=twitter:title content="If this ain't a modern NMS, then what is?"><meta name=twitter:description content="Leveraging Event Driven Ansible (EDA) and Kentik platform to achieve a simple use case: Ad-hoc shipping of streaming telemetry metrics into Kentik NMS. We are going to see how we can leverage Kentik’s EDA to start collecting ST metrics once mitigations are fired up in the Portal"><meta name=twitter:site content="@mkaliotis"><meta name=twitter:creator content="@mkaliotis"><meta name=application-name content="Becos :: Back Blog"><meta name=apple-mobile-web-app-title content="Becos :: Back Blog"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel=canonical type=text/html href=https://net4fungr.github.io/posts/modern-nms/ title="If this ain't a modern NMS, then what is? - Becos :: Back Blog"><link rel=prev type=text/html href=https://net4fungr.github.io/posts/kustom-metrics/ title="K~ustom Metrics in Kentik NMS"><link rel=next type=text/html href=https://net4fungr.github.io/posts/iou-love/ title="For those about to LAB...⚡"><link rel=alternate type=text/markdown href=https://net4fungr.github.io/posts/modern-nms/index.md title="If this ain't a modern NMS, then what is? - Becos :: Back Blog"><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><meta name=google-site-verification content="m_enMQYWx1a1cSKPfRT_00wHfqT8ir4PZSBPyeaIH-o"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"If this ain't a modern NMS, then what is?","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/net4fungr.github.io\/posts\/modern-nms\/"},"genre":"posts","keywords":"network monitoring, telemetry, ansible, automation","wordcount":3042,"url":"https:\/\/net4fungr.github.io\/posts\/modern-nms\/","datePublished":"2024-06-01T00:00:00+00:00","dateModified":"2024-06-01T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":" "},"description":""}</script><script src=/js/head/color-scheme.min.js></script></head><body data-header-desktop=sticky data-header-mobile=auto><div class=wrapper data-page-style=narrow><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=right><div class=header-title><a href=/ title="Becos :: Back Blog"><img class=logo src=/images/pyrtr_small.png alt="Becos :: Back Blog" height=32 width=32><span class=header-title-pre><</span><span class=header-title-text>...ssh and blog...</span><span class=header-title-post>/></span></a><span class="typeit header-subtitle"><template>revamped!</template></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/categories/ title="Posts Organised by Category"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> Categories</a></li><li class=menu-item><a class=menu-link href=/collections/ title="Multipart Posts"><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> Collections</a></li><li class=menu-item><a class=menu-link href=/archives/ title="All My Posts"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> Archives</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> Tags</a></li><li class=menu-item><a class=menu-link href=https://becos76.github.io title="About Me" rel="noopener noreferrer" target=_blank><i class="fa-solid fa-signature fa-fw fa-sm" aria-hidden=true></i> About</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder="Search titles or contents ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Becos :: Back Blog"><img class=logo src=/images/pyrtr_small.png alt="Becos :: Back Blog" height=26 width=26><span class=header-title-pre><</span><span class=header-title-text>...ssh and blog...</span><span class=header-title-post>/></span></a><span class="typeit header-subtitle"><template>revamped!</template></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></li><li class=menu-item><a class=menu-link href=/categories/ title="Posts Organised by Category"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> Categories</a></li><li class=menu-item><a class=menu-link href=/collections/ title="Multipart Posts"><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> Collections</a></li><li class=menu-item><a class=menu-link href=/archives/ title="All My Posts"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> Archives</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> Tags</a></li><li class=menu-item><a class=menu-link href=https://becos76.github.io title="About Me" rel="noopener noreferrer" target=_blank><i class="fa-solid fa-signature fa-fw fa-sm" aria-hidden=true></i> About</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=Collections><div class="details related-details open"><div class="details-summary related-summary"><i class="fa-solid fa-fire fa-fade text-danger fa-fw" aria-hidden=true></i>
<span class=related-title>Related Content</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class="details-content related-content"><ul class=related-list><li class=related-item><a href=/posts/kustom-metrics/ title="K~ustom Metrics in Kentik NMS">K~ustom Metrics in Kentik NMS</a></li><li class=related-item><a href=/posts/k8s-ansible/ title="K8s Ansible">K8s Ansible</a></li><li class=related-item><a href=/posts/kube-my-router-pt3/ title="Kube My Router Up! - Last Part">Kube My Router Up! - Last Part</a></li><li class=related-item><a href=/posts/kube-my-router-pt2/ title="Kube My Router Up! - Part Two">Kube My Router Up! - Part Two</a></li><li class=related-item><a href=/posts/kube-my-router-pt1/ title="Kube My Router Up! - Part One">Kube My Router Up! - Part One</a></li></ul></div></div></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>If This Ain't a Modern NMS, Then What Is?</span></h1><p class="single-subtitle animate__animated animate__fadeIn">Exploring Kentik&rsquo;s Event-Driven-Ansible</p></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i>
</span></span><span class=post-included-in>&nbsp;included in <a href=/categories/network-monitoring/ class=post-category title="Category - Network Monitoring"><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> Network Monitoring</a></span></div><div class=post-meta-line><span title="published on 2024-06-01 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2024-06-01>2024-06-01</time></span>&nbsp;<span title="3042 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>About 3100 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>15 minutes</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#intro>Intro</a></li><li><a href=#the-intent>The Intent</a></li><li><a href=#lab-setup>Lab Setup</a></li><li><a href=#discovery>Discovery</a></li><li><a href=#kentik-eda>Kentik EDA</a><ul><li><a href=#directory-structure>Directory Structure</a></li><li><a href=#dockerfile>Dockerfile</a></li><li><a href=#compose>Compose</a></li><li><a href=#rulebook-rules>Rulebook rules</a></li></ul></li><li><a href=#ansible-playbook>Ansible Playbook</a><ul><li><a href=#telegraf-configuration>Telegraf configuration</a></li></ul></li><li><a href=#moment-of-truth>Moment of Truth</a></li><li><a href=#outro>Outro</a></li><li><a href=#influences-and-reference>Influences and Reference</a></li></ul></nav></div></div><div class=content id=content><hr><h2 class=heading-element id=intro><span>Intro</span>
<a href=#intro class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>In this post we will go through a detailed how to on executing Ansible playbooks triggered by a webhook notification event raised in Kentik Portal. The use case is to have visibility into BGP Flowspec metrics of the devices during mitigations and see the relevant counters in the Portal under Kentik&rsquo;s NMS Metrics Explorer.</p><p>You may find all relevant files in my <a href=https://github.com/becos76/kentik-eda target=_blank rel="external nofollow noopener noreferrer">repo</a>.</p><hr><h2 class=heading-element id=the-intent><span>The Intent</span>
<a href=#the-intent class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>For the webhook receiver part, we are going to use <a href=https://github.com/kentik/ansible_eda target=_blank rel="external nofollow noopener noreferrer">Kentik&rsquo;s ansible_eda</a> collection that will <em>listen</em> for a mitigation notification event. Once the event is received and a mitigation is started, EDA will trigger the execution of a playbook to handle the event and spin-up Telegraf in order to start polling the devices for BGP Flowspec streaming telemetry counters while reporting them back to the Portal in influx line format via HTTPS.</p><p>Once the mitigation is over and EDA receives the respective <em>cease</em> notification, a check for any active mitigations on the devices is done via Kentik&rsquo;s API and if there are no active mitigations on the devices, EDA will trigger Telegraf to stop. If there are still on-going mitigations, Telegraf will continue to poll and ship metrics till we receive the last mitigation&rsquo;s notification.</p><hr><h2 class=heading-element id=lab-setup><span>Lab Setup</span>
<a href=#lab-setup class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>Here is how the lab has been set-up for this:</p><ul><li>Two Cisco IOS XRv 9000 devices defined in the portal with established BGP sessions and Flowspec family enabled. GRPC is configured and enabled on the devices.</li><li>A mitigation Platform defined in the Portal that includes both devices, and two mitigation methods attached. One will block ICMP echo-requests and the other will Rate Limit SSH protocol</li><li>A notification channel of type JSON defined in the portal and attached to both mitigation methods<div class="details admonition note"><div class="details-summary admonition-title"><i class="icon fa-fw fa-solid fa-pencil-alt" aria-hidden=true></i>Note<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>I chose not to use any Alerting Policies with this and trigger all mitigations manually in order to speed things up</div></div></div></li><li>An Ubuntu VM (jammy) with docker installed<ul><li>EDA will run inside a docker container with Traefik <em>proxying</em> the webhook events</li><li>Once an <em>actionable</em> event is received, EDA will control a Telegraf docker container accordingly through a playbook</li></ul></li></ul><hr><h2 class=heading-element id=discovery><span>Discovery</span>
<a href=#discovery class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>We will start by exploring what we see on the devices during a running flowspec mitigation. We have triggered two manual mitigations in the Portal and those are currently active on the devices:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>RP/0/RP0/CPU0:ATH-POP1-XRV1#show flowspec afi-all detail
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>AFI: IPv4
</span></span><span class=line><span class=cl>  Flow           :Dest:10.10.10.11/32,ICMPType:=8
</span></span><span class=line><span class=cl>    Actions      :Traffic-rate: 0 bps  (bgp.1)
</span></span><span class=line><span class=cl>  Flow           :Source:10.10.10.12/32,Proto:=6,DPort:=22
</span></span><span class=line><span class=cl>    Actions      :Traffic-rate: 160000 bps  (bgp.1)</span></span></code></pre></div><div class="details admonition failure"><div class="details-summary admonition-title"><i class="icon fa-fw fa-solid fa-xmark" aria-hidden=true></i>XRv9k limitations<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><p>Unfortunatelly the XRv has a limited data plane, so we do not get any <em>action</em> counters on the mitigations - this and also no netflow out of this virtual device &#x1f622;. In case of a <em>real</em> XR device the output would be similar to this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>REAL-XR#show flowspec afi-all detail
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>AFI: IPv4
</span></span><span class=line><span class=cl>  Flow           :Dest:10.10.10.11/32,ICMPType:=8
</span></span><span class=line><span class=cl>    Actions      :Traffic-rate: 0 bps  (bgp.1)
</span></span><span class=line><span class=cl>	Statisctics                       (packets/bytes)
</span></span><span class=line><span class=cl>	  Matched         :                       10/640
</span></span><span class=line><span class=cl>	  Dropped         :                       10/640</span></span></code></pre></div></div></div></div><p>So we have two mitigations as expected. Let&rsquo;s find out which YANG model those are defined under. After trying some show commands for the xpath, there it is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>RP/0/RP0/CPU0:ATH-POP1-XRV1#schema-describe &#34;show flowspec afi-all detail&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Action: get
</span></span><span class=line><span class=cl>Path:   RootCfg.ASNFormat
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Action: get_children
</span></span><span class=line><span class=cl>Path:   RootOper.FlowSpec.VRF({&#39;VRFName&#39;: &#39;default&#39;}).AF
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Action: get
</span></span><span class=line><span class=cl>Path:   RootOper.FlowSpec.VRF({&#39;VRFName&#39;: &#39;default&#39;}).AF({&#39;AFName&#39;: &#39;IPv4&#39;}).Flow
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>RP/0/RP0/CPU0:ATH-POP1-XRV1#show telemetry internal xpath &#34;show flowspec afi-all detail&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Error: Invalid input
</span></span><span class=line><span class=cl>RP/0/RP0/CPU0:ATH-POP1-XRV1#show telemetry internal xpath &#34;show flowspec afi-all&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Error: Invalid input
</span></span><span class=line><span class=cl>RP/0/RP0/CPU0:ATH-POP1-XRV1#show telemetry internal xpath &#34;show flowspec summary&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Cisco-IOS-XR-flowspec-oper:flow-spec/summary
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>RP/0/RP0/CPU0:ATH-POP1-XRV1#show telemetry internal json Cisco-IOS-XR-flowspec-oper:flow-spec | include path
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  &#34;encoding_path&#34;: &#34;Cisco-IOS-XR-flowspec-oper:flow-spec/vrfs/vrf/afs/af/flows/flow&#34;,
</span></span><span class=line><span class=cl>  &#34;encoding_path&#34;: &#34;Cisco-IOS-XR-flowspec-oper:flow-spec/vrfs/vrf/afs/af/nlris/nlri&#34;,
</span></span><span class=line><span class=cl>  &#34;encoding_path&#34;: &#34;Cisco-IOS-XR-flowspec-oper:flow-spec/vrfs/vrf/afs/af/table-summary&#34;,
</span></span><span class=line><span class=cl>  &#34;encoding_path&#34;: &#34;Cisco-IOS-XR-flowspec-oper:flow-spec/summary&#34;,
</span></span><span class=line><span class=cl>  &#34;encoding_path&#34;: &#34;Cisco-IOS-XR-flowspec-oper:flow-spec/clients/client&#34;,</span></span></code></pre></div><p>Now we know the YANG model and the xpath, and we can get the metrics out of. We will test it with <code>gnmic</code> to see if it works and get the details of the tags/paths returned:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=err>❯</span> <span class=err>gnmic</span> <span class=err>-a</span> <span class=mf>10.12</span><span class=err>.</span><span class=mf>255.1</span><span class=err>:</span><span class=mi>57344</span> <span class=err>-u</span> <span class=err>&lt;device_username&gt;</span> <span class=err>-p</span> <span class=err>&lt;device_password&gt;</span> <span class=err>--skip-verify</span> <span class=err>prompt</span>
</span></span><span class=line><span class=cl><span class=err>gnmic&gt;</span> <span class=err>get</span> <span class=err>--path</span> <span class=err>Cisco-IOS-XR-flowspec-oper:flow-spec/vrfs/vrf/afs/af/flows/flow</span> <span class=err>-e</span> <span class=err>json_ietf</span> <span class=err>--format</span> <span class=err>event</span>
</span></span><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;get-request&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;timestamp&#34;</span><span class=p>:</span> <span class=mi>1716762517741698080</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;af_af-name&#34;</span><span class=p>:</span> <span class=s2>&#34;IPv4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;flow_flow-notation&#34;</span><span class=p>:</span> <span class=s2>&#34;Dest:10.10.10.11/32,ICMPType:=8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;source&#34;</span><span class=p>:</span> <span class=s2>&#34;10.12.255.1:57344&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;vrf_vrf-name&#34;</span><span class=p>:</span> <span class=s2>&#34;default&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;values&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/active-flow-client/action.0/dscp&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/active-flow-client/action.0/ipv4-nh&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/active-flow-client/action.0/ipv6-nh&#34;</span><span class=p>:</span> <span class=s2>&#34;::&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/active-flow-client/action.0/rate&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/flow-notation&#34;</span><span class=p>:</span> <span class=s2>&#34;Dest:10.10.10.11/32,ICMPType:=8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/flow-statistics/classified/bytes&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/flow-statistics/classified/packets&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/flow-statistics/dropped/bytes&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/flow-statistics/dropped/packets&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/destination-prefix-ipv4/mask&#34;</span><span class=p>:</span> <span class=s2>&#34;255.255.255.255&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/destination-prefix-ipv4/prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;10.10.10.11&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/destination-prefix-ipv6/mask&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/destination-prefix-ipv6/prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;::&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/icmp/code&#34;</span><span class=p>:</span> <span class=mi>255</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/icmp/type&#34;</span><span class=p>:</span> <span class=mi>8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/source-prefix-ipv4/mask&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/source-prefix-ipv4/prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/source-prefix-ipv6/mask&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/source-prefix-ipv6/prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;::&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/tcp-flag/match-any&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/tcp-flag/value&#34;</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;get-request&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;timestamp&#34;</span><span class=p>:</span> <span class=mi>1716762517741698080</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;af_af-name&#34;</span><span class=p>:</span> <span class=s2>&#34;IPv4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;flow_flow-notation&#34;</span><span class=p>:</span> <span class=s2>&#34;Source:10.10.10.12/32,Proto:=6,DPort:=22&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;source&#34;</span><span class=p>:</span> <span class=s2>&#34;10.12.255.1:57344&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;vrf_vrf-name&#34;</span><span class=p>:</span> <span class=s2>&#34;default&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;values&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/active-flow-client/action.0/dscp&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/active-flow-client/action.0/ipv4-nh&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/active-flow-client/action.0/ipv6-nh&#34;</span><span class=p>:</span> <span class=s2>&#34;::&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/active-flow-client/action.0/rate&#34;</span><span class=p>:</span> <span class=s2>&#34;160000&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/flow-notation&#34;</span><span class=p>:</span> <span class=s2>&#34;Source:10.10.10.12/32,Proto:=6,DPort:=22&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/flow-statistics/classified/bytes&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/flow-statistics/classified/packets&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/flow-statistics/dropped/bytes&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/flow-statistics/dropped/packets&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/destination-port/uint16_rng_array.0/max&#34;</span><span class=p>:</span> <span class=mi>22</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/destination-port/uint16_rng_array.0/min&#34;</span><span class=p>:</span> <span class=mi>22</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/destination-prefix-ipv4/mask&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/destination-prefix-ipv4/prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/destination-prefix-ipv6/mask&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/destination-prefix-ipv6/prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;::&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/icmp/code&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/icmp/type&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/ip-protocol/uint16_rng_array.0/max&#34;</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/ip-protocol/uint16_rng_array.0/min&#34;</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/source-prefix-ipv4/mask&#34;</span><span class=p>:</span> <span class=s2>&#34;255.255.255.255&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/source-prefix-ipv4/prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;10.10.10.12&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/source-prefix-ipv6/mask&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/source-prefix-ipv6/prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;::&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/tcp-flag/match-any&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;/Cisco-IOS-XR-flowspec-oper:/flow-spec/vrfs/vrf/afs/af/flows/flow/matches/tcp-flag/value&#34;</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div><hr><h2 class=heading-element id=kentik-eda><span>Kentik EDA</span>
<a href=#kentik-eda class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>We are going to start off by explaining the file and folder structure giving a bit of info of how this works. The idea behind this is to have EDA running as a docker container. Traefik will handle reverse proxying the webhooks to EDA and in case a new mitigation is happening, then a telegraf docker container will spin up and start collecting gnmi metrics from the devices and pushing them to the Portal. Once the mitigation is over, EDA will receive the event to stop the mitigation.</p><p>Now, at this point, since more than one mitigations can be ongoing on the devices, we are going to focus on the specific mitigation Platform that will always include our devices. So any Method under the specific mitigation Platform will cause the start of the metrics collection. Upon receiving a stop event on this Platform, we just have to make sure that this event is the <em>last</em> one on the devices, and we can verify this via Kentik API requesting all active alerts in the portal of type Mitigation. If none exists, then we can assume that the event EDA received was the last one for the Platform.</p><p>In summary, here are the features delivered:</p><ul><li>Traefik is handling the proxying of webhooks to the appropriate path that Kentik EDA is set up to receive</li><li>Kentik EDA processes only the relevant mitigation events coming in excluding the rest</li><li>The playbook will dynamically produce the telegraf configuration file according to our defined variables in order to ship the metrics in the Portal</li></ul><h3 class=heading-element id=directory-structure><span>Directory Structure</span>
<a href=#directory-structure class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── docker-compose.yaml         &gt;-- How to bring up our services
</span></span><span class=line><span class=cl>├── Dockerfile                  &gt;-- How to build the EDA image
</span></span><span class=line><span class=cl>├── .env                        &gt;-- Hidden file containing sensitive data to be passed as environment variables
</span></span><span class=line><span class=cl>├── .env.sample                 &gt;-- Example env file
</span></span><span class=line><span class=cl>└── eda                         &gt;-- EDA config folder to be mounted on the container
</span></span><span class=line><span class=cl>    ├── ansible.cfg             &gt;-- Ansible configuration file picked up by default
</span></span><span class=line><span class=cl>    ├── ansible-inventory.yml   &gt;-- Simple inv file including only localhost
</span></span><span class=line><span class=cl>    ├── eda_vars.yml            &gt;-- Definition of the related variables used in the project
</span></span><span class=line><span class=cl>    ├── mitigation.yml          &gt;-- Playbook to handle events received
</span></span><span class=line><span class=cl>    ├── rules.yml               &gt;-- Rulebook defining our EDA logic
</span></span><span class=line><span class=cl>    └── telegraf                
</span></span><span class=line><span class=cl>        ├── telegraf.conf.j2    &gt;-- Jinja2 template producing the configuration dynamically
</span></span><span class=line><span class=cl>        └── telegraf.conf       &gt;-- Actual config to be used with the telegraf container
</span></span><span class=line><span class=cl>       </span></span></code></pre></div><h3 class=heading-element id=dockerfile><span>Dockerfile</span>
<a href=#dockerfile class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>We are installing the dependencies and ansible needed collections for Kentik EDA to run. We are going to run everything under the <code>/app</code> directory inside the container</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> quay.io/centos/centos:stream9-development</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> dnf install -y java-17-openjdk-devel python3-pip gcc python3-devel postgresql-devel<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>JAVA_HOME</span><span class=o>=</span>/usr/lib/jvm/java-17-openjdk<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip install -U pip <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> pip install ansible-core <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    ansible-rulebook <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    ansible-runner <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    psycopg requests <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> ansible-galaxy collection install kentik.ansible_eda community.docker<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>APP_DIR</span><span class=o>=</span><span class=si>${</span><span class=nv>APP_DIR</span><span class=k>:-</span><span class=p>/app</span><span class=si>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> $APP_DIR</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> chmod -R <span class=m>0775</span> <span class=nv>$APP_DIR</span></span></span></code></pre></div><h3 class=heading-element id=compose><span>Compose</span>
<a href=#compose class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>Our compose file will bring up two services.</p><ul><li><strong>traefik</strong>: that will listen for HTTP and will forward everything received at the <code>/eda</code> path to the EDA container replacing the path to <code>/alert</code>, since this is the path that Kentik EDA webhook listens on, and port <code>8080</code>.</li><li><strong>kentik-eda</strong>: Our <code>eda</code> folder is mounted at the <code>/app</code> path inside the container, and contains all the files needed to run our logic. We also mount the docker unix socket to the container so that we can control the containers from within the EDA one. We also pass our variables to the container environment and we instruct the container to start the rulebook passing also the variables files.<div class="details admonition warning"><div class="details-summary admonition-title"><i class="icon fa-fw fa-solid fa-exclamation-triangle" aria-hidden=true></i>Avoid using this in production!!!<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>Security wise it is not the best to have a docker container controlling the host&rsquo;s containers by exposing the unix socket to it. &#x1f604;</div></div></div></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>traefik</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>&gt;</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      --api.insecure=true
</span></span></span><span class=line><span class=cl><span class=sd>      --providers.docker
</span></span></span><span class=line><span class=cl><span class=sd>      --providers.docker.exposedbydefault=false
</span></span></span><span class=line><span class=cl><span class=sd>      --accesslog=true
</span></span></span><span class=line><span class=cl><span class=sd>      --entrypoints.eda.address=:80
</span></span></span><span class=line><span class=cl><span class=sd>      #--log.level=DEBUG</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>80</span><span class=p>:</span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>8080</span><span class=p>:</span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/var/run/docker.sock:/var/run/docker.sock:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kentik-eda</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#scale: 2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>kentik-eda:0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>kentik-eda</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>context</span><span class=p>:</span><span class=w> </span><span class=l>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>${PWD}/eda:/app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/var/run/docker.sock:/var/run/docker.sock:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env_file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>.env</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>bash -c &#34;ansible-rulebook --rulebook rules.yml -i ./ansible-inventory.yml --vars eda_vars.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;traefik.enable=true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;traefik.http.routers.eda.rule=Host(`kentik.eda`) &amp;&amp; Path(`/eda`)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;traefik.http.routers.eda.middlewares=eda-ratelimit,eda-path&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;traefik.http.middlewares.eda-path.replacepath.path=/alert&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;traefik.http.middlewares.eda-ratelimit.ratelimit.average=10&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;traefik.http.middlewares.eda-ratelimit.ratelimit.burst=50&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;traefik.http.routers.eda.entrypoints=eda&#34;</span></span></span></code></pre></div><p>Here is the example <code>.env</code> file showing the variables needed to be exposed inside the EDA container environment:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=nv>KENTIK_API_TOKEN</span><span class=o>=</span>&lt;your api token&gt;
</span></span><span class=line><span class=cl><span class=nv>KENTIK_API_EMAIL</span><span class=o>=</span>&lt;your portal email&gt;
</span></span><span class=line><span class=cl><span class=nv>KENTIK_API_ENDPOINT</span><span class=o>=</span><span class=s2>&#34;https://grpc.api.kentik.eu/kmetrics/v202207/metrics/api/v2/write?bucket=&amp;org=&amp;precision=ns&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>GRPC_USERNAME</span><span class=o>=</span>&lt;device username&gt;
</span></span><span class=line><span class=cl><span class=nv>GRPC_PASSWORD</span><span class=o>=</span>&lt;device password&gt;</span></span></code></pre></div><p>We can bring everything up with <code>docker compose up --build</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>❯ docker compose up --build --force-recreate --dry-run
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Building 0.0s <span class=o>(</span>0/0<span class=o>)</span>                                                                                  docker:default
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Running 5/0
</span></span><span class=line><span class=cl> ✔ DRY-RUN MODE -    build service kentik-eda                                                                      0.0s
</span></span><span class=line><span class=cl> ✔ DRY-RUN MODE -  <span class=o>==</span>&gt; <span class=o>==</span>&gt; writing image dryRun-648b28d83dd200d4e7709ac3a5d522f8244467bd                           0.0s
</span></span><span class=line><span class=cl> ✔ DRY-RUN MODE -  <span class=o>==</span>&gt; <span class=o>==</span>&gt; naming to kentik-eda:0.1                                                                0.0s
</span></span><span class=line><span class=cl> ✔ DRY-RUN MODE -  Container traefik                                                     Recreated                 0.0s
</span></span><span class=line><span class=cl> ✔ DRY-RUN MODE -  Container kentik-eda                                                  Recreated                 0.0s
</span></span><span class=line><span class=cl>end of <span class=s1>&#39;compose up&#39;</span> output, interactive run is not supported in dry-run mode</span></span></code></pre></div><h3 class=heading-element id=rulebook-rules><span>Rulebook rules</span>
<a href=#rulebook-rules class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>Here is how we have configured our rules:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-YAML data-lang=YAML><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Listening for Webhook Events</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>sources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>kentik.ansible_eda.kentik_webhook</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>R1 - New Event Received</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># If it is a valid start or stop mitigation event</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class=l>event.payload is defined and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=l>event.payload.CompanyID == vars.CompanyID and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=l>event.payload.EventType == vars.EventType and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=l>event.payload.MitigationPlatformID == vars.MitigationPlatformID and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=l>event.payload.MitigationState in vars.ValidMitigationStates and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=l>event.payload.MitigationStateNew in vars.ValidMitigationStates</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>actions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>              New {{event.payload.MitigationType}}/{{event.payload.MitigationState}} event received
</span></span></span><span class=line><span class=cl><span class=sd>              ID: {{event.payload.MitigationID}}
</span></span></span><span class=line><span class=cl><span class=sd>              Platform: {{event.payload.MitigationPlatformName}}
</span></span></span><span class=line><span class=cl><span class=sd>              Method: {{event.payload.MitigationMethodName}}
</span></span></span><span class=line><span class=cl><span class=sd>              IP: {{event.payload.MitigationAlertIP}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># DEBUG:Dump the event</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c>#- print_event:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c>#    pretty: true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># Call the pb to handle the mitigation event</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>run_playbook</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mitigation.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Catch and ignore the rest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>R2 - Not taking action</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class=l>event.meta is defined</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>msg</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;Ignoring {{event.payload.EventType}} event&#34;</span></span></span></code></pre></div><p style=background-color:skyblue;text-align:center><b>eda/rules.yml</b></p>and our variables:<div class=highlight><pre tabindex=0 class=chroma><code class=language-YAML data-lang=YAML><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>CompanyID</span><span class=p>:</span><span class=w> </span><span class=l>&lt;REDACTED&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>EventType</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mitigation&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>MitigationPlatformID</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;257&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ValidMitigationStates</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;manualMitigating&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;mitigating&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;archived&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Mitigation</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>devices</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;ath-pop1-xrv1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10.12.255.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>57344</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;ath-pop1-xrv2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10.13.255.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>57344</span></span></span></code></pre></div><p style=background-color:skyblue;text-align:center><b>eda/eda_vars.yml</b></p><p>As a condition we check the event payload against certain values in order to process it further, e.g. the CompanyID , the EventType and the MitigationPlatformID must match to what we have configured and also the EventState must be one of the <em>actionable</em> states that we have defined in our dictionary. If we have a matching event then we pass control to the <code>mitigation.yml</code> playbook to handle the event further.</p><hr><h2 class=heading-element id=ansible-playbook><span>Ansible Playbook</span>
<a href=#ansible-playbook class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>We could have had separate playbooks for the different states of the alerts received, i.e. separate conditions in the rules file, but we chose here to proceed with just one playbook to handle both cases.</p><p>A brief pseudocode of the playbook could be:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=c1>#IF event state is &#39;mitigating&#39;</span>
</span></span><span class=line><span class=cl>	<span class=c1>#IF Telegraf is not running</span>
</span></span><span class=line><span class=cl>		- Generate telegraf config from template
</span></span><span class=line><span class=cl>		- Bring up the container
</span></span><span class=line><span class=cl><span class=c1>#ELSE IF event state is &#39;archived&#39;</span>
</span></span><span class=line><span class=cl>	<span class=c1>#IF no active mitigation alerts in portal for PlatormID</span>
</span></span><span class=line><span class=cl>		- Stop telegraf container</span></span></code></pre></div><details><summary>Here is a sequence diagram showing the workflows</summary><pre class=mermaid>sequenceDiagram
  autonumber
  participant Portal
  participant EDA
  Portal->>EDA: Alerts
  loop Listen
    EDA->>EDA: Check Platform and State (Start/Stop)
    create participant Playbook
    EDA->>Playbook: Process Valid Alert  
  end
  alt Mitigation Started
    Playbook->>Docker: Is Telegraf Running?
    Docker-->>Playbook: State
    alt Telegraf Running
      Playbook->>Playbook: Do nothing
    else Telegraf Down
      Playbook->>Playbook: Create Telegraf config
      Playbook->>Docker: Start Telegraf
      create participant Telegraf
      Docker->>Telegraf: Run Container
      loop
        create participant Devices
        Telegraf->>Devices: Fetch metrics
        Telegraf->>Portal: Ship metrics
      end
    end
  else Mitigation Finished
    Playbook->>Portal: Get active mitigations
    Portal-->>Playbook: Active Mitigations
    alt Active Mitigations on Platform
      Playbook->>Playbook: Do nothing
    else No Active Mitigations on Platform
      Playbook->>Docker: Stop Telegraf
      Docker->>Telegraf: Container Down
      destroy Telegraf
    end
  end</pre><template>sequenceDiagram
autonumber
participant Portal
participant EDA
Portal->>EDA: Alerts
loop Listen
EDA->>EDA: Check Platform and State (Start/Stop)
create participant Playbook
EDA->>Playbook: Process Valid Alert
end
alt Mitigation Started
Playbook->>Docker: Is Telegraf Running?
Docker-->>Playbook: State
alt Telegraf Running
Playbook->>Playbook: Do nothing
else Telegraf Down
Playbook->>Playbook: Create Telegraf config
Playbook->>Docker: Start Telegraf
create participant Telegraf
Docker->>Telegraf: Run Container
loop
create participant Devices
Telegraf->>Devices: Fetch metrics
Telegraf->>Portal: Ship metrics
end
end
else Mitigation Finished
Playbook->>Portal: Get active mitigations
Portal-->>Playbook: Active Mitigations
alt Active Mitigations on Platform
Playbook->>Playbook: Do nothing
else No Active Mitigations on Platform
Playbook->>Docker: Stop Telegraf
Docker->>Telegraf: Container Down
destroy Telegraf
end
end</template></details><p>And here is the playbook. Two blocks were used to differentiate between the start and stop workflows. For the telegraf container the configuration file is dynamically produced through a jinja2 template and this is mounted within the container. This is achieved by specifying the full host path of the file, which is also relatively mounted within the EDA container, i.e. shared.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-YAML data-lang=YAML><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;::HANDLE MITIGATION EVENT::&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars_files</span><span class=p>:</span><span class=w> </span><span class=l>eda_vars.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>START - NEW MITIGATION STARTING</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>block</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>START::IS TELEGRAF RUNNING</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>community.docker.docker_container_info</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>telegraf-eda</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>result</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>START::GENERATE TELEGRAF CONFIG</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ansible.builtin.template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=l>/app/telegraf/telegraf.conf.j2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=l>/app/telegraf/telegraf.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>not result.exists|bool      </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>START::BRING UP CONTAINER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>community.docker.docker_container</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>telegraf-eda</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>telegraf:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>started</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;/opt/projects/kentik-eda/eda/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>KENTIK_API_EMAIL</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;ansible.builtin.env&#39;, &#39;KENTIK_API_EMAIL&#39;)}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>KENTIK_API_TOKEN</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;ansible.builtin.env&#39;, &#39;KENTIK_API_TOKEN&#39;)}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>GRPC_USERNAME</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;ansible.builtin.env&#39;, &#39;GRPC_USERNAME&#39;)}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>GRPC_PASSWORD</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;ansible.builtin.env&#39;, &#39;GRPC_PASSWORD&#39;)}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>not result.exists|bool      </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#39;mitigating&#39; in ansible_eda.event.payload.MitigationState|lower and 
</span></span></span><span class=line><span class=cl><span class=s2>            &#39;mitigating&#39; in ansible_eda.event.payload.MitigationStateNew|lower&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MITIGATION FINISHED</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>block</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>STOP::GET ACTIVE ALERTS FROM KENTIK</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ansible.builtin.uri</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>https://api.kentik.eu/api/v5/alerts-active/alarms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nt>method</span><span class=p>:</span><span class=w> </span><span class=l>GET</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nt>http_agent</span><span class=p>:</span><span class=w> </span><span class=l>ansible-eda-httpget</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nt>headers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=nt>X-CH-Auth-API-Token</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;ansible.builtin.env&#39;, &#39;KENTIK_API_TOKEN&#39;)}}&#34;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=nt>X-CH-Auth-Email</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;ansible.builtin.env&#39;, &#39;KENTIK_API_EMAIL&#39;)}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>alerts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>STOP::CHECK KENTIK FOR ACTIVE MITIGATIONS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ansible.builtin.debug</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>msg</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;Current Active Mitigations on Platform ID#{{MitigationPlatformID}}: {{alerts.json | 
</span></span></span><span class=line><span class=cl><span class=s2>               selectattr(&#39;mit_platform_id&#39;, &#39;match&#39;, ansible_eda.event.payload.MitigationPlatformID ) |
</span></span></span><span class=line><span class=cl><span class=s2>              selectattr(&#39;alarm_state&#39;, &#39;search&#39;, &#39;MITIGATING&#39;) | length}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>STOP::REMOVE TELEGRAF CONTAINER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>community.docker.docker_container</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>telegraf-eda</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>absent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>alerts.json | </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=l>selectattr(&#39;mit_platform_id&#39;, &#39;match&#39;, ansible_eda.event.payload.MitigationPlatformID ) |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=l>selectattr(&#39;alarm_state&#39;, &#39;search&#39;, &#39;MITIGATING&#39;) | length == 0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#39;archived&#39; in ansible_eda.event.payload.MitigationState|lower and
</span></span></span><span class=line><span class=cl><span class=s2>            &#39;archived&#39; in ansible_eda.event.payload.MitigationStateNew|lower&#34;</span></span></span></code></pre></div><p style=background-color:skyblue;text-align:center><b>eda/mitigation.yml</b></p><h3 class=heading-element id=telegraf-configuration><span>Telegraf configuration</span>
<a href=#telegraf-configuration class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>When it comes to telegraf, we chose to have the config generated dynamically before the container starts. In this way we can:</p><ul><li>Specify the devices&rsquo; attributes in the variables file and deduce the gnmi inputs from them</li><li>Include the MitigationPlatformID as a tag along with all other event details</li><li>Perform a <em>lookup</em> to include DEVICE_IP and DEVICE_NAME along with the tags. This was implemented via an inline starlark script referencing a lookup dictionary that is dynamically constructed from our devices dictionary.</li><li>All sensitive data are passed from the EDA container environment and instantiated via docker when the container is brought up.</li></ul><p>Here is the template:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>agent</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>omit_hostname</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=nx>debug</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=nx>quiet</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>global_tags</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>platform_id</span> <span class=p>=</span> <span class=s2>&#34;{{ MitigationPlatformID }}&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>inputs</span><span class=p>.</span><span class=nx>gnmi</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>addresses</span> <span class=p>=</span> <span class=p>[{</span><span class=err>%</span> <span class=nx>for</span> <span class=nx>device</span> <span class=nx>in</span> <span class=nx>Mitigation</span><span class=p>.</span><span class=nx>devices</span> <span class=err>%</span><span class=p>}</span><span class=s2>&#34;{{device.ip}}:{{device.port}}&#34;</span><span class=p>{</span><span class=err>%</span> <span class=nx>if</span> <span class=nx>not</span> <span class=nx>loop</span><span class=p>.</span><span class=nx>last</span> <span class=err>%</span><span class=p>},{</span><span class=err>%</span> <span class=nx>endif</span> <span class=err>%</span><span class=p>}{</span><span class=err>%</span> <span class=nx>endfor</span> <span class=err>%</span><span class=p>}]</span>
</span></span><span class=line><span class=cl>  <span class=nx>username</span> <span class=p>=</span> <span class=s2>&#34;${GRPC_USERNAME}&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>password</span> <span class=p>=</span> <span class=s2>&#34;${GRPC_PASSWORD}&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>redial</span> <span class=p>=</span> <span class=s2>&#34;10s&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>encoding</span> <span class=p>=</span> <span class=s2>&#34;proto&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>tls_enable</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=nx>insecure_skip_verify</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>inputs</span><span class=p>.</span><span class=nx>gnmi</span><span class=p>.</span><span class=nx>subscription</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;/devices/xrv9000/flowspec&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>origin</span> <span class=p>=</span> <span class=s2>&#34;Cisco-IOS-XR-flowspec-oper&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>path</span> <span class=p>=</span> <span class=s2>&#34;/flow-spec/vrfs/vrf/afs/af/flows/flow/flow-statistics/&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>subscription_mode</span> <span class=p>=</span> <span class=s2>&#34;sample&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>sample_interval</span> <span class=p>=</span> <span class=s2>&#34;30s&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>rename</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=p>[[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>rename</span><span class=p>.</span><span class=nx>replace</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=nx>tag</span> <span class=p>=</span> <span class=s2>&#34;source&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>dest</span> <span class=p>=</span> <span class=s2>&#34;device_ip&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>override</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>override</span><span class=p>.</span><span class=nx>tagpass</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>vrf_name</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>override</span><span class=p>.</span><span class=nx>tags</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>vrf_name</span> <span class=p>=</span> <span class=s2>&#34;default&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>starlark</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=nx>source</span><span class=p>=</span><span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>lookup = {
</span></span></span><span class=line><span class=cl><span class=s1>{% for device in Mitigation.devices %}
</span></span></span><span class=line><span class=cl><span class=s1>  &#34;{{ device.ip }}&#34;: &#34;{{ device.name }}&#34;,
</span></span></span><span class=line><span class=cl><span class=s1>{% endfor %}}
</span></span></span><span class=line><span class=cl><span class=s1>def apply(metric):
</span></span></span><span class=line><span class=cl><span class=s1>    if metric.tags[&#39;</span><span class=nx>device_ip</span><span class=s1>&#39;] and metric.tags[&#39;</span><span class=nx>device_ip</span><span class=s1>&#39;] in lookup:
</span></span></span><span class=line><span class=cl><span class=s1>       metric.tags[&#39;</span><span class=nx>device_name</span><span class=s1>&#39;] = lookup[metric.tags[&#39;</span><span class=nx>device_ip</span><span class=s1>&#39;]]
</span></span></span><span class=line><span class=cl><span class=s1>    return metric
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>outputs</span><span class=p>.</span><span class=nx>file</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=nx>files</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;stdout&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>data_format</span> <span class=p>=</span> <span class=s2>&#34;influx&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>influx_sort_fields</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=nx>tagexclude</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;path&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>outputs</span><span class=p>.</span><span class=nx>http</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=nx>url</span> <span class=p>=</span> <span class=s2>&#34;{{ lookup(&#39;env&#39;, &#39;KENTIK_API_ENDPOINT&#39;)}}&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>data_format</span> <span class=p>=</span> <span class=s2>&#34;influx&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>influx_sort_fields</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=nx>tagexclude</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;path&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>outputs</span><span class=p>.</span><span class=nx>http</span><span class=p>.</span><span class=nx>headers</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>Content-Type</span> <span class=p>=</span> <span class=s2>&#34;application/influx&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>X-CH-Auth-Email</span> <span class=p>=</span> <span class=s2>&#34;${KENTIK_API_EMAIL}&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>X-CH-Auth-API-Token</span> <span class=p>=</span> <span class=s2>&#34;${KENTIK_API_TOKEN}&#34;</span></span></span></code></pre></div><p style=background-color:skyblue;text-align:center><b>eda/telegraf/telegraf.conf.j2</b></p><p>And the respective config file produced to be picked up by docker:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>agent</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>omit_hostname</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=nx>debug</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=nx>quiet</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=nx>global_tags</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>platform_id</span> <span class=p>=</span> <span class=s2>&#34;257&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>inputs</span><span class=p>.</span><span class=nx>gnmi</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>addresses</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;10.12.255.1:57344&#34;</span><span class=p>,</span><span class=s2>&#34;10.13.255.1:57344&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>username</span> <span class=p>=</span> <span class=s2>&#34;${GRPC_USERNAME}&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>password</span> <span class=p>=</span> <span class=s2>&#34;${GRPC_PASSWORD}&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>redial</span> <span class=p>=</span> <span class=s2>&#34;10s&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>encoding</span> <span class=p>=</span> <span class=s2>&#34;proto&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>tls_enable</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=nx>insecure_skip_verify</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>inputs</span><span class=p>.</span><span class=nx>gnmi</span><span class=p>.</span><span class=nx>subscription</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;/devices/xrv9000/flowspec&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>origin</span> <span class=p>=</span> <span class=s2>&#34;Cisco-IOS-XR-flowspec-oper&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>path</span> <span class=p>=</span> <span class=s2>&#34;/flow-spec/vrfs/vrf/afs/af/flows/flow/flow-statistics/&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>subscription_mode</span> <span class=p>=</span> <span class=s2>&#34;sample&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>sample_interval</span> <span class=p>=</span> <span class=s2>&#34;30s&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>rename</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=p>[[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>rename</span><span class=p>.</span><span class=nx>replace</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=nx>tag</span> <span class=p>=</span> <span class=s2>&#34;source&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>dest</span> <span class=p>=</span> <span class=s2>&#34;device_ip&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>override</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>override</span><span class=p>.</span><span class=nx>tagpass</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>vrf_name</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>override</span><span class=p>.</span><span class=nx>tags</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>vrf_name</span> <span class=p>=</span> <span class=s2>&#34;default&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>starlark</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=nx>source</span><span class=p>=</span><span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>lookup = {
</span></span></span><span class=line><span class=cl><span class=s1>  &#34;10.12.255.1&#34;: &#34;ath-pop1-xrv1&#34;,
</span></span></span><span class=line><span class=cl><span class=s1>  &#34;10.13.255.1&#34;: &#34;ath-pop1-xrv2&#34;,
</span></span></span><span class=line><span class=cl><span class=s1>}
</span></span></span><span class=line><span class=cl><span class=s1>def apply(metric):
</span></span></span><span class=line><span class=cl><span class=s1>    if metric.tags[&#39;</span><span class=nx>device_ip</span><span class=s1>&#39;] and metric.tags[&#39;</span><span class=nx>device_ip</span><span class=s1>&#39;] in lookup:
</span></span></span><span class=line><span class=cl><span class=s1>       metric.tags[&#39;</span><span class=nx>device_name</span><span class=s1>&#39;] = lookup[metric.tags[&#39;</span><span class=nx>device_ip</span><span class=s1>&#39;]]
</span></span></span><span class=line><span class=cl><span class=s1>    return metric
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>outputs</span><span class=p>.</span><span class=nx>file</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=nx>files</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;stdout&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>data_format</span> <span class=p>=</span> <span class=s2>&#34;influx&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>influx_sort_fields</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=nx>tagexclude</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;path&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>outputs</span><span class=p>.</span><span class=nx>http</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=nx>url</span> <span class=p>=</span> <span class=s2>&#34;https://grpc.api.kentik.eu/kmetrics/v202207/metrics/api/v2/write?bucket=&amp;org=&amp;precision=ns&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>data_format</span> <span class=p>=</span> <span class=s2>&#34;influx&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>influx_sort_fields</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=nx>tagexclude</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;path&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>outputs</span><span class=p>.</span><span class=nx>http</span><span class=p>.</span><span class=nx>headers</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>Content-Type</span> <span class=p>=</span> <span class=s2>&#34;application/influx&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>X-CH-Auth-Email</span> <span class=p>=</span> <span class=s2>&#34;${KENTIK_API_EMAIL}&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>X-CH-Auth-API-Token</span> <span class=p>=</span> <span class=s2>&#34;${KENTIK_API_TOKEN}&#34;</span></span></span></code></pre></div><p style=background-color:skyblue;text-align:center><b>eda/telegraf/telegraf.conf</b></p><hr><h2 class=heading-element id=moment-of-truth><span>Moment of Truth</span>
<a href=#moment-of-truth class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>After starting some manual mitigations, telegraf will ship the gnmi metrics to the Portal and those will be available under the <code>/devices/xrv9000/flowspec</code> custom schema path based on our configuration in the <a href=#telegraf-configuration><code>telegraf.conf</code></a>file.</p><p>Here is how it looks like in the Metrics Explorer<figure><a class=lightgallery href=/posts/modern-nms/mot.png title=/posts/modern-nms/mot.png data-thumbnail=/posts/modern-nms/mot.png data-sub-html="<h2>Flowspec metrics in the Portal</h2>"><img loading=lazy src=/posts/modern-nms/mot.png alt=/posts/modern-nms/mot.png height=920 width=2541></a><figcaption class=image-caption>Flowspec metrics in the Portal</figcaption></figure></p><p>Here are some console outputs from EDA running:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>** 2024-05-26 16:00:04.559137 [debug] ******************************************
</span></span><span class=line><span class=cl>Ignoring mitigation event
</span></span><span class=line><span class=cl>********************************************************************************
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>** 2024-05-26 16:00:18.406938 [debug] ******************************************
</span></span><span class=line><span class=cl>New manual/manualMitigating event received
</span></span><span class=line><span class=cl>ID: 10108
</span></span><span class=line><span class=cl>Platform: XR-FlowSpec
</span></span><span class=line><span class=cl>Method: Discard ICMP echo-request
</span></span><span class=line><span class=cl>IP: 10.10.10.11/32
</span></span><span class=line><span class=cl>********************************************************************************
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PLAY [::HANDLE MITIGATION EVENT::] *********************************************
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK [START::IS TELEGRAF RUNNING] **********************************************
</span></span><span class=line><span class=cl>ok: [localhost]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK [START::GENERATE TELEGRAF CONFIG] *****************************************
</span></span><span class=line><span class=cl>ok: [localhost]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK [START::BRING UP CONTAINER] ***********************************************
</span></span><span class=line><span class=cl>changed: [localhost]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK [STOP::GET ACTIVE ALERTS FROM KENTIK] *************************************
</span></span><span class=line><span class=cl>skipping: [localhost]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK [STOP::CHECK KENTIK FOR ACTIVE MITIGATIONS] *******************************
</span></span><span class=line><span class=cl>skipping: [localhost]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK [STOP::REMOVE TELEGRAF CONTAINER] *****************************************
</span></span><span class=line><span class=cl>skipping: [localhost]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PLAY RECAP *********************************************************************
</span></span><span class=line><span class=cl>localhost                  : ok=3    changed=1    unreachable=0    failed=0    skipped=3    rescued=0    ignored=0</span></span></code></pre></div><p style=background-color:skyblue;text-align:center><b>New mitigation</b></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>** 2024-05-26 16:10:20.682550 [debug] ******************************************
</span></span><span class=line><span class=cl>New manual/archived event received
</span></span><span class=line><span class=cl>ID: 10111
</span></span><span class=line><span class=cl>Platform: XR-FlowSpec
</span></span><span class=line><span class=cl>Method: Rate Limit 20k TCP SSH
</span></span><span class=line><span class=cl>IP: 10.10.10.15/32
</span></span><span class=line><span class=cl>********************************************************************************
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PLAY [::HANDLE MITIGATION EVENT::] *********************************************
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK [START::IS TELEGRAF RUNNING] **********************************************
</span></span><span class=line><span class=cl>skipping: [localhost]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK [START::GENERATE TELEGRAF CONFIG] *****************************************
</span></span><span class=line><span class=cl>skipping: [localhost]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK [START::BRING UP CONTAINER] ***********************************************
</span></span><span class=line><span class=cl>skipping: [localhost]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK [STOP::GET ACTIVE ALERTS FROM KENTIK] *************************************
</span></span><span class=line><span class=cl>ok: [localhost]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK [STOP::CHECK KENTIK FOR ACTIVE MITIGATIONS] *******************************
</span></span><span class=line><span class=cl>ok: [localhost] =&gt; {
</span></span><span class=line><span class=cl>    &#34;msg&#34;: [
</span></span><span class=line><span class=cl>        &#34;Current Active Mitigations on Platform ID#257: 3&#34;
</span></span><span class=line><span class=cl>    ]
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK [STOP::REMOVE TELEGRAF CONTAINER] *****************************************
</span></span><span class=line><span class=cl>skipping: [localhost]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PLAY RECAP *********************************************************************
</span></span><span class=line><span class=cl>localhost                  : ok=2    changed=0    unreachable=0    failed=0    skipped=4    rescued=0    ignored=0</span></span></code></pre></div><p style=background-color:skyblue;text-align:center><b>Stop mitigation while others are running</b></p><hr><h2 class=heading-element id=outro><span>Outro</span>
<a href=#outro class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>Well I hope this post was interesting enough and can be used as a reference while exploring the use cases covered:</p><ul><li>How to leverage Kentik EDA to receive Portal notifications and execute ansible playbooks</li><li>How to use telegraf to send custom ST metrics to Kentik NMS</li><li>Generating telegraf configuration dynamically</li></ul><p align=right><br><br><i>...till next time...have fun!!!</i></p><hr><h2 class=heading-element id=influences-and-reference><span>Influences and Reference</span>
<a href=#influences-and-reference class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><ul><li><a href=https://www.kentik.com/blog/driving-network-automation-innovation-kentik-and-red-hat-launch-integration/ target=_blank rel="external nofollow noopener noreferrer">Driving Network Automation Innovation: Kentik and Red Hat Launch Integration</a></li><li><a href=https://www.ansible.com/blog/getting-started-with-event-driven-ansible/ target=_blank rel="external nofollow noopener noreferrer">EDA Quickstart</a></li><li><a href=https://www.kentik.com/blog/using-telegraf-to-feed-api-json-data-into-kentik-nms/ target=_blank rel="external nofollow noopener noreferrer">Using Telegraf to Feed API JSON Data into Kentik NMS</a></li><li><a href=https://github.com/kentik/ansible_eda target=_blank rel="external nofollow noopener noreferrer">Kentik&rsquo;s ansible_eda</a></li><li><a href=https://github.com/becos76/kentik-eda target=_blank rel="external nofollow noopener noreferrer">Repo for this post</a></li></ul><hr></div><hr class=awesome-hr><h2 id=see-also>Related Content</h2><ul><li><a href=/posts/kustom-metrics/ title="K~ustom Metrics in Kentik NMS">K~ustom Metrics in Kentik NMS</a></li><li><a href=/posts/k8s-ansible/ title="K8s Ansible">K8s Ansible</a></li><li><a href=/posts/kube-my-router-pt3/ title="Kube My Router Up! - Last Part">Kube My Router Up! - Last Part</a></li><li><a href=/posts/kube-my-router-pt2/ title="Kube My Router Up! - Part Two">Kube My Router Up! - Part Two</a></li><li><a href=/posts/kube-my-router-pt1/ title="Kube My Router Up! - Part One">Kube My Router Up! - Part One</a></li></ul><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="Updated on 2024-06-01 00:00:00">Updated on 2024-06-01&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/modern-nms/index.md title="Read Markdown" class=link-to-markdown>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on X" data-sharer=twitter data-url=https://net4fungr.github.io/posts/modern-nms/ data-title="If This Ain't a Modern NMS, Then What Is?" data-via=mkaliotis data-hashtags="network monitoring,telemetry,ansible,automation"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://net4fungr.github.io/posts/modern-nms/><i class="fa-brands fa-linkedin fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://net4fungr.github.io/posts/modern-nms/><i class="fa-brands fa-reddit fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/network-monitoring/ class=post-tag title="Tags - Network Monitoring">Network Monitoring</a><a href=/tags/telemetry/ class=post-tag title="Tags - Telemetry">Telemetry</a><a href=/tags/ansible/ class=post-tag title="Tags - Ansible">Ansible</a><a href=/tags/automation/ class=post-tag title="Tags - Automation">Automation</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/kustom-metrics/ class=post-nav-item rel=prev title="K~ustom Metrics in Kentik NMS"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>K~ustom Metrics in Kentik NMS</a><a href=/posts/iou-love/ class=post-nav-item rel=next title="For Those About to LAB...⚡">For Those About to LAB...⚡<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment><script src=https://giscus.app/client.js data-repo=Net4FunGR/net4fungr.github.io data-repo-id=R_kgDOGLZFKQ data-category="Blog Comments" data-category-id=DIC_kwDOGLZFKc4Cf1aA data-mapping=title data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=en data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article><aside class=toc id=toc-auto aria-label=Contents><h2 class=toc-title>Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class="toc-content always-active" id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><div class="footer-line powered">Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.147.2"><img class=hugo-icon src=/images/hugo.min.svg alt="Hugo logo"> Hugo</a> | Theme - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.3.20"><img class=fixit-icon src=/images/fixit.min.svg alt="FixIt logo"> FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2021 - 2025</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/becos76 target=_blank rel="external nofollow noopener noreferrer">becos76</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label="View Comments"><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><a href=https://github.com/becos76/ title="Visit my GitHub" target=_blank rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true" width="56" height="56"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;top:0;--bg-progress:orange;--bg-progress-dark:grey></div><noscript><div class=noscript-warning>This website works best with JavaScript enabled.</div></noscript></div><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11.3.0/dist/mermaid.esm.min.mjs';
    
    
    
    window.mermaid = mermaid;
  </script><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=preload href=/lib/katex/katex.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/katex/katex.min.css></noscript><link rel=stylesheet href=/lib/pace/themes/blue/pace-theme-minimal.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/twemoji/twemoji.min.js defer></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/typeit/index.umd.js defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/pace/pace.min.js async defer></script><script>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:30},comment:{enable:!0,expired:!1,giscus:{darkTheme:"dark",lightTheme:"light",origin:"https://giscus.app"}},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},mermaid:{themes:["default","dark"]},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/search.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:3,noResultsFound:"No results found",snippetLength:30,threshold:.3,type:"fuse",useExtendedSearch:!1},twemoji:!0,typeit:{cursorChar:"|",cursorSpeed:1e3,duration:-1,loop:!1,speed:50},version:"v0.3.20"}</script><script src=/js/theme.min.js defer></script></body></html>