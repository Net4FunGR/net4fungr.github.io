<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>K8s Ansible</title><meta name=author content=" ">
<meta name=description content="Yet another post about using ansible to provision a kubernetes single control node cluster with kubeadm. We start off by manually provisioning the linux VMs in EVE-NG with a pre-defined username/passwd and dynamic IP addresses. Ansible takes care all the automation tasks to deploy the cluster on the VMs."><meta name=keywords content='k8s,ansible,automation'><meta itemprop=name content="k8s Ansible"><meta itemprop=description content="Yet another post about using ansible to provision a kubernetes single control node cluster with kubeadm. We start off by manually provisioning the linux VMs in EVE-NG with a pre-defined username/passwd and dynamic IP addresses. Ansible takes care all the automation tasks to deploy the cluster on the VMs."><meta itemprop=datePublished content="2022-07-06T15:36:24+03:00"><meta itemprop=dateModified content="2022-07-06T15:36:24+03:00"><meta itemprop=wordCount content="3096"><meta itemprop=image content="https://net4fungr.github.io/posts/k8s-ansible/featured-image.png"><meta itemprop=keywords content="K8s,Ansible,Automation"><meta property="og:url" content="https://net4fungr.github.io/posts/k8s-ansible/"><meta property="og:site_name" content="Becos :: Back Blog"><meta property="og:title" content="k8s Ansible"><meta property="og:description" content="Yet another post about using ansible to provision a kubernetes single control node cluster with kubeadm. We start off by manually provisioning the linux VMs in EVE-NG with a pre-defined username/passwd and dynamic IP addresses. Ansible takes care all the automation tasks to deploy the cluster on the VMs."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-06T15:36:24+03:00"><meta property="article:modified_time" content="2022-07-06T15:36:24+03:00"><meta property="article:tag" content="K8s"><meta property="article:tag" content="Ansible"><meta property="article:tag" content="Automation"><meta property="og:image" content="https://net4fungr.github.io/posts/k8s-ansible/featured-image.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://net4fungr.github.io/posts/k8s-ansible/featured-image.png"><meta name=twitter:title content="k8s Ansible"><meta name=twitter:description content="Yet another post about using ansible to provision a kubernetes single control node cluster with kubeadm. We start off by manually provisioning the linux VMs in EVE-NG with a pre-defined username/passwd and dynamic IP addresses. Ansible takes care all the automation tasks to deploy the cluster on the VMs."><meta name=twitter:site content="@mkaliotis"><meta name=twitter:creator content="@mkaliotis"><meta name=application-name content="Becos :: Back Blog"><meta name=apple-mobile-web-app-title content="Becos :: Back Blog"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel=canonical type=text/html href=https://net4fungr.github.io/posts/k8s-ansible/ title="k8s Ansible - Becos :: Back Blog"><link rel=prev type=text/html href=https://net4fungr.github.io/posts/proxy-or-not/ title="Proxy or not...here I come..."><link rel=next type=text/html href=https://net4fungr.github.io/posts/xr-get-xpath/ title="IOS-XR :: Get Your XPATHs, Get Your XPATHs Honey"><link rel=alternate type=text/markdown href=https://net4fungr.github.io/posts/k8s-ansible/index.md title="k8s Ansible - Becos :: Back Blog"><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><meta name=google-site-verification content="m_enMQYWx1a1cSKPfRT_00wHfqT8ir4PZSBPyeaIH-o"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"k8s Ansible","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/net4fungr.github.io\/posts\/k8s-ansible\/"},"genre":"posts","keywords":"k8s, ansible, automation","wordcount":3096,"url":"https:\/\/net4fungr.github.io\/posts\/k8s-ansible\/","datePublished":"2022-07-06T15:36:24+03:00","dateModified":"2022-07-06T15:36:24+03:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":" "},"description":""}</script><script src=/js/head/color-scheme.min.js></script></head><body data-header-desktop=sticky data-header-mobile=auto><div class=wrapper data-page-style=narrow><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=right><div class=header-title><a href=/ title="Becos :: Back Blog"><img class=logo src=/images/pyrtr_small.png alt="Becos :: Back Blog" height=32 width=32><span class=header-title-pre><</span><span class=header-title-text>...ssh and blog...</span><span class=header-title-post>/></span></a><span class="typeit header-subtitle"><template>revamped!</template></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/categories/ title="Posts Organised by Category"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> Categories</a></li><li class=menu-item><a class=menu-link href=/collections/ title="Multipart Posts"><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> Collections</a></li><li class=menu-item><a class=menu-link href=/archives/ title="All My Posts"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> Archives</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> Tags</a></li><li class=menu-item><a class=menu-link href=https://becos76.github.io title="About Me" rel="noopener noreferrer" target=_blank><i class="fa-solid fa-signature fa-fw fa-sm" aria-hidden=true></i> About</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder="Search titles or contents ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Becos :: Back Blog"><img class=logo src=/images/pyrtr_small.png alt="Becos :: Back Blog" height=26 width=26><span class=header-title-pre><</span><span class=header-title-text>...ssh and blog...</span><span class=header-title-post>/></span></a><span class="typeit header-subtitle"><template>revamped!</template></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></li><li class=menu-item><a class=menu-link href=/categories/ title="Posts Organised by Category"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> Categories</a></li><li class=menu-item><a class=menu-link href=/collections/ title="Multipart Posts"><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> Collections</a></li><li class=menu-item><a class=menu-link href=/archives/ title="All My Posts"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> Archives</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> Tags</a></li><li class=menu-item><a class=menu-link href=https://becos76.github.io title="About Me" rel="noopener noreferrer" target=_blank><i class="fa-solid fa-signature fa-fw fa-sm" aria-hidden=true></i> About</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=Collections><div class="details related-details open"><div class="details-summary related-summary"><i class="fa-solid fa-fire fa-fade text-danger fa-fw" aria-hidden=true></i>
<span class=related-title>Related Content</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class="details-content related-content"><ul class=related-list><li class=related-item><a href=/posts/kube-my-router-pt3/ title="Kube My Router Up! - Last Part">Kube My Router Up! - Last Part</a></li><li class=related-item><a href=/posts/kube-my-router-pt2/ title="Kube My Router Up! - Part Two">Kube My Router Up! - Part Two</a></li><li class=related-item><a href=/posts/kube-my-router-pt1/ title="Kube My Router Up! - Part One">Kube My Router Up! - Part One</a></li><li class=related-item><a href=/posts/mutable-immutable/ title="Mutable vs. Immutable">Mutable vs. Immutable</a></li><li class=related-item><a href=/posts/declarative-imperative/ title="Declarative vs. Imperative">Declarative vs. Imperative</a></li></ul></div></div></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>K8s Ansible</span></h1><p class="single-subtitle animate__animated animate__fadeIn">Yet Another Ansible Playbook for k8s Cluster Deployment</p></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i>
</span></span><span class=post-included-in>&nbsp;included in <a href=/categories/ansible/ class=post-category title="Category - Ansible"><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> Ansible</a></span></div><div class=post-meta-line><span title="published on 2022-07-06 15:36:24"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2022-07-06>2022-07-06</time></span>&nbsp;<span title="3096 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>About 3100 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>15 minutes</span>&nbsp;</div></div><div class=featured-image><img src=/posts/k8s-ansible/featured-image.png alt=/posts/k8s-ansible/featured-image.png></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#intro>Intro</a></li><li><a href=#the-intent>The Intent</a></li><li><a href=#playbook-overview>Playbook Overview</a><ul><li><a href=#directory-layout>Directory Layout</a></li><li><a href=#ansible-key-files-overview>Ansible key files overview</a></li><li><a href=#ansible-modules-in-play>Ansible modules in play</a></li></ul></li><li><a href=#phased-execution>Phased Execution</a><ul><li><a href=#the-check-phase>The <em>check</em> phase</a></li><li><a href=#the-init-phase-steps-01-and-02>The <em>init</em> phase (Steps 01 and 02)</a></li><li><a href=#the-pre-deploy-phase-step-03>The <em>pre-deploy</em> phase (Step 03)</a></li><li><a href=#the-deploy-phase-step-04>The <em>deploy</em> phase (Step 04)</a></li></ul></li><li><a href=#optimisations>Optimisations</a></li></ul></nav></div></div><div class=content id=content><h2 class=heading-element id=intro><span>Intro</span>
<a href=#intro class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><hr><p>Throughout this post, I am documenting my ansible orientation and ramping-up process towards automating the provisioning of a k8s cluster on ubuntu linux. I believe it is not something too fancy or something that has not been visited over and over again in various other posts, but this is the scrub of my exposure with ansible automation. I tried to make it modular with several playbook imports and task includes executed from a <em>parent</em> playbook file, rather than having a single long playbook. Ansible <em>roles</em> are not leveraged &#x1f601;. The <em>code</em> for this project can be found <a href=https://github.com/becos76/k8s_ansible/ target=_blank rel="external nofollow noopener noreferrer">here</a>.</p><hr><h2 class=heading-element id=the-intent><span>The Intent</span>
<a href=#the-intent class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><hr><p>Let&rsquo;s begin by setting the in-scope items for the project:</p><ul><li>Ubuntu 20.04 VMs based on cloud images provisioned with a known username/passwd and assigned DHCP IPv4 addresses. (Setting up the VMs <a href=/posts/kube-my-router-pt1>reference</a>)</li><li>Kubernetes single node cluster version 1.22</li><li>Docker CRI</li><li>Flannel CNI</li><li>Single playbook which calls subsequent playbooks and task lists at runtime</li><li>Kubeadm for cluster setup</li></ul><hr><h2 class=heading-element id=playbook-overview><span>Playbook Overview</span>
<a href=#playbook-overview class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><hr><p>The following mindmap diagram represents the automation tasks flows. <span style=color:red>Red </span>lines represent imported playbook files. <span style=color:green>Green </span>lines are included task lists files, and <span style=color:#7a28ff>blue </span>lines are the actual tasks to be executed.</p><figure><a class=lightgallery href=/posts/k8s-ansible/play_mmap.png title=/posts/k8s-ansible/play_mmap.png data-thumbnail=/posts/k8s-ansible/play_mmap.png data-sub-html="<h2>k8s Ansible Playbook Flow</h2>"><img loading=lazy src=/posts/k8s-ansible/play_mmap.png alt=/posts/k8s-ansible/play_mmap.png height=1062 width=800></a><figcaption class=image-caption>k8s Ansible Playbook Flow</figcaption></figure><p>In short, we start from a single playbook file called <em>start.yml</em> and we have broken down our flow in three phases. The <em><strong>init</strong></em> phase covers Steps 01 and 02, and refer to assigning static IPs to our dynamic VMs. Step 01 is about building the mapping from DHCP to Static IPs of our nodes and generating the relevant <em>netplan</em> configuration files using a jinja2 template. Step 02 covers the application of these configuration files to the VMs.</p><p>Next, is the <em><strong>pre-deployment</strong></em> phase, or Step 03, which is about preparing the VMs for k8s deployment, i.e. setting hostnames, establishing SSH key authentication with ansible, upgrading, etc.</p><p>The final phase is the <em><strong>deployment</strong></em> one, where we call our tasks to deploy the k8s cluster upon the relevant control and worker nodes.</p><p>The <em><strong>check</strong></em> phase, although not depicted in the flow, is a very important one during which we do our environment pre-checks in order for the playbook to be executed successfully, i.e. are all hosts declared properly in the ansible hosts file, are all variables declared as they should be,etc.</p><p>Let&rsquo;s expand on the directory structure in order to make things more explicit.</p><hr><h3 class=heading-element id=directory-layout><span>Directory Layout</span>
<a href=#directory-layout class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><hr><p>Here is how the tree of our ansible playbook <em>home</em> directory looks like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>.
</span></span><span class="line hl"><span class=cl>├── .secrets -------------------&lt; Custom directory to hold sensitive data
</span></span><span class=line><span class=cl>│   ├── passwd.yml -------------&lt; Encrypted secrets file
</span></span><span class=line><span class=cl>│   └── vault_passwd -----------&lt; Ansible-vault clear text password
</span></span><span class=line><span class=cl>├── ansible.cfg ----------------&lt; ansible configuration file
</span></span><span class=line><span class=cl>├── checks.yml -----------------&lt; <span class=s2>&#34;Pre-checks&#34;</span> playbook - Step <span class=m>00</span>
</span></span><span class="line hl"><span class=cl>├── configs --------------------&lt; Directory to store generated static ip netplan files
</span></span><span class=line><span class=cl>├── deployment.yml -------------&lt; <span class=s2>&#34;Deploy&#34;</span> phase playbook - Step <span class=m>04</span>
</span></span><span class=line><span class=cl>├── hosts ----------------------&lt; ansible inventory file in ini format
</span></span><span class=line><span class=cl>├── init_play.yml --------------&lt; <span class=s2>&#34;Init&#34;</span> phase playbook - Step <span class=m>01</span>
</span></span><span class=line><span class=cl>├── pre_deploy.yml -------------&lt; <span class=s2>&#34;Pre-deploy&#34;</span> phase playbook - Step <span class=m>03</span>
</span></span><span class=line><span class=cl>├── start.yml ---------------&gt;&gt;&gt;&gt; <span class=s2>&#34;Master&#34;</span> playbook
</span></span><span class="line hl"><span class=cl>├── tasks ----------------------&lt; Folder to hold all task lists files arranged per phase
</span></span><span class="line hl"><span class=cl>│   ├── deploy
</span></span><span class=line><span class=cl>│   │   ├── boot_control.yml
</span></span><span class=line><span class=cl>│   │   ├── cni.yml
</span></span><span class=line><span class=cl>│   │   ├── cri.yml
</span></span><span class=line><span class=cl>│   │   ├── packages_general.yml
</span></span><span class=line><span class=cl>│   │   ├── packages_kube.yml
</span></span><span class=line><span class=cl>│   │   ├── swap.yml
</span></span><span class=line><span class=cl>│   │   └── workers.yml
</span></span><span class="line hl"><span class=cl>│   ├── init
</span></span><span class=line><span class=cl>│   │   └── apply_netplan.yml --&lt; Step <span class=m>02</span> playbook
</span></span><span class="line hl"><span class=cl>│   └── pre
</span></span><span class=line><span class=cl>│       ├── cloud-init.yml
</span></span><span class=line><span class=cl>│       ├── hostname.yml
</span></span><span class=line><span class=cl>│       ├── hosts.yml
</span></span><span class=line><span class=cl>│       ├── reboot.yml
</span></span><span class=line><span class=cl>│       ├── sshkeys.yml
</span></span><span class=line><span class=cl>│       ├── sudo.yml
</span></span><span class=line><span class=cl>│       └── upgrade.yml
</span></span><span class="line hl"><span class=cl>├── templates ------------------&lt; Templates default folder
</span></span><span class=line><span class=cl>│   └── netplan.j2
</span></span><span class="line hl"><span class=cl>└── vars -----------------------&lt; Custom directory to host variables
</span></span><span class=line><span class=cl>    └── netplan.yml</span></span></code></pre></div><p>Below is the ansible configuration file where we define which file contains the inventory. We instruct ansible not complain if the SSH target hosts are not known. For facts gathering, we only need the network facts and not the hardware ones. We define where is the encryption password for ansible-vault. The <em>callback_whitelist</em> is very useful if we want to see timing statistics of our playbook execution.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dosini data-lang=dosini><span class=line><span class=cl><span class=k>[defaults]</span>
</span></span><span class=line><span class=cl><span class=na>inventory</span> <span class=o>=</span> <span class=s>hosts</span>
</span></span><span class=line><span class=cl><span class=na>host_key_checking</span> <span class=o>=</span> <span class=s>False</span>
</span></span><span class=line><span class=cl><span class=na>gather_subset</span><span class=o>=</span><span class=s>!hardware, network</span>
</span></span><span class=line><span class=cl><span class=na>vault_password_file</span><span class=o>=</span><span class=s>.secrets/vault_passwd</span>
</span></span><span class=line><span class=cl><span class=c1>#callback_whitelist = timer, profile_tasks</span></span></span></code></pre></div><p style=background-color:#00bfff;text-align:center><b>ansible.cfg</b></p><h3 class=heading-element id=ansible-key-files-overview><span>Ansible key files overview</span>
<a href=#ansible-key-files-overview class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>Here is our inventory file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dosini data-lang=dosini><span class=line><span class=cl><span class=k>[all:vars]</span>
</span></span><span class=line><span class=cl><span class=na>ansible_ssh_common_args</span><span class=o>=</span><span class=s>&#39;-o UserKnownHostsFile=/dev/null&#39;</span>
</span></span><span class=line><span class=cl><span class=na>ansible_user</span><span class=o>=</span><span class=s>ubuntu</span>
</span></span><span class=line><span class=cl><span class=na>ansible_ssh_private_key_file</span><span class=o>=</span><span class=s>~/.ssh/id_ansible</span>
</span></span><span class=line><span class=cl><span class=na>k8s_version</span><span class=o>=</span><span class=s>1.22.10</span>
</span></span><span class=line><span class=cl><span class=na>k8s_pod_cidr</span><span class=o>=</span><span class=s>10.244.0.0/16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[control]</span>
</span></span><span class=line><span class=cl><span class=na>kates-control ansible_host</span><span class=o>=</span><span class=s>192.168.1.40</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[workers]</span>
</span></span><span class=line><span class=cl><span class=na>kates-node-01 ansible_host</span><span class=o>=</span><span class=s>192.168.1.41</span>
</span></span><span class=line><span class=cl><span class=na>kates-node-02 ansible_host</span><span class=o>=</span><span class=s>192.168.1.42</span>
</span></span><span class=line><span class=cl><span class=na>kates-node-03 ansible_host</span><span class=o>=</span><span class=s>192.168.1.43</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[dhcp_hosts]</span>
</span></span><span class=line><span class=cl><span class=na>192.168.1.203</span>
</span></span><span class=line><span class=cl><span class=na>192.168.1.206</span>
</span></span><span class=line><span class=cl><span class=na>192.168.1.208</span>
</span></span><span class=line><span class=cl><span class=na>192.168.1.209</span></span></span></code></pre></div><p style=background-color:#00bfff;text-align:center><b>hosts</b></p><p>We split our targets into three groups and declare common variables in the <em>all</em> section. The <em>ansible_ssh_common_args</em> variable prevents ansible to complain about host key changes, since these VMs were re-provisioned a lot of times during testing the playbook and were getting the same DHCP addresses. We declare here the SSH user that is used for the initial connection to the <em>dynamic</em> hosts till the point that these hosts are assigned static IPs and configured with an SSH public key in order for ansible to continue further with the tasks.</p><p>The <em>passwd.yml</em> file contains the passwords that ansible will use for SSH and <em>sudo</em> access on the targets. These are used initially and then <em>publickey</em> and sudoless access is enabled.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ansible-vault view .secrets/passwd.yml
</span></span><span class=line><span class=cl>ansible_sudo_pass: <span class=s2>&#34;ubuntu123&#34;</span>
</span></span><span class=line><span class=cl>ansible_become_pass: <span class=s2>&#34;ubuntu123&#34;</span>
</span></span><span class=line><span class=cl>ansible_ssh_pass: <span class=s2>&#34;ubuntu123&#34;</span></span></span></code></pre></div><p style=background-color:#00bfff;text-align:center><b>.secrets/passwd.yml</b></p><p>Let&rsquo;s now check the variables file that will be loaded during play runtime.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>netplan</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>gateway4</span><span class=p>:</span><span class=w> </span><span class=m>192.168.1.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>subnet</span><span class=p>:</span><span class=w> </span><span class=m>24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=m>192.168.1.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=m>8.8.8.8</span></span></span></code></pre></div><p style=background-color:#00bfff;text-align:center><b>vars/netplan.yml</b></p><p>It is a dictionary containing all variables needed to populate the <em>jinja2</em> template and produce the respective netplan configuration file that will enable assigning static ip to our hosts.</p><p>Here is the <em>jinja2</em> template file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jinja data-lang=jinja><span class=line><span class=cl><span class=x>network:
</span></span></span><span class=line><span class=cl><span class=x>    ethernets:
</span></span></span><span class=line><span class=cl><span class=x>        </span><span class=cp>{{</span> <span class=nv>item.intf</span> <span class=cp>}}</span><span class=x>:
</span></span></span><span class=line><span class=cl><span class=x>          dhcp4: false
</span></span></span><span class=line><span class=cl><span class=x>          dhcp6: false
</span></span></span><span class=line><span class=cl><span class=x>          addresses: [</span><span class=cp>{{</span> <span class=nv>item.newIP</span> <span class=cp>}}</span><span class=x>/</span><span class=cp>{{</span> <span class=nv>netplan.subnet</span> <span class=cp>}}</span><span class=x>]
</span></span></span><span class=line><span class=cl><span class=x>          gateway4: </span><span class=cp>{{</span> <span class=nv>netplan.gateway4</span> <span class=cp>}}</span><span class=x>
</span></span></span><span class=line><span class=cl><span class=x>          nameservers:
</span></span></span><span class=line><span class=cl><span class=x>             addresses: [</span><span class=cp>{%</span> <span class=k>for</span> <span class=nv>dns</span> <span class=k>in</span> <span class=nv>netplan.dns</span> <span class=cp>%}{{</span><span class=nv>dns</span><span class=cp>}}{%</span>- <span class=k>if</span> <span class=k>not</span> <span class=nb>loop</span><span class=nv>.last</span> <span class=cp>%}</span><span class=x>, </span><span class=cp>{%</span> <span class=k>endif</span> <span class=cp>%}{%</span> <span class=k>endfor</span> <span class=cp>%}</span><span class=x>]
</span></span></span><span class=line><span class=cl><span class=x>    version: 2</span></span></span></code></pre></div><p style=background-color:#00bfff;text-align:center><b>templates/netplan.j2</b></p><p>So, this template will iterate over a list of dictionaries that will be created in runtime containing a mapping of <em>dynamic</em> IP to <em>static</em> one along with the <em>netplan</em> variables for each hosts. The outcome will be a netplan config file that will be placed and applied on the target host.<div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fa-fw fa-solid fa-pencil-alt" aria-hidden=true></i>Note<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>For DNS entries, since we can have more than one, we append a <em>comma</em> if it is not the last item in order to build the list.</div></div></div></p><p>Last but not least, here is the <em>master</em> playbook, or <code>playbook zero</code> that I like to call it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#!/usr/bin/env ansible-playbook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ONE PLAY TO CONTROL ALL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;! ################# CHECK :: PRE-FLIGHT CHECKING ################### !&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>import_playbook</span><span class=p>:</span><span class=w> </span><span class=l>checks.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;! ################# INIT :: PREPARE FOR STATIC IPs ################# !&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>import_playbook</span><span class=p>:</span><span class=w> </span><span class=l>init_play.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;! ################# INIT :: CHANGE TO STATIC IPs ################### !&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>import_playbook</span><span class=p>:</span><span class=w> </span><span class=l>tasks/init/apply_netplan.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;! ################# PRE :: PERFORM PRE-DEPLOYMENT TASKS ############ !&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>import_playbook</span><span class=p>:</span><span class=w> </span><span class=l>pre_deploy.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;! ################# DEPLOY :: PERFORM DEPLOYMENT TASKS ############# !&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>import_playbook</span><span class=p>:</span><span class=w> </span><span class=l>deployment.yml</span></span></span></code></pre></div><p style=background-color:#00bfff;text-align:center><b>start.yml</b></p><p>Pretty straight forward. It is just importing all other playbooks one by one &#x1f604;</p><hr><h3 class=heading-element id=ansible-modules-in-play><span>Ansible modules in play</span>
<a href=#ansible-modules-in-play class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><hr><p>The following table lists all ansible modules used in this project in alphabetical order along with a short description on their use.</p><table><thead><tr><th>Short Name</th><th>FQCN</th><th>Description</th></tr></thead><tbody><tr><td>apt</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.apt</a></td><td>Manages <em>apt</em> packages in Debian/Ubuntu distros</td></tr><tr><td>apt_key</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_key_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.apt_key</a></td><td>Manages keys in <em>apt</em> keyring</td></tr><tr><td>apt_repository</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_repository_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.apt_repository</a></td><td>Manages <em>apt</em> repositories</td></tr><tr><td>assert</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/assert_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.assert</a></td><td>Evaluates if given expressions are true</td></tr><tr><td>authorized_key</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/posix/authorized_key_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.posix.authorized_key</a></td><td>Manages SSH authorized keys of user accounts</td></tr><tr><td>blockinfile</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/blockinfile_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.blockinfile</a></td><td>Manages a block of multi-line text surrounded by customizable marker lines in files</td></tr><tr><td>command</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/command_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.command</a></td><td>Executes commands on linux targets without invoking a shell</td></tr><tr><td>copy</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/copy_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.copy</a></td><td>Copy files to remote linux locations</td></tr><tr><td>debug</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/debug_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.debug</a></td><td>Print statements during execution and can be useful for debugging variables or expressions without necessarily halting the playbook</td></tr><tr><td>file</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/file_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.file</a></td><td>Manage files, attributes of files, symlinks or directories in linux nodes</td></tr><tr><td>hostname</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/hostname_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.hostname</a></td><td>Set the hostname in most linux distros</td></tr><tr><td>import_playbook</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/import_playbook_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.import_playbook</a></td><td>Imports a playbook file in the current playbook for execution</td></tr><tr><td>include_tasks</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/include_tasks_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.include_tasks</a></td><td>Dynamically includes a file with a list of tasks to be executed in the current playbook</td></tr><tr><td>include_vars</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/include_vars_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.include_vars</a></td><td>Loads YAML/JSON variables dynamically from a file or directory, recursively, during task runtime</td></tr><tr><td>lineinfile</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/lineinfile_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.lineinfile</a></td><td>Manage lines in a text file</td></tr><tr><td>meta</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/meta_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.meta</a></td><td>Execute ansible <em>actions</em></td></tr><tr><td>openssh_keypair</td><td><a href=https://docs.ansible.com/ansible/latest/collections/community/crypto/openssh_keypair_module.html target=_blank rel="external nofollow noopener noreferrer">community.crypto.openssh_keypair</a></td><td>(Re)Generate OpenSSH private and public keys</td></tr><tr><td>reboot</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/reboot_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.reboot</a></td><td>Reboot a machine, wait for it to go down, come back up, and respond to commands</td></tr><tr><td>replace</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/replace_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.replace</a></td><td>Replace all instances of a particular string in a file using a back-referenced regular expression</td></tr><tr><td>set_fact</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/set_fact_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.set_fact</a></td><td>Set host variable(s) and fact(s)</td></tr><tr><td>setup</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/setup_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.setup</a></td><td>Gathers facts about remote hosts</td></tr><tr><td>shell</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.shell</a></td><td>Execute shell commands on targets</td></tr><tr><td>stat</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/stat_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.stat</a></td><td>Retrieve file or file system status</td></tr><tr><td>systemd</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/systemd_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.systemd</a></td><td>Manage systemd units</td></tr><tr><td>template</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/template_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.template</a></td><td>Template a file out to a target host using <em>jinja2</em></td></tr><tr><td>user</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/user_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.user</a></td><td>Manage user accounts and user attributes</td></tr><tr><td>wait_for</td><td><a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/wait_for_module.html target=_blank rel="external nofollow noopener noreferrer">ansible.builtin.wait_for</a></td><td>Waits for a condition before continuing</td></tr></tbody></table><hr><h2 class=heading-element id=phased-execution><span>Phased Execution</span>
<a href=#phased-execution class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><hr><p>Let&rsquo;s delve a bit deeper on the phases now. We will just analyse some key tasks to make the logic more explicit.</p><hr><h3 class=heading-element id=the-check-phase><span>The <em>check</em> phase</span>
<a href=#the-check-phase class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><hr><p>As previously states, during this phase we are aiming to check if all variables, files, and configurations are how they are supposed to be, or better how are playbooks want them to be in order to execute correctly. The most popular modules used here are those of <em>debug</em> and <em>assert</em>.</p><p>Let&rsquo;s see for example a simple check on the inventory groups:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>INVENTORY CHECK - SINGLE CONTROL NODE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>debug</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;control group is not correctly populated for a single (1) control node&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>(not groups.control) or (groups.control|length &gt; 1)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>failed_when</span><span class=p>:</span><span class=w> </span><span class=l>(not groups.control) or (groups.control|length &gt; 1)</span></span></span></code></pre></div><p>What we do here is making sure the group <em>control</em> is defined and it contains only one target host definition, since we are deploying a single control node cluster. This task will be executed only <code>when</code> the condition we are checking is <em>false</em> and will be declared as failed using the <code>failed_when</code> clause.</p><p>Another simple example is using <em>assert</em>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>CHECK QUANTITIES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>assert</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>that</span><span class=p>:</span><span class=w> </span><span class=l>groups.dhcp_hosts|length == (groups.control+groups.workers)|length</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>quiet</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>fail_msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Number of DHCP hosts cannot be different of number of K8s nodes&#34;</span></span></span></code></pre></div><p>Here, we are checking that we have the same number of <em>dynamic</em> hosts defined as the total number of k8s nodes, workers and control nodes together, since there will be a one-to-one mapping in the configuration and deployment.</p><p>Now, let&rsquo;s see how we check the variables file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>CHECK FOR NETPLAN VARIABLES FILE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stat</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;ansible.builtin.env&#39;, &#39;PWD&#39;) }}/vars/netplan.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>netplan_file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class=l>msg=&#34;Netplan variables file is not found&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>not netplan_file.stat.exists</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>failed_when</span><span class=p>:</span><span class=w> </span><span class=l>not netplan_file.stat.exists</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>INCLUDING NETPLAN VARIABLES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>include_vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dir</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;ansible.builtin.env&#39;, &#39;PWD&#39;) }}/vars&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>files_matching</span><span class=p>:</span><span class=w> </span><span class=l>netplan.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>CHECKING NETPLAN VARIABLES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>assert</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>that</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>netplan is defined and netplan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>netplan.gateway4 is defined and netplan.gateway4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>netplan.subnet is defined and netplan.subnet|int &gt; 0 and netplan.subnet &lt;= 31</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>netplan.dns is defined and netplan.dns</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>quiet</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>fail_msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Make sure all netplan variables are defined correctly&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>success_msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Looks Good!&#34;</span></span></span></code></pre></div><p>So, we use <em>stat</em> and <em>debug</em> to make sure that the file exists in the correct directory. Then we <em>load</em> it in the play with <em>include_vars</em> so we can have access to the variables, and finally we check the values with <em>assert</em>.</p><p>Finally, using <em>wait_for</em> we check if there is connectivity to the target hosts and act accordingly. We need the <em>dynamic_hosts</em> to be alive and the k8s node&rsquo;s IPs to be unreachable.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>CHECK SSH CONNECTIVITY TO DHCP HOSTS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>wait_for</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{item}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>search_regex</span><span class=p>:</span><span class=w> </span><span class=l>OpenSSH</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>delay</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{groups.dhcp_hosts}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>CHECK SSH CONNECTIVITY TO K8S NODES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>wait_for</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{hostvars[item].ansible_host}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>search_regex</span><span class=p>:</span><span class=w> </span><span class=l>OpenSSH</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>delay</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=l>Should not be alive</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{groups.control+groups.workers}}&#34;</span></span></span></code></pre></div><hr><h3 class=heading-element id=the-init-phase-steps-01-and-02><span>The <em>init</em> phase (Steps 01 and 02)</span>
<a href=#the-init-phase-steps-01-and-02 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><hr><p>This phase calls two playbook files. As Step 01, we build the <em>dynamic</em> host mapping to <em>static</em> k8s node and we create the netplan config files for the hosts locally, thus this playbook is run against localhost. As Step 02, we upload the netplan files and apply the new configuration on the targets.</p><p>Here is the playbook for the first step:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#!/usr/bin/env ansible-playbook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;! ################# INIT :: PREPARE FOR STATIC IPs ################# !&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars_files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>.secrets/passwd.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>vars/netplan.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>GET FACTS OF DHCP NODES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>setup</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>delegate_facts</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{groups.dhcp_hosts}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PREPARE STATIC MAPPINGS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>set_fact</span><span class=p>:</span><span class=w> </span><span class=l>dhcp_map=&#34;{{ dhcp_map|default([]) + </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                       </span><span class=p>[</span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                       </span><span class=s1>&#39;oldIP&#39;</span><span class=p>:</span><span class=l>hostvars[item.0].ansible_default_ipv4.address,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                       </span><span class=s1>&#39;intf&#39;</span><span class=p>:</span><span class=l>hostvars[item.0].ansible_default_ipv4.interface,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                       </span><span class=s1>&#39;newIP&#39;</span><span class=p>:</span><span class=l>hostvars[item.1].ansible_host</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                       </span>}<span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                       </span>}}<span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    loop: &#34;</span>{{<span class=l>groups.dhcp_hosts|zip(groups.control+groups.workers)|list}}&#34;                    </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>GENERATE NETPLAN CONFIGS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=l>netplan.j2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=l>configs/netplan.{{item.oldIP}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{dhcp_map}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span></span></span></code></pre></div><p style=background-color:#00bfff;text-align:center><b>init_play.yml</b></p><p>We use the <em>setup</em> module to connect to <em>dhcp_hosts</em> and gather their facts. We are interested in their IPv4 assigned address and the network interface name. We then use <em>set_fact</em> to build our list of dictionaries in order to use it for <em>jinja2</em> template config creation.</p><p>A sample of the list of dictionaries looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nt>&#34;oldIP&#34;</span><span class=p>:</span><span class=s2>&#34;192.168.1.203&#34;</span><span class=p>,</span><span class=nt>&#34;intf&#34;</span><span class=p>:</span><span class=s2>&#34;ens3&#34;</span><span class=p>,</span><span class=nt>&#34;newIP&#34;</span><span class=p>:</span><span class=s2>&#34;192.168.1.40&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nt>&#34;oldIP&#34;</span><span class=p>:</span><span class=s2>&#34;192.168.1.204&#34;</span><span class=p>,</span><span class=nt>&#34;intf&#34;</span><span class=p>:</span><span class=s2>&#34;ens3&#34;</span><span class=p>,</span><span class=nt>&#34;newIP&#34;</span><span class=p>:</span><span class=s2>&#34;192.168.1.41&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nt>&#34;oldIP&#34;</span><span class=p>:</span><span class=s2>&#34;192.168.1.205&#34;</span><span class=p>,</span><span class=nt>&#34;intf&#34;</span><span class=p>:</span><span class=s2>&#34;ens3&#34;</span><span class=p>,</span><span class=nt>&#34;newIP&#34;</span><span class=p>:</span><span class=s2>&#34;192.168.1.42&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nt>&#34;oldIP&#34;</span><span class=p>:</span><span class=s2>&#34;192.168.1.206&#34;</span><span class=p>,</span><span class=nt>&#34;intf&#34;</span><span class=p>:</span><span class=s2>&#34;ens3&#34;</span><span class=p>,</span><span class=nt>&#34;newIP&#34;</span><span class=p>:</span><span class=s2>&#34;192.168.1.43&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div><p>Once the list is populated, we use the <em>template</em> module to get the configuration files and output them in the <em>configs</em> directory appending the &ldquo;OldIP&rdquo; to the filename.</p><p>As a second step, we apply the configs to our target hosts by getting the netplan filename and replacing it with the respective netplan config file generated in the previous step. We make the change and wait for connectivity to the static IPs.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#!/usr/bin/env ansible-playbook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;! ################# INIT :: CHANGE TO STATIC IPs ################### !&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>dhcp_hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars_files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;{{inventory_dir}}/.secrets/passwd.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>GET NETPLAN FILENAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=l>ls /etc/netplan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>netplan_file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>UPLOAD NETPLAN CONFIGS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>copy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>content</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{lookup(&#39;file&#39;, &#39;{{inventory_dir}}/configs/netplan.{{ansible_host}}&#39;)}}\n&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/etc/netplan/{{netplan_file.stdout}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>APPLY NETPLAN SETTINGS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>netplan apply</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>async</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>poll</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>CHECK CONNECTIVITY TO STATIC IPs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>wait_for</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{hostvars[item].ansible_host}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>search_regex</span><span class=p>:</span><span class=w> </span><span class=l>OpenSSH</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>delay</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=m>120</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loop</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{groups.control+groups.workers}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>connection</span><span class=p>:</span><span class=w> </span><span class=l>local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run_once</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span></span></span></code></pre></div><p style=background-color:#00bfff;text-align:center><b>tasks/init/apply_netplan.yml</b></p><hr><h3 class=heading-element id=the-pre-deploy-phase-step-03><span>The <em>pre-deploy</em> phase (Step 03)</span>
<a href=#the-pre-deploy-phase-step-03 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><hr><p>Now that we have established that our targets will use their final static IPs, we are going to perform some tasks to prepare them for k8s deployment.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#!/usr/bin/env ansible-playbook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;! ################# PRE :: PERFORM PRE-DEPLOYMENT TASKS ################### !&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>all:!dhcp_hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#any_errors_fatal: no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars_files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>.secrets/passwd.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;======================== SSH KEYS ========================&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=l>tasks/pre/sshkeys.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;======================== SUDO ============================&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=l>tasks/pre/sudo.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;======================== CLOUD-INIT ======================&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=l>tasks/pre/cloud-init.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;======================== HOSTNAMES =======================&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=l>tasks/pre/hostname.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;======================== HOSTS FILES =====================&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=l>tasks/pre/hosts.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;======================== UPDATE/UPGRADE ==================&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=l>tasks/pre/upgrade.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;======================== REBOOT ========================-&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=l>tasks/pre/reboot.yml  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>debug</span><span class=p>:</span><span class=w> </span><span class=l>msg=&#34;\u2705 NODE READY FOR DEPLOYMENT&#34;</span></span></span></code></pre></div><p style=background-color:#00bfff;text-align:center><b>pre_deploy.yml</b></p><p>We first generate an SSH key on localhost and distribute it to all the nodes in order for ansible to access them without using the user password. Then we enable passwordless sudo access for the ansible user. We disable cloud-init if the service is there. Set the correct hostname and configure all k8s nodes in the hosts files, and, finally perform pings between hosts to verify that name resolution and connectivity is successful.</p><hr><h3 class=heading-element id=the-deploy-phase-step-04><span>The <em>deploy</em> phase (Step 04)</span>
<a href=#the-deploy-phase-step-04 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><hr><p>The last phase is to deploy the k8s cluster.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#!/usr/bin/env ansible-playbook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>K8S DEPLOYMENT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>all:!dhcp_hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars_files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>.secrets/passwd.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;======================== PRE-REQUISITES ===================&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=l>tasks/deploy/packages_general.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>apply</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;======================== TURN OFF SWAP ====================&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=l>tasks/deploy/swap.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;======================== DOCKER CRI =======================&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=l>tasks/deploy/cri.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>apply</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;======================== KUBE PACKAGES ====================&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=l>tasks/deploy/packages_kube.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>apply</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;======================= PREPARE THE CONTROL NODE ==========&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>block</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;======================== INIT CONTROL NODE ==========&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=l>tasks/deploy/boot_control.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;======================== DEPLOY CNI =================&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=l>tasks/deploy/cni.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>inventory_hostname in groups.control</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;===================== ADD WORKER NODES  ====================&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>include_tasks</span><span class=p>:</span><span class=w> </span><span class=l>tasks/deploy/workers.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span></span></span></code></pre></div><p style=background-color:#00bfff;text-align:center><b>deployment.yml</b></p><p>We start off by installing the prerequisite packages, apt keys and repositories. We then turn off swap if any, in order for <em>kubelet</em> service to run without issues. Then, we proceed installing docker CRI, changing cgroup to <em>systemd</em> and assigning the user to docker group. We download <em>kubeadm</em>, <em>kubectl</em>, and <em>kubelet</em> packages. Next, we initialise the control node and install the network CNI plugin. Finally, we join the worker nodes to the cluster.</p><hr><h2 class=heading-element id=optimisations><span>Optimisations</span>
<a href=#optimisations class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><hr><p>If we&rsquo;ve reached this stage, it means that everything is working fine, we are happy, so the code is good and we do not need any optimisations or fine tuning &#x1f604;. Well, there is always room for improvement and fine tuning, the only enemy is time.</p><p>I am sure that a more experienced eye could spot many ways to improve the playbook and suggest better ways to do things or use tasks, but here are my observations after finishing the playbook:</p><ul><li><strong>Improving Speed</strong>: During the <em>check</em> phase, where we check for reachability, I initially used to ping the hosts and act on the result. This was adding a nearly 45 second delay in execution, so I tested with <em>wait_for</em> towards SSH connectivity and this improved script time tremendously. After all, SSH connectivity is somewhat better than ping reachability, since it is one step further &#x1f604;. What I am suggesting here is to take in mind the end goal of what you are after and figure out a way to do it more meaningful and perhaps faster. For example, if you have a task to create a file in a directory, should you first check if the directory exists? Well, it depends on the use case, but in general the task to create the file will fail if the directory does not exist in the first place and you would be able catch this.</li><li><strong>Task Consolidation</strong>: Although this playbook does the job, I think it is just automating a list of steps to achieve the result like one could perform manually on a system. Let&rsquo;s take for example the <em>apt</em> module that installs packages. The module is called several times to install packages according to the phase of the playbook, but what about if we just used a single <em>apt</em> task to install all our needed packages from all phases. It would be like having a <em>package installation</em> phase. Unless for some reason we need discrete stages and actions, I think that looking at the playbook as a holistic entity most probably will reveal tasks that can be consolidated.</li><li><strong>Task Reduction</strong>: Well, here, the main focus is about the question should I use several tasks to do something or it can be done with a single task or less. As an example, we need to check for the existence of a file. We use the <em>stat</em> module and register a variable. We then use the <em>debug</em> module to check the output for success or not. For sure, it will depend on the use case, but another way of treating this could be by just the <em>debug</em> module and using a file lookup conditional clause for this task.</li><li><strong>Best Practices</strong>: Here, I will not expand more on using ansible roles, or group_vars folder, or avoiding the declarations of variables in the inventory file &#x1f604;</li></ul><p align=right>...till next time...<em>have fun!</em></p></div><hr class=awesome-hr><h2 id=see-also>Related Content</h2><ul><li><a href=/posts/kube-my-router-pt3/ title="Kube My Router Up! - Last Part">Kube My Router Up! - Last Part</a></li><li><a href=/posts/kube-my-router-pt2/ title="Kube My Router Up! - Part Two">Kube My Router Up! - Part Two</a></li><li><a href=/posts/kube-my-router-pt1/ title="Kube My Router Up! - Part One">Kube My Router Up! - Part One</a></li><li><a href=/posts/mutable-immutable/ title="Mutable vs. Immutable">Mutable vs. Immutable</a></li><li><a href=/posts/declarative-imperative/ title="Declarative vs. Imperative">Declarative vs. Imperative</a></li></ul><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="Updated on 2022-07-06 15:36:24">Updated on 2022-07-06&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/k8s-ansible/index.md title="Read Markdown" class=link-to-markdown>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on X" data-sharer=twitter data-url=https://net4fungr.github.io/posts/k8s-ansible/ data-title="K8s Ansible" data-via=mkaliotis data-hashtags=k8s,ansible,automation><i class="fa-brands fa-x-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://net4fungr.github.io/posts/k8s-ansible/><i class="fa-brands fa-linkedin fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://net4fungr.github.io/posts/k8s-ansible/><i class="fa-brands fa-reddit fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/k8s/ class=post-tag title="Tags - K8s">K8s</a><a href=/tags/ansible/ class=post-tag title="Tags - Ansible">Ansible</a><a href=/tags/automation/ class=post-tag title="Tags - Automation">Automation</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/proxy-or-not/ class=post-nav-item rel=prev title="Proxy or Not...here I Come..."><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>Proxy or Not...here I Come...</a><a href=/posts/xr-get-xpath/ class=post-nav-item rel=next title="IOS-XR :: Get Your XPATHs, Get Your XPATHs Honey">IOS-XR :: Get Your XPATHs, Get Your XPATHs Honey<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment><script src=https://giscus.app/client.js data-repo=Net4FunGR/net4fungr.github.io data-repo-id=R_kgDOGLZFKQ data-category="Blog Comments" data-category-id=DIC_kwDOGLZFKc4Cf1aA data-mapping=title data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=en data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article><aside class=toc id=toc-auto aria-label=Contents><h2 class=toc-title>Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class="toc-content always-active" id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><div class="footer-line powered">Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.147.2"><img class=hugo-icon src=/images/hugo.min.svg alt="Hugo logo"> Hugo</a> | Theme - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.3.20"><img class=fixit-icon src=/images/fixit.min.svg alt="FixIt logo"> FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2021 - 2025</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/becos76 target=_blank rel="external nofollow noopener noreferrer">becos76</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label="View Comments"><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><a href=https://github.com/becos76/ title="Visit my GitHub" target=_blank rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true" width="56" height="56"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;top:0;--bg-progress:orange;--bg-progress-dark:grey></div><noscript><div class=noscript-warning>This website works best with JavaScript enabled.</div></noscript></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=preload href=/lib/katex/katex.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/katex/katex.min.css></noscript><link rel=stylesheet href=/lib/pace/themes/blue/pace-theme-minimal.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/twemoji/twemoji.min.js defer></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/typeit/index.umd.js defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/pace/pace.min.js async defer></script><script>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:-1},comment:{enable:!0,expired:!1,giscus:{darkTheme:"dark",lightTheme:"light",origin:"https://giscus.app"}},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/search.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:3,noResultsFound:"No results found",snippetLength:30,threshold:.3,type:"fuse",useExtendedSearch:!1},twemoji:!0,typeit:{cursorChar:"|",cursorSpeed:1e3,duration:-1,loop:!1,speed:50},version:"v0.3.20"}</script><script src=/js/theme.min.js defer></script></body></html>